<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>01.JavaScript 运行原理 | 八爪鱼小站</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="八爪鱼小站">
    <meta name="referrer" content="never">
    
    <link rel="preload" href="/assets/css/0.styles.e4025035.css" as="style"><link rel="preload" href="/assets/js/app.984fdec4.js" as="script"><link rel="preload" href="/assets/js/2.f6007b26.js" as="script"><link rel="preload" href="/assets/js/16.808ce394.js" as="script"><link rel="prefetch" href="/assets/js/10.59cdb2f4.js"><link rel="prefetch" href="/assets/js/11.4e8427de.js"><link rel="prefetch" href="/assets/js/12.7a10184b.js"><link rel="prefetch" href="/assets/js/13.083a4586.js"><link rel="prefetch" href="/assets/js/14.b100d612.js"><link rel="prefetch" href="/assets/js/15.08fdb981.js"><link rel="prefetch" href="/assets/js/17.c6489116.js"><link rel="prefetch" href="/assets/js/18.8f683b57.js"><link rel="prefetch" href="/assets/js/19.e3c29ff0.js"><link rel="prefetch" href="/assets/js/20.73eecd32.js"><link rel="prefetch" href="/assets/js/21.701951a2.js"><link rel="prefetch" href="/assets/js/22.2013c06b.js"><link rel="prefetch" href="/assets/js/23.957e09cd.js"><link rel="prefetch" href="/assets/js/24.7c713358.js"><link rel="prefetch" href="/assets/js/25.0e6a82f8.js"><link rel="prefetch" href="/assets/js/26.a05ee402.js"><link rel="prefetch" href="/assets/js/27.cf387aa5.js"><link rel="prefetch" href="/assets/js/28.10b336a1.js"><link rel="prefetch" href="/assets/js/29.f95ddc62.js"><link rel="prefetch" href="/assets/js/3.57a28cbb.js"><link rel="prefetch" href="/assets/js/30.0c819ce6.js"><link rel="prefetch" href="/assets/js/31.edb82535.js"><link rel="prefetch" href="/assets/js/32.0da353ea.js"><link rel="prefetch" href="/assets/js/33.b2156d6b.js"><link rel="prefetch" href="/assets/js/34.3b32512e.js"><link rel="prefetch" href="/assets/js/35.c588f8e0.js"><link rel="prefetch" href="/assets/js/36.b306573c.js"><link rel="prefetch" href="/assets/js/37.d0c3967d.js"><link rel="prefetch" href="/assets/js/38.81b57a9f.js"><link rel="prefetch" href="/assets/js/39.e1a6ecaf.js"><link rel="prefetch" href="/assets/js/4.0495b111.js"><link rel="prefetch" href="/assets/js/40.3d350cf1.js"><link rel="prefetch" href="/assets/js/41.11e9c39c.js"><link rel="prefetch" href="/assets/js/42.01710931.js"><link rel="prefetch" href="/assets/js/43.8474ba10.js"><link rel="prefetch" href="/assets/js/44.ede483ee.js"><link rel="prefetch" href="/assets/js/45.fe2a4bf2.js"><link rel="prefetch" href="/assets/js/46.688bd2c0.js"><link rel="prefetch" href="/assets/js/47.c405d292.js"><link rel="prefetch" href="/assets/js/48.7f5d7cad.js"><link rel="prefetch" href="/assets/js/49.22b61fb9.js"><link rel="prefetch" href="/assets/js/5.b3f55925.js"><link rel="prefetch" href="/assets/js/50.315d590f.js"><link rel="prefetch" href="/assets/js/51.304a8e2f.js"><link rel="prefetch" href="/assets/js/52.dc01aad1.js"><link rel="prefetch" href="/assets/js/53.ed974a2f.js"><link rel="prefetch" href="/assets/js/54.3f8ea4f6.js"><link rel="prefetch" href="/assets/js/55.63aef931.js"><link rel="prefetch" href="/assets/js/56.714a0542.js"><link rel="prefetch" href="/assets/js/57.071c0df4.js"><link rel="prefetch" href="/assets/js/58.725c2ccb.js"><link rel="prefetch" href="/assets/js/59.b7faeb7b.js"><link rel="prefetch" href="/assets/js/6.5385b4bb.js"><link rel="prefetch" href="/assets/js/60.8f4b2b12.js"><link rel="prefetch" href="/assets/js/61.eeb76448.js"><link rel="prefetch" href="/assets/js/7.5d579fc3.js"><link rel="prefetch" href="/assets/js/8.44873d68.js"><link rel="prefetch" href="/assets/js/9.937d4458.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4025035.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">八爪鱼小站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/blog/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/JavaScript/" class="nav-link">
  JavaScript高级语法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/node/01_base.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  node基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/02_scaffold.html" class="nav-link">
  脚手架的实现
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/03_express.html" class="nav-link">
  express核心用法
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/04_koa.html" class="nav-link">
  koa核心用法
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Python/" class="nav-link">
  Python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端架构" class="dropdown-title"><span class="title">前端架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端架构" class="mobile-dropdown-title"><span class="title">前端架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/前端架构/GithubActions.html" class="nav-link">
  Github Actions
</a></li><li class="dropdown-item"><!----> <a href="/blog/前端架构/Docker.html" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/git.html" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/regular.html" class="nav-link">
  正则
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/network.html" class="nav-link">
  网络协议
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/mobile.html" class="nav-link">
  移动端
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/optimize.html" class="nav-link">
  前端性能优化
</a></li><li class="dropdown-item"><h4>
          浏览器工作原理与实践
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/web/browser/01.html" class="nav-link">
  01.Chrome架构：仅仅打开了1个页面，为什么有4个进程？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/02.html" class="nav-link">
  02.TCP协议：如何保证页面文件能被完整送达浏览器？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/03.html" class="nav-link">
  03.HTTP 请求流程：为什么很多站点第二次打开速度会很快？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/04.html" class="nav-link">
  04.导航流程：从输入URL到页面展示，这中间发生了什么？
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="案例库" class="dropdown-title"><span class="title">案例库</span> <span class="arrow down"></span></button> <button type="button" aria-label="案例库" class="mobile-dropdown-title"><span class="title">案例库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/case/article-collects.html" class="nav-link">
  文章收集
</a></li><li class="dropdown-item"><!----> <a href="/blog/case/dry-goods.html" class="nav-link">
  前端开发干货
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档教程" class="dropdown-title"><span class="title">文档教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档教程" class="mobile-dropdown-title"><span class="title">文档教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.imooc.com/wiki/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  慕课教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  菜鸟教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/blog/tutorial/03.印记中文.html" class="nav-link">
  印记中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/blog/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/JavaScript/" class="nav-link">
  JavaScript高级语法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/node/01_base.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  node基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/02_scaffold.html" class="nav-link">
  脚手架的实现
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/03_express.html" class="nav-link">
  express核心用法
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/04_koa.html" class="nav-link">
  koa核心用法
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Python/" class="nav-link">
  Python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端架构" class="dropdown-title"><span class="title">前端架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端架构" class="mobile-dropdown-title"><span class="title">前端架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/前端架构/GithubActions.html" class="nav-link">
  Github Actions
</a></li><li class="dropdown-item"><!----> <a href="/blog/前端架构/Docker.html" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/git.html" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/regular.html" class="nav-link">
  正则
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/network.html" class="nav-link">
  网络协议
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/mobile.html" class="nav-link">
  移动端
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/optimize.html" class="nav-link">
  前端性能优化
</a></li><li class="dropdown-item"><h4>
          浏览器工作原理与实践
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/web/browser/01.html" class="nav-link">
  01.Chrome架构：仅仅打开了1个页面，为什么有4个进程？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/02.html" class="nav-link">
  02.TCP协议：如何保证页面文件能被完整送达浏览器？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/03.html" class="nav-link">
  03.HTTP 请求流程：为什么很多站点第二次打开速度会很快？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/04.html" class="nav-link">
  04.导航流程：从输入URL到页面展示，这中间发生了什么？
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="案例库" class="dropdown-title"><span class="title">案例库</span> <span class="arrow down"></span></button> <button type="button" aria-label="案例库" class="mobile-dropdown-title"><span class="title">案例库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/case/article-collects.html" class="nav-link">
  文章收集
</a></li><li class="dropdown-item"><!----> <a href="/blog/case/dry-goods.html" class="nav-link">
  前端开发干货
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档教程" class="dropdown-title"><span class="title">文档教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档教程" class="mobile-dropdown-title"><span class="title">文档教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.imooc.com/wiki/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  慕课教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  菜鸟教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/blog/tutorial/03.印记中文.html" class="nav-link">
  印记中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>01.JavaScript 运行原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/node/01_base.html#_01-javascript-运行原理" class="sidebar-link">01.JavaScript 运行原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_1-1-浏览器内核" class="sidebar-link">1.1.浏览器内核</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_1-2-javascript-引擎" class="sidebar-link">1.2. JavaScript 引擎</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_1-3-v8-引擎" class="sidebar-link">1.3.V8 引擎</a></li></ul></li><li><a href="/blog/node/01_base.html#_02-邂逅-node-js" class="sidebar-link">02.邂逅 Node.js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-1-node-js-是什么" class="sidebar-link">2.1.Node.js 是什么？</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-2-node-js-可以做什么" class="sidebar-link">2.2.Node.js 可以做什么?</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-3-node-js-的安装" class="sidebar-link">2.3.Node.js 的安装</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-4-node-js-版本管理" class="sidebar-link">2.4.Node.js 版本管理</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-5-window-中使用-nvm" class="sidebar-link">2.5.window 中使用 nvm</a></li></ul></li><li><a href="/blog/node/01_base.html#_03-node-基础知识" class="sidebar-link">03.Node 基础知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-1-node-执行代码" class="sidebar-link">2.1.Node 执行代码</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-2-node-的-repl" class="sidebar-link">2.2.Node 的 REPL</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-3-node-输入输出" class="sidebar-link">2.3.Node 输入输出</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_2-4-全局对象" class="sidebar-link">2.4.全局对象</a></li></ul></li><li><a href="/blog/node/01_base.html#_04-彻底掌握前端模块化" class="sidebar-link">04.彻底掌握前端模块化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_4-1-什么是模块化开发" class="sidebar-link">4.1. 什么是模块化开发</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_4-2-没有模块化的问题" class="sidebar-link">4.2. 没有模块化的问题</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_4-3-commonjs-规范" class="sidebar-link">4.3. CommonJS 规范</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_4-4-amd-和-cmd-规范" class="sidebar-link">4.4. AMD 和 CMD 规范</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_4-5-es-module" class="sidebar-link">4.5. ES Module</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_4-3-es-module-的原理" class="sidebar-link">4.3. ES Module 的原理</a></li></ul></li><li><a href="/blog/node/01_base.html#_05-常见的内置模块" class="sidebar-link">05.常见的内置模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_5-1-内置模块-path" class="sidebar-link">5.1. 内置模块 path</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_5-2-内置模块-fs" class="sidebar-link">5.2. 内置模块 fs</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_5-3-内置模块-events" class="sidebar-link">5.3. 内置模块 events</a></li></ul></li><li><a href="/blog/node/01_base.html#_06-npm-你不知道的细节" class="sidebar-link">06.npm 你不知道的细节</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_6-1-包管理工具" class="sidebar-link">6.1. 包管理工具</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_6-2-npm-工具解析" class="sidebar-link">6.2. npm 工具解析</a></li></ul></li><li><a href="/blog/node/01_base.html#_07-buffer-的使用" class="sidebar-link">07.Buffer 的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_7-1-认识-buffer" class="sidebar-link">7.1. 认识 Buffer</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_7-2-buffer-其他用法" class="sidebar-link">7.2. Buffer 其他用法</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_7-4-buffer-的内存分配" class="sidebar-link">7.4. Buffer 的内存分配</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_7-4-stream" class="sidebar-link">7.4. Stream</a></li></ul></li><li><a href="/blog/node/01_base.html#_08-深入事件循环" class="sidebar-link">08.深入事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_8-1-浏览器的事件循环" class="sidebar-link">8.1. 浏览器的事件循环</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_8-2-node-的事件循环" class="sidebar-link">8.2.Node 的事件循环</a></li></ul></li><li><a href="/blog/node/01_base.html#_09-http-开发-web-服务器" class="sidebar-link">09.http 开发 web 服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#一-http-模板基本使用" class="sidebar-link">一. Http 模板基本使用</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#二-web-其他补充" class="sidebar-link">二. Web 其他补充</a></li></ul></li><li><a href="/blog/node/01_base.html#_10-登录和-session-cookie" class="sidebar-link">10.登录和 session-cookie</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_10-1-邂逅-session-cookie" class="sidebar-link">10.1.邂逅 session-cookie</a></li><li class="sidebar-sub-header"><a href="/blog/node/01_base.html#_10-2-邂逅-token" class="sidebar-link">10.2.邂逅 token</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_01-javascript-运行原理"><a href="#_01-javascript-运行原理" class="header-anchor">#</a> 01.JavaScript 运行原理</h2> <h3 id="_1-1-浏览器内核"><a href="#_1-1-浏览器内核" class="header-anchor">#</a> 1.1.浏览器内核</h3> <ul><li>Gecko：早期被 Netscape 和 Mozilla Firefox 浏览器浏览器使用；</li> <li>Trident：微软开发，被 IE4~IE11 浏览器使用，但是 Edge 浏览器已经转向 Blink；</li> <li>Webkit：苹果基于 KHTML 开发、开源的，用于 Safari，Google Chrome 之前也在使用；</li> <li>Blink：是 Webkit 的一个分支，Google 开发，目前应用于 Google Chrome、Edge、Opera 等；</li> <li>等等...</li></ul> <p>事实上，我们经常说的浏览器内核指的是浏览器的排版引擎：</p> <ul><li><strong>排版引擎</strong>（layout engine），也称为<strong>浏览器引擎</strong>（browser engine）、<strong>页面渲染引擎</strong>（rendering engine）或<strong>样版引擎</strong>。</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/aa.png" alt="图片">WebKit main flow</p> <p>但是在这个执行过程中，HTML 解析的时候遇到了 JavaScript 标签，应该怎么办呢？</p> <ul><li>会停止解析 HTML，而去加载和执行 JavaScript 代码；</li></ul> <p>当然，为什么不直接异步去加载执行 JavaScript 代码，而要在这里停止掉呢？</p> <ul><li>这是因为 JavaScript 代码可以操作我们的 DOM；</li> <li>所以浏览器希望将 HTML 解析的 DOM 和 JavaScript 操作之后的 DOM 放到一起来生成最终的 DOM 树，而不是频繁的去生成新的 DOM 树；</li></ul> <p>那么，JavaScript 代码由谁来执行呢？</p> <ul><li>JavaScript 引擎</li></ul> <h3 id="_1-2-javascript-引擎"><a href="#_1-2-javascript-引擎" class="header-anchor">#</a> 1.2. JavaScript 引擎</h3> <p>为什么需要 JavaScript 引擎呢？</p> <ul><li>事实上我们编写的 JavaScript 无论你交给浏览器或者 Node 执行，最后都是需要被 CPU 执行的；</li> <li>但是 CPU 只认识自己的指令集，实际上是机器语言，才能被 CPU 所执行；</li> <li>所以我们需要 JavaScript 引擎帮助我们将 JavaScript 代码翻译成 CPU 指令来执行；</li></ul> <p>比较常见的 JavaScript 引擎有哪些呢？</p> <ul><li><strong>SpiderMonkey</strong>：第一款 JavaScript 引擎，由 Brendan Eich 开发（也就是 JavaScript 作者）；</li> <li><strong>Chakra</strong>：微软开发，用于 IT 浏览器；</li> <li><strong>JavaScriptCore</strong>：WebKit 中的 JavaScript 引擎，Apple 公司开发；</li> <li><strong>V8</strong>：Google 开发的强大 JavaScript 引擎，也帮助 Chrome 从众多浏览器中脱颖而出；</li></ul> <p>这里我们先以 WebKit 为例，WebKit 事实上由两部分组成的：</p> <ul><li>WebCore：负责 HTML 解析、布局、渲染等等相关的工作；</li> <li>JavaScriptCore：解析、执行 JavaScript 代码；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a1.png" alt="图片">webkit 内核</p> <p>看到这里，学过小程序的同学有没有感觉非常的熟悉呢？</p> <ul><li>在小程序中编写的 JavaScript 代码就是被 JSCore 执行的；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a2.png" alt="图片"></p> <p>另外一个强大的 JavaScript 引擎就是 V8 引擎。</p> <h3 id="_1-3-v8-引擎"><a href="#_1-3-v8-引擎" class="header-anchor">#</a> 1.3.V8 引擎</h3> <p>我们来看一下官方对 V8 引擎的定义：</p> <ul><li>V8 是用 C ++编写的 Google 开源高性能 JavaScript 和 WebAssembly 引擎，它用于 Chrome 和 Node.js 等。</li> <li>它实现 ECMAScript 和 WebAssembly，并在 Windows 7 或更高版本，macOS 10.12+和使用 x64，IA-32，ARM 或 MIPS 处理器的 Linux 系统上运行。</li> <li>V8 可以独立运行，也可以嵌入到任何 C ++应用程序中。</li></ul> <p>V8 引擎本身的源码非常复杂，大概有超过 100w 行 C++代码，但是我们可以简单了解一下它执行 JavaScript 代码的原理：</p> <ul><li><p>Parse 模块会将 JavaScript 代码转换成 AST（抽象语法树），这是因为解释器并不直接认识 JavaScript 代码；</p></li> <li><ul><li>如果函数没有被调用，那么是不会被转换成 AST 的；</li> <li>Parse 的 V8 官方文档：https://v8.dev/blog/scanner</li></ul></li> <li><p>Ignition 是一个解释器，会将 AST 转换成 ByteCode（字节码）</p></li> <li><ul><li>同时会收集 TurboFan 优化所需要的信息（比如函数参数的类型信息，有了类型才能进行真实的运算）；</li> <li>如果函数只调用一次，Ignition 会执行解释执行 ByteCode；</li> <li>Ignition 的 V8 官方文档：https://v8.dev/blog/ignition-interpreter</li></ul></li> <li><p>TurboFan 是一个编译器，可以将字节码编译为 CPU 可以直接执行的机器码；</p></li> <li><ul><li>如果一个函数被多次调用，那么就会被标记为热点函数，那么就会经过 TurboFan 转换成优化的机器码，提高代码的执行性能；</li> <li>但是，机器码实际上也会被还原为 ByteCode，这是因为如果后续执行函数的过程中，类型发生了变化（比如 sum 函数原来执行的是 number 类型，后来执行变成了 string 类型），之前优化的机器码并不能正确的处理运算，就会逆向的转换成字节码；</li> <li>TurboFan 的 V8 官方文档：https://v8.dev/blog/turbofan-jit</li></ul></li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a3.png" alt="图片"></p> <p>上面是 JavaScript 代码的执行过程，事实上 V8 的内存回收也是其强大的另外一个原因，这里暂时先不展开讨论：</p> <ul><li>Orinoco 模块，负责垃圾回收，将程序中不需要的内存回收；</li> <li>Orinoco 的 V8 官方文档：https://v8.dev/blog/trash-talk</li></ul> <h2 id="_02-邂逅-node-js"><a href="#_02-邂逅-node-js" class="header-anchor">#</a> 02.邂逅 Node.js</h2> <h3 id="_2-1-node-js-是什么"><a href="#_2-1-node-js-是什么" class="header-anchor">#</a> 2.1.Node.js 是什么？</h3> <p>官方对 Node.js 的定义：</p> <ul><li>Node.js 是一个基于 V8 JavaScript 引擎的 JavaScript 运行时环境。</li></ul> <p>也就是说 Node.js 基于 V8 引擎来执行 JavaScript 的代码，但是不仅仅只有 V8 引擎：</p> <ul><li>前面我们知道 Node.js 可以嵌入到任何 C ++应用程序中，无论是 Chrome 还是 Node.js，事实上都是嵌入了 V8 引擎来执行 JavaScript 代码；</li> <li>但是在 Chrome 浏览器中，还需要解析、渲染 HTML、CSS 等相关渲染引擎，另外还需要提供支持浏览器操作的 API、浏览器自己的事件循环等；</li> <li>另外，在 Node.js 中我们也需要进行一些额外的操作，比如文件系统读/写、网络 IO、加密、压缩解压文件等操作；</li></ul> <p>所以，我们可以简单理解规划出 Node.js 和浏览器的差异：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a4.png" alt="图片">Chrome 浏览器和 Node 架构区别</p> <p>这里也有一份单独的 Node.js 的架构图：</p> <ul><li>我们编写的 JavaScript 代码会经过 V8 引擎，再通过 Node.js 的 Bindings，将任务放到 Libuv 的事件循环中；</li> <li><strong>libuv</strong>（Unicorn Velociraptor—独角伶盗龙）是使用 C 语言编写的库；</li> <li>libuv 提供了事件循环、文件系统读写、网络 IO、线程池等等内容；</li> <li>具体内部代码的执行流程，我会在后续专门讲解事件和异步 IO 的原理中详细讲解；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a5.png" alt="图片">What is Node.js? Where, when and how to use it with examples</p> <h3 id="_2-2-node-js-可以做什么"><a href="#_2-2-node-js-可以做什么" class="header-anchor">#</a> 2.2.Node.js 可以做什么?</h3> <p>了解了 Node.js 的架构，那么使用它我们可以做什么呢？</p> <ul><li>前面我们提到，Node.js 的出现，真正让 Atwood 定律变成了现实，Node.js 的应用场景也越来越多。</li></ul> <p>我们可以使用基于 Node.js 的 Electron 开发出类似于 VSCode 这种强大的桌面应用程序。另外前端自动化、模块化打包工具 gulp、webpack 也是基于 Node.js 开发和使用的。</p> <p>Node.js 的快速发展也让企业对 Node.js 技术越来越重视，在前端招聘中通常会对 Node.js 有一定的要求，特别对于高级前端开发工程师，Node.js 更是必不可少的技能：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a6.png" alt="图片">前端工程师岗位需求</p> <p>目前前端开发的库都是以 node 包的形式进行管理；</p> <ul><li>npm、yarn 工具成为前端开发使用最多的工具；</li> <li>越来越多的公司使用 Node.js 作为 web 服务器开发；</li> <li>大量项目需要借助 Node.js 完成前后端渲染的同构应用；</li> <li>资深前端工程师需要为项目编写脚本工具（前端工程师编写脚本通常会使用 JavaScript，而不是 Python 或者 shell）；</li> <li>很多企业在使用 Electron 来开发桌面应用程序；</li></ul> <p>总结一下，目前 Node.js 到底有哪些应用场景呢？</p> <ul><li><p>前后端页面渲染</p></li> <li><ul><li>支持项目同构开发</li> <li>对于需要进行首屏优化、SEO 的页面进行后端渲染</li></ul></li> <li><p>开发命令行工具</p></li> <li><ul><li>webpack、gulp 等都是基于 Node</li> <li>开发自己独立的命令行工具（类似于 shell、Python 做的事情，对于前端更加友好）</li></ul></li> <li><p>桌面应用的开发</p></li> <li><ul><li>类似于 VSCode 这种强大的桌面应用</li> <li>甚至开发桌面端类似于 wayward 大型游戏</li></ul></li> <li><p>进行服务器开发</p></li> <li><ul><li>拥有类似 express、koa 等强大的 web 框架</li> <li>开发 Web Socket 等服务器</li></ul></li></ul> <p>所以，作为前端开发工程师，Node.js 已经是我们必须掌握的核心技术。</p> <h3 id="_2-3-node-js-的安装"><a href="#_2-3-node-js-的安装" class="header-anchor">#</a> 2.3.Node.js 的安装</h3> <p>Node.js 是在 2009 年诞生的，目前最新的版本是分别是 12.18.4 以及 14.12.0：</p> <ul><li>LTS 版本：相对稳定一些，推荐线上环境使用该版本；</li> <li>Current 版本：最新的 Node 版本，包含很多新特性；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a7.png" alt="图片">node 的版本</p> <p>这些我们选择什么版本呢？</p> <ul><li>如果你是学习使用，可以选择 current 版本；</li> <li>如果你是公司开发，建议选择 LTS 版本；</li></ul> <p>Node 的安装方式有很多：</p> <ul><li>可以借助于一些操作系统上的软件管理工具，比如 Mac 上的 homebrew，Linux 上的 yum、dnf 等；</li> <li>也可以直接下载对应的安装包下载安装；</li></ul> <p>我们选择下载安装，下载自己操作系统的安装包直接安装就可以了：</p> <ul><li>window 选择.msi 安装包，Mac 选择.pkg 安装包，Linux 会在后续部署中讲解；</li> <li>安装过程中会配置环境变量；</li> <li>并且安装 node 过程中会安装 npm（<em>Node Package Manager</em>）工具；</li></ul> <h3 id="_2-4-node-js-版本管理"><a href="#_2-4-node-js-版本管理" class="header-anchor">#</a> 2.4.Node.js 版本管理</h3> <p>在实际开发学习中，我们只需要使用一个 Node 版本来开发或者学习即可。但是，如果你希望通过可以快速更新或切换多个版本时，可以借助于一些工具：</p> <ul><li>nvm：Node Version Manager</li> <li>n：Interactively Manage Your Node.js Versions（交互式管理你的 Node.js 版本）</li></ul> <p>这里我演示管理工具：n</p> <ul><li>n 是 TJ 方便 node 的版本管理，专门开发的；</li> <li>官方介绍是：n - Interactively Manage Your Node.js Versions（交互式管理你的 Node.js 版本）</li></ul> <p>安装 n：直接使用 npm 安装即可</p> <div class="language-js extra-class"><pre class="language-js"><code># 安装工具n
npm install <span class="token operator">-</span>g n
# 查看安装的版本
n <span class="token operator">--</span>version
</code></pre></div><p>安装最新的 lts 版本：</p> <ul><li>前面添加的 sudo 是权限问题；</li> <li>可以两个版本都安装，之后我们可以通过 n 快速在两个版本间切换；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code># 安装最新的lts版本
n lts

# 安装最新的版本
n latest
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/a8.png" alt="图片">安装 lts 版本</p> <p>查看所有的版本，并且选择要使用的版本：</p> <ul><li>可以上下选择想使用的版本</li></ul> <div class="language-js extra-class"><pre class="language-js"><code># 查看所有的版本
n
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b1.png" alt="图片">查看和选择所有的版本</p> <p>查看当前 Node 的版本：</p> <p>问题：这两个工具都不支持 window</p> <ul><li>n：n is not supported natively on Windows.</li> <li>nvm：nvm does not support Windows</li></ul> <h3 id="_2-5-window-中使用-nvm"><a href="#_2-5-window-中使用-nvm" class="header-anchor">#</a> 2.5.window 中使用 nvm</h3> <p><strong>1.安装</strong></p> <ol><li>安装 num-windows 安装包https://github.com/coreybutler/nvm-windows/releases</li></ol> <p><strong>2.使用</strong></p> <ol><li>查看当前安装过的 node 版本：<code>nvm list</code></li> <li>查看可用的 node 版本：<code>nvm list avilable</code></li> <li>安装指定版本：<code>nvm install 版本号</code></li> <li>安装最新版：<code>nvm install latest</code></li> <li>安装最新的 lts 版本：<code>nvm install lts</code></li> <li>使用指定版本：<code>nvm use 版本号</code></li> <li>卸载指定版本：<code>nvm uninstall 版本号</code></li></ol> <p><strong>3.设置淘宝镜像</strong></p> <ol><li><code>nvm node_mirror https://npm.taobao.org/mirror/node/</code></li> <li><code>nvm npm_mirror https://npm.taobao.org/mirror/npm/</code></li></ol> <h2 id="_03-node-基础知识"><a href="#_03-node-基础知识" class="header-anchor">#</a> 03.Node 基础知识</h2> <h3 id="_2-1-node-执行代码"><a href="#_2-1-node-执行代码" class="header-anchor">#</a> 2.1.Node 执行代码</h3> <p>如果我们编写一个 js 文件，里面存放 JavaScript 代码，如何来执行它呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.直接打印一段文字</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;我是一段JavaScript代码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2.定义一个函数, 调用这个函数</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;计算结果:&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3.执行定时器代码</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2s后执行的代码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>目前我们知道有两种方式可以执行：</p> <ul><li>将代码交给浏览器执行；</li> <li>将代码载入到 node 环境中执行；</li></ul> <p><strong>演练一：浏览器执行</strong></p> <p>如果我们希望把代码交给浏览器执行：</p> <ul><li>需要通过让浏览器加载、解析 html 代码，所以我们需要创建一个 html 文件；</li> <li>在 html 中通过 script 标签，引入 js 文件；</li> <li>当浏览器遇到 script 标签时，就会根据 src 加载、执行 JavaScript 代码；</li></ul> <p>index.html 文件：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b2.png" alt="图片">浏览器执行结果</p> <p><strong>演练二：Node 执行</strong></p> <p>如果我们希望把 js 文件交给 node 执行：</p> <ul><li>首先电脑上需要安装 Node.js 环境，安装过程中会自动配置环境变量；</li> <li>可以通过终端命令<code>node js文件</code>的方式来载入和执行对应的 js 文件；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node index<span class="token punctuation">.</span>js
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b3.png" alt="图片"></p> <p>Node 执行结果</p> <h3 id="_2-2-node-的-repl"><a href="#_2-2-node-的-repl" class="header-anchor">#</a> 2.2.Node 的 REPL</h3> <p>什么是 REPL 呢？感觉挺高大上</p> <ul><li><strong>REPL</strong>是<strong>Read-Eval-Print Loop</strong>的简称，翻译为**“读取-求值-输出”循环**；</li> <li>REPL 是一个简单的，交互式的编程环境；</li></ul> <p>事实上，我们浏览器的 console 就可以看成一个 REPL：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b4.png" alt="图片">浏览器控制台</p> <p>Node 也给我们提供了一个 REPL 环境，我们可以在其中演练简单的代码：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b5.png" alt="图片">REPL 演练</p> <h3 id="_2-3-node-输入输出"><a href="#_2-3-node-输入输出" class="header-anchor">#</a> 2.3.Node 输入输出</h3> <h4 id="_2-3-1-给-node-程序传递参数"><a href="#_2-3-1-给-node-程序传递参数" class="header-anchor">#</a> 2.3.1.给 node 程序传递参数</h4> <p>正常情况下执行一个 node 程序，直接跟上我们对应的文件即可：</p> <div class="language-js extra-class"><pre class="language-js"><code>node index<span class="token punctuation">.</span>js
</code></pre></div><p>但是，在某些情况下执行 node 程序的过程中，我们可能希望给 node 传递一些参数：</p> <div class="language-js extra-class"><pre class="language-js"><code>node index<span class="token punctuation">.</span>js env<span class="token operator">=</span>development coderwhy
</code></pre></div><p>如果我们这样来使用程序，就意味着我们需要在程序中获取到传递的参数：</p> <ul><li>获取参数其实是在<code>process</code>的内置对象中的；</li></ul> <p>如果我们直接打印这个内置对象，它里面包含特别的信息：</p> <ul><li>其他的一些信息，比如版本、操作系统等大家可以自行查看，后面用到一些其他的我们还会提到；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b6.png" alt="图片">process 对象</p> <p>现在，我们先找到其中的 argv 属性：</p> <ul><li>我们发现它是一个数组，里面包含了我们需要的参数；</li> <li>你可能有个疑问，为什么叫 argv 呢？</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b7.png" alt="图片">argv 属性</p> <p>在 C/C++程序中的 main 函数中，实际上可以获取到两个参数：</p> <ul><li><p>argc：argument counter 的缩写，传递参数的个数；</p></li> <li><p>argv：argument vector 的缩写，传入的具体参数。</p></li> <li><ul><li>vector 翻译过来是矢量的意思，在程序中表示的是一种数据结构。</li> <li>在 C++、Java 中都有这种数据结构，是一种数组结构；</li> <li>在 JavaScript 中也是一个数组，里面存储一些参数信息；</li></ul></li></ul> <p>我们可以在代码中，将这些参数信息遍历出来，使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取参数</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 结果如下：</span>
<span class="token comment">// /usr/local/bin/node</span>
<span class="token comment">// /Users/coderwhy/Desktop/Node/TestCode/04_learn_node/02_给Node传递参数/index.js</span>
<span class="token comment">// ENV=dev</span>
<span class="token comment">// coderwhy</span>
</code></pre></div><h4 id="_2-3-2-node-程序输出内容"><a href="#_2-3-2-node-程序输出内容" class="header-anchor">#</a> 2.3.2.node 程序输出内容</h4> <p><strong>console.log</strong></p> <p>最常用的输入内容的方式：console.log</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello coderwhy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>console.clear</strong></p> <p>清空控制台：console.clear</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span>clear<span class="token punctuation">;</span>
</code></pre></div><p><strong>console.trace</strong></p> <p>打印函数的调用栈：console.trace</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/b8.png" alt="图片">console.trace 结果</p> <p>还有一些其他的方法，其他的一些 console 方法，可以自己在下面学习研究一下。</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c1.png" alt="图片"></p> <h3 id="_2-4-全局对象"><a href="#_2-4-全局对象" class="header-anchor">#</a> 2.4.全局对象</h3> <h4 id="_2-4-1-常见全局对象"><a href="#_2-4-1-常见全局对象" class="header-anchor">#</a> 2.4.1.常见全局对象</h4> <p>Node 中给我们提供了一些全局对象，方便我们进行一些操作：</p> <ul><li>这些全局对象，我们并不需要从一开始全部一个个学习；</li> <li>某些全局对象并不常用，某些全局对象我们会在后续学习中讲到；</li> <li>比如 module、exports、require()会在模块化中讲到；</li> <li>比如 Buffer 后续会专门讲到；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c2.png" alt="图片"></p> <p><strong>process 对象</strong></p> <p>process 提供了 Node 进程中相关的信息：</p> <ul><li>比如 Node 的运行环境、参数信息等；</li> <li>后面在项目中，我也会讲解，如何将一些环境变量读取到 <code>process</code> 的 <code>env</code> 中；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>console 对象</strong></p> <p>提供了简单的调试控制台，在前面讲解输入内容时已经学习过了。</p> <ul><li>更加详细的查看官网文档：https://nodejs.org/api/console.html</li></ul> <p><strong>定时器函数</strong></p> <p>在 Node 中使用定时器有好几种方式：</p> <ul><li><p><code>setTimeout(callback, delay[, ...args])</code>：<code>callback</code>在<code>delay</code>毫秒后执行一次；</p></li> <li><p><code>setInterval(callback, delay[, ...args])</code>：<code>callback</code>每<code>delay</code>毫秒重复执行一次；</p></li> <li><p><code>setImmediate(callback[, ...args])</code>：<code>callback</code>I / O 事件后的回调的“立即”执行；</p></li> <li><ul><li>这里先不展开讨论它和<code>setTimeout(callback, 0)</code>之间的区别；</li> <li>因为它涉及到事件循环的阶段问题，我会在后续详细讲解事件循环相关的知识；</li></ul></li> <li><p><code>process.nextTick(callback[, ...args])</code>：添加到下一次 tick 队列中；</p></li> <li><ul><li>具体的讲解，也放到事件循环中说明；</li></ul></li></ul> <p>代码演练：</p> <ul><li>暂时不用关心执行顺序问题，在后续事件循环中我会讲到；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimtout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setInterval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;process.nextTick&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当然，它们有对应的取消定时器的方法：</p> <ul><li>clearTimeout(timeoutObject);</li> <li>clearInterval(intervalObject);</li> <li>clearImmediate(immediateObject)</li></ul> <p><strong>global 对象</strong></p> <p>global 是一个全局对象，事实上前端我们提到的 process、console、setTimeout 等都有被放到 global 中：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>为什么结果是一样的呢？</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c3.png" alt="图片">Node 的源码</p> <p>global 中还有哪些属性呢？</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c4.png" alt="图片">global 其他属性的查看</p> <p><strong>window 和 global 的区别是什么？</strong></p> <p>在浏览器中，全局变量都是在 window 上的，比如有 document、setInterval、setTimeout、alert、console 等等</p> <p>在 Node 中，我们也有一个 global 属性，并且看起来它里面有很多其他对象。</p> <p>但是在浏览器中执行的 JavaScript 代码，如果我们在顶级范围内通过 var 定义的一个属性，默认会被添加到 window 对象上：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// coderwhy</span>
</code></pre></div><p>但是在 node 中，我们通过 var 定义一个变量，它只是在当前模块中有一个变量，不会放到全局中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
</code></pre></div><h4 id="_2-4-2-特殊的全局对象"><a href="#_2-4-2-特殊的全局对象" class="header-anchor">#</a> 2.4.2.特殊的全局对象</h4> <p>为什么我称之为特殊的全局对象呢？</p> <ul><li>这些全局对象可以在模块中任意使用，但是在命令行交互中是不可以使用的；</li> <li>包括：**dirname、**filename、exports、module、require()</li></ul> <p><strong>__dirname</strong></p> <p>获取当前文件所在的路径：</p> <ul><li>注意：不包括后面的文件名</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// /Users/coderwhy/Desktop/Node/TestCode/04_learn_node/03_常见的全局变量</span>
</code></pre></div><p><strong>__filename</strong></p> <p>获取当前文件所在的路径和文件名称：</p> <ul><li>注意：包括后面的文件名称</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// /Users/coderwhy/Desktop/Node/TestCode/04_learn_node/03_常见的全局变量/global对象.js</span>
</code></pre></div><h2 id="_04-彻底掌握前端模块化"><a href="#_04-彻底掌握前端模块化" class="header-anchor">#</a> 04.彻底掌握前端模块化</h2> <h3 id="_4-1-什么是模块化开发"><a href="#_4-1-什么是模块化开发" class="header-anchor">#</a> 4.1. 什么是模块化开发</h3> <h4 id="_4-1-1-javascript-设计缺陷"><a href="#_4-1-1-javascript-设计缺陷" class="header-anchor">#</a> 4.1.1 JavaScript 设计缺陷</h4> <p>那么，到底什么是模块化开发呢？</p> <ul><li>事实上模块化开发最终的目的是将程序划分成一个个小的结构；</li> <li>这个结构中编写属于自己的逻辑代码，有自己的作用域，不会影响到其他的结构；</li> <li>这个结构可以将自己希望暴露的变量、函数、对象等导出给其结构使用；</li> <li>也可以通过某种方式，导入另外结构中的变量、函数、对象等；</li></ul> <p><strong>上面说提到的结构，就是模块；</strong></p> <p><strong>按照这种结构划分开发程序的过程，就是模块化开发的过程；</strong></p> <p>无论你多么喜欢 JavaScript，以及它现在发展的有多好，我们都需要承认在<em>Brendan Eich</em>用了 10 天写出 JavaScript 的时候，它都有很多的缺陷：</p> <ul><li>比如 var 定义的变量作用域问题；</li> <li>比如 JavaScript 的面向对象并不能像常规面向对象语言一样使用 class；</li> <li>比如 JavaScript 没有模块化的问题；</li></ul> <p><em>Brendan Eich</em>本人也多次承认过 JavaScript 设计之初的缺陷，但是随着 JavaScript 的发展以及标准化，存在的缺陷问题基本都得到了完善。</p> <ul><li>JavaScript 目前已经得到了快速的发展，无论是 web、移动端、小程序端、服务器端、桌面应用都被广泛的使用；</li></ul> <p>在网页开发的早期，<em>Brendan Eich</em>开发 JavaScript 仅仅作为一种脚本语言，做一些简单的表单验证或动画实现等，那个时候代码还是很少的：</p> <ul><li>这个时候我们只需要讲 JavaScript 代码写到 script 标签中即可；</li> <li>并没有必要放到多个文件中来编写；</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;按钮被点击了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>但是随着前端和 JavaScript 的快速发展，JavaScript 代码变得越来越复杂了：</p> <ul><li>ajax 的出现，前后端开发分离，意味着后端返回数据后，我们需要通过 JavaScript 进行前端页面的渲染；</li> <li>SPA 的出现，前端页面变得更加复杂：包括前端路由、状态管理等等一系列复杂的需求需要通过 JavaScript 来实现；</li> <li>包括 Node 的实现，JavaScript 编写复杂的后端程序，没有模块化是致命的硬伤；</li></ul> <p>所以，模块化已经是 JavaScript 一个非常迫切的需求：</p> <ul><li>但是 JavaScript 本身，直到 ES6（2015）才推出了自己的模块化方案；</li> <li>在此之前，为了让 JavaScript 支持模块化，涌现出了很多不同的模块化规范：AMD、CMD、CommonJS 等；</li></ul> <p>在这个章节，我们将详细学习 JavaScript 的模块化，尤其是 CommonJS 和 ES6 的模块化。</p> <h3 id="_4-2-没有模块化的问题"><a href="#_4-2-没有模块化的问题" class="header-anchor">#</a> 4.2. 没有模块化的问题</h3> <p>我们先来简单体会一下没有模块化代码的问题。</p> <p>我们知道，对于一个大型的前端项目，通常是多人开发的（即使一个人开发，也会将代码划分到多个文件夹中）：</p> <ul><li>我们假设有两个人：小明和小丽同时在开发一个项目，并且会将自己的 JavaScript 代码放在一个单独的 js 文件中。</li></ul> <p>小明开发了 aaa.js 文件，代码如下（当然真实代码会复杂的多）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;aaa的flag为true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>小丽开发了 bbb.js 文件，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bbb使用了flag为false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很明显出现了一个问题：</p> <ul><li>大家都喜欢使用 flag 来存储一个 boolean 类型的值；</li> <li>但是一个人赋值了 true，一个人赋值了 false；</li> <li>如果之后都不再使用，那么也没有关系；</li></ul> <p>但是，小明又开发了 ccc.js 文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;使用了aaa的flag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>问题来了：小明发现 ccc 中的 flag 值不对</p> <ul><li>对于聪明的你，当然一眼就看出来，是小丽将 flag 赋值为了 false；</li> <li>但是如果每个文件都有上千甚至更多的代码，而且有上百个文件，你可以一眼看出来 flag 在哪个地方被修改了吗？</li></ul> <p>备注：引用路径如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./aaa.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./bbb.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./ccc.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>所以，没有模块化对于一个大型项目来说是灾难性的。</p> <p><strong>当然，我们有办法可以解决上面的问题：立即函数调用表达式（IIFE）</strong></p> <ul><li><strong>IIFE</strong> (Immediately Invoked Function Expression)</li></ul> <p>aaa.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> moduleA <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;aaa的flag为true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">flag</span><span class="token operator">:</span> flag<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>bbb.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> moduleB <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bbb使用了flag为false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ccc.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> moduleC <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flag <span class="token operator">=</span> moduleA<span class="token punctuation">.</span>flag<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;使用了aaa的flag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>命名冲突的问题，有没有解决呢？解决了。</p> <p>但是，我们其实带来了新的问题：</p> <ul><li>第一，我必须记得每一个模块中返回对象的命名，才能在其他模块使用过程中正确的使用；</li> <li>第二，代码写起来混乱不堪，每个文件中的代码都需要包裹在一个匿名函数中来编写；</li> <li>第三，在没有合适的规范情况下，每个人、每个公司都可能会任意命名、甚至出现模块名称相同的情况；</li></ul> <p><strong>所以，我们会发现，虽然实现了模块化，但是我们的实现过于简单，并且是没有规范的。</strong></p> <ul><li>我们需要制定一定的规范来约束每个人都按照这个规范去编写模块化的代码；</li> <li>这个规范中应该包括核心功能：模块本身可以导出暴露的属性，模块又可以导入自己需要的属性；</li></ul> <p>JavaScript 社区为了解决上面的问题，涌现出一系列好用的规范，接下来我们就学习具有代表性的一些规范。</p> <h3 id="_4-3-commonjs-规范"><a href="#_4-3-commonjs-规范" class="header-anchor">#</a> 4.3. CommonJS 规范</h3> <h4 id="_4-3-1-commonjs-和-node"><a href="#_4-3-1-commonjs-和-node" class="header-anchor">#</a> 4.3.1. CommonJS 和 Node</h4> <p>我们需要知道 CommonJS 是一个规范，最初提出来是在浏览器意外的地方使用，并且当时被命名为<strong>ServerJS</strong>，后来为了体现它的广泛性，修改为<strong>CommonJS</strong>，平时我们也会简称为 CJS。</p> <ul><li>Node 是 CommonJS 在服务器端一个具有代表性的实现；</li> <li>Browserify 是 CommonJS 在浏览器中的一种实现；</li> <li>webpack 打包工具具备对 CommonJS 的支持和转换（后面我会讲到）；</li></ul> <p>所以，Node 中对 CommonJS 进行了支持和实现，让我们在开发 node 的过程中可以方便的进行模块化开发：</p> <ul><li>在 Node 中每一个 js 文件都是一个单独的模块；</li> <li>这个模块中包括 CommonJS 规范的核心变量：exports、module.exports、require；</li> <li>我们可以使用这些变量来方便的进行模块化开发；</li></ul> <p>前面我们提到过模块化的核心是导出和导入，Node 中对其进行了实现：</p> <ul><li>exports 和 module.exports 可以负责对模块中的内容进行导出；</li> <li>require 函数可以帮助我们导入其他模块（自定义模块、系统模块、第三方库模块）中的内容；</li></ul> <h4 id="_4-3-2-node-模块化开发"><a href="#_4-3-2-node-模块化开发" class="header-anchor">#</a> 4.3.2. Node 模块化开发</h4> <p>我们来看一下两个文件：</p> <p>bar.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>main.js</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;kobe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码会报错：</p> <ul><li>在 node 中每一个文件都是一个独立的模块，有自己的作用域；</li> <li>那么，就意味着别的模块 main 中不能随便访问另外一个模块 bar 中的内容；</li> <li>bar 需要导出自己想要暴露的变量、函数、对象等等；</li> <li>main 从 bar 中导入自己想要使用的变量、函数、对象等等；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c5.png" alt="图片">导出和导入</p> <h5 id="_1-exports-导出"><a href="#_1-exports-导出" class="header-anchor">#</a> 1. exports 导出</h5> <p><strong>强调：exports 是一个对象，我们可以在这个对象中添加很多个属性，添加的属性会导出</strong></p> <p>bar.js 中导出内容：</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>sayHello <span class="token operator">=</span> sayHello<span class="token punctuation">;</span>
</code></pre></div><p>main.js 中导入内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面这行代码意味着什么呢？</p> <ul><li>意味着 main 中的 bar 变量等于 exports 对象；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>main中的bar <span class="token operator">=</span> bar中的exports<span class="token punctuation">;</span>
</code></pre></div><p>所以，我可以编写下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> bar<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token keyword">const</span> age <span class="token operator">=</span> bar<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token keyword">const</span> sayHello <span class="token operator">=</span> bar<span class="token punctuation">.</span>sayHello<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;kobe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c7.png" alt="图片">模块之间的引用关系</p> <p>为了进一步论证，bar 和 exports 是同一个对象：</p> <ul><li>所以，bar 对象是 exports 对象的浅拷贝；</li> <li>浅拷贝的本质就是一种引用的赋值而已；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c8.png" alt="图片">定时器修改对象</p> <h5 id="_2-module-exports"><a href="#_2-module-exports" class="header-anchor">#</a> 2.module.exports</h5> <p>但是 Node 中我们经常导出东西的时候，又是通过 module.exports 导出的：</p> <ul><li>module.exports 和 exports 有什么关系或者区别呢？</li></ul> <p>我们追根溯源，通过维基百科中对 CommonJS 规范的解析：</p> <ul><li>CommonJS 中是没有 module.exports 的概念的；</li> <li>但是为了实现模块的导出，Node 中使用的是 Module 的类，每一个模块都是 Module 的一个实例，也就是 module；</li> <li>所以在 Node 中真正用于导出的其实根本不是 exports，而是 module.exports；</li> <li>因为 module 才是导出的真正实现者；</li></ul> <p>但是，为什么 exports 也可以导出呢？</p> <ul><li>这是因为 module 对象的 exports 属性是 exports 对象的一个引用；</li> <li>也就是说 <code>module.exports = exports = main中的bar</code>；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/c9.png" alt="图片">image-20201011163653515</p> <p>注意：真正导出的模块内容的核心其实是 module.exports，只是为了实现 CommonJS 的规范，刚好 module.exports 对 exports 对象有一个引用而已；</p> <p>那么，如果我的代码这样修改了：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d1.png" alt="图片">image-20201011164006266</p> <p>你能猜到内存中会有怎么样的表现吗？</p> <ul><li>结论：和 exports 对象没有任何关系了，exports 你随便玩自己的吧；</li> <li>module.exports 我现在导出一个自己的对象，不带着你玩了；</li> <li>新的对象取代了 exports 对象的导出，那么就意味着 require 导入的对象是新的对象；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d2.png" alt="图片">image-20201011164223607</p> <h5 id="_3-require-细节"><a href="#_3-require-细节" class="header-anchor">#</a> 3. require 细节</h5> <p>我们现在已经知道，require 是一个函数，可以帮助我们引入一个文件（模块）中导入的对象。</p> <p>那么，require 的查找规则是怎么样的呢？</p> <ul><li>https://nodejs.org/dist/latest-v14.x/docs/api/modules.html#modules_all_together</li></ul> <p><strong>这里我总结比较常见的查找规则：</strong></p> <p>导入格式如下：require(X)</p> <ul><li><p>情况一：X 是一个核心模块，比如 path、http</p></li> <li><ul><li>直接返回核心模块，并且停止查找</li></ul></li> <li><p>情况二：X 是以 <code>./</code> 或 <code>../</code> 或 <code>/</code>（根目录）开头的</p></li> <li><ul><li>查找目录下面的 index 文件</li> <li>1&gt; 查找 X/index.js 文件</li> <li>2&gt; 查找 X/index.json 文件</li> <li>3&gt; 查找 X/index.node 文件</li> <li>1.如果有后缀名，按照后缀名的格式查找对应的文件</li> <li>2.如果没有后缀名，会按照如下顺序：</li> <li>1&gt; 直接查找文件 X</li> <li>2&gt; 查找 X.js 文件</li> <li>3&gt; 查找 X.json 文件</li> <li>4&gt; 查找 X.node 文件</li> <li>第一步：将 X 当做一个文件在对应的目录下查找；</li> <li>第二步：没有找到对应的文件，将 X 作为一个目录</li> <li>如果没有找到，那么报错：<code>not found</code></li></ul></li> <li><p>情况三：直接是一个 X（没有路径），并且 X 不是一个核心模块</p></li> <li><ul><li>比如 <code>/Users/coderwhy/Desktop/Node/TestCode/04_learn_node/05_javascript-module/02_commonjs/main.js</code>中编写 <code>require('why')</code></li> <li><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d3.png" alt="图片">查找顺序</li> <li>如果上面的路径中都没有找到，那么报错：<code>not found</code></li></ul></li></ul> <h5 id="_4-模块加载顺序"><a href="#_4-模块加载顺序" class="header-anchor">#</a> 4. 模块加载顺序</h5> <p>这里我们研究一下模块的加载顺序问题。</p> <p><strong>结论一：模块在被第一次引入时，模块中的 js 代码会被运行一次</strong></p> <p>aaa.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello aaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>main.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> aaa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./aaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>aaa.js 中的代码在引入时会被运行一次</p> <p><strong>结论二：模块被多次引入时，会缓存，最终只加载（运行）一次</strong></p> <p>main.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> aaa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./aaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bbb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bbb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>aaa.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ccc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./ccc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>bbb.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ccc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./ccc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ccc.js</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ccc被加载&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ccc 中的代码只会运行一次。</p> <p><strong>为什么只会加载运行一次呢？</strong></p> <ul><li>这是因为每个模块对象 module 都有一个属性：loaded。</li> <li>为 false 表示还没有加载，为 true 表示已经加载；</li></ul> <p><strong>结论三：如果有循环引入，那么加载顺序是什么？</strong></p> <p>如果出现下面模块的引用关系，那么加载顺序是什么呢？</p> <ul><li>这个其实是一种数据结构：图结构；</li> <li>图结构在遍历的过程中，有深度优先搜索（DFS, depth first search）和广度优先搜索（BFS, breadth first search）；</li> <li>Node 采用的是深度优先算法：main -&gt; aaa -&gt; ccc -&gt; ddd -&gt; eee -&gt;bbb</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d4.png" alt="图片">多个模块的引入关系</p> <h4 id="_4-3-3-node-的源码解析"><a href="#_4-3-3-node-的源码解析" class="header-anchor">#</a> 4.3.3. Node 的源码解析</h4> <p>Module 类</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d5.png" alt="图片">Module 类</p> <p>Module.prototype.require 函数</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d6.png" alt="图片">require 函数</p> <p>Module._load 函数</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d7.png" alt="图片">_load 函数的实现</p> <h3 id="_4-4-amd-和-cmd-规范"><a href="#_4-4-amd-和-cmd-规范" class="header-anchor">#</a> 4.4. AMD 和 CMD 规范</h3> <h4 id="_4-4-1-commonjs-规范缺点"><a href="#_4-4-1-commonjs-规范缺点" class="header-anchor">#</a> 4.4.1. CommonJS 规范缺点</h4> <p>CommonJS 加载模块是同步的：</p> <ul><li>同步的意味着只有等到对应的模块加载完毕，当前模块中的内容才能被运行；</li> <li>这个在服务器不会有什么问题，因为服务器加载的 js 文件都是本地文件，加载速度非常快；</li></ul> <p>如果将它应用于浏览器呢？</p> <ul><li>浏览器加载 js 文件需要先从服务器将文件下载下来，之后在加载运行；</li> <li>那么采用同步的就意味着后续的 js 代码都无法正常运行，即使是一些简单的 DOM 操作；</li></ul> <p>所以在浏览器中，我们通常不使用 CommonJS 规范：</p> <ul><li>当然在 webpack 中使用 CommonJS 是另外一回事；</li> <li>因为它会将我们的代码转成浏览器可以直接执行的代码；</li></ul> <p>在早期为了可以在浏览器中使用模块化，通常会采用 AMD 或 CMD：</p> <ul><li>但是目前一方面现代的浏览器已经支持 ES Modules，另一方面借助于 webpack 等工具可以实现对 CommonJS 或者 ES Module 代码的转换；</li> <li>AMD 和 CMD 已经使用非常少了，所以这里我们进行简单的演练；</li></ul> <h4 id="_4-4-2-amd-规范"><a href="#_4-4-2-amd-规范" class="header-anchor">#</a> 4.4.2. AMD 规范</h4> <p>AMD 主要是应用于浏览器的一种模块化规范：</p> <ul><li>AMD 是 Asynchronous Module Definition（异步模块定义）的缩写；</li> <li>它采用的是异步加载模块；</li> <li>事实上 AMD 的规范还要早于 CommonJS，但是 CommonJS 目前依然在被使用，而 AMD 使用的较少了；</li></ul> <p>我们提到过，规范只是定义代码的应该如何去编写，只有有了具体的实现才能被应用：</p> <ul><li>AMD 实现的比较常用的库是 require.js 和 curl.js；</li></ul> <p><strong>这里我们以 require.js 为例讲解：</strong></p> <p>第一步：下载 require.js</p> <ul><li>下载地址：https://github.com/requirejs/requirejs</li> <li>找到其中的 require.js 文件；</li></ul> <p>第二步：定义 HTML 的 script 标签引入 require.js 和定义入口文件：</p> <ul><li>data-main 属性的作用是在加载完 src 的文件后会加载执行该文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./lib/require.js&quot;</span> data<span class="token operator">-</span>main<span class="token operator">=</span><span class="token string">&quot;./index.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>第三步：编写如下目录和代码</p> <div class="language-js extra-class"><pre class="language-js"><code>├── index<span class="token punctuation">.</span>html
├── index<span class="token punctuation">.</span>js
├── lib
│   └── require<span class="token punctuation">.</span>js
└── modules
    ├── bar<span class="token punctuation">.</span>js
    └── foo<span class="token punctuation">.</span>js
</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  require<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">baseUrl</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">paths</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">&quot;./modules/foo&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token string">&quot;./modules/bar&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 开始加载执行foo模块的代码</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>modules/bar.js</p> <ul><li>如果一个模块不依赖其他，那么直接使用 define(function)即可</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">sayHello</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    age<span class="token punctuation">,</span>
    sayHello<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>modules/foo.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">bar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;kobe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-4-3-cmd-规范"><a href="#_4-4-3-cmd-规范" class="header-anchor">#</a> 4.4.3. CMD 规范</h4> <p>CMD 规范也是应用于浏览器的一种模块化规范：</p> <ul><li>CMD 是 Common Module Definition（通用模块定义）的缩写；</li> <li>它也采用了异步加载模块，但是它将 CommonJS 的优点吸收了过来；</li> <li>但是目前 CMD 使用也非常少了；</li></ul> <p>CMD 也有自己比较优秀的实现方案：</p> <ul><li>SeaJS</li></ul> <p><strong>我们一起看一下 SeaJS 如何使用：</strong></p> <p>第一步：下载 SeaJS</p> <ul><li>下载地址：https://github.com/seajs/seajs</li> <li>找到 dist 文件夹下的 sea.js</li></ul> <p>第二步：引入 sea.js 和使用主入口文件</p> <ul><li><code>seajs</code>是指定主入口文件的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./lib/sea.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  seajs<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'./index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>第三步：编写如下目录和代码</p> <div class="language-js extra-class"><pre class="language-js"><code>├── index<span class="token punctuation">.</span>html
├── index<span class="token punctuation">.</span>js
├── lib
│   └── sea<span class="token punctuation">.</span>js
└── modules
    ├── bar<span class="token punctuation">.</span>js
    └── foo<span class="token punctuation">.</span>js
</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./modules/foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>bar.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;lilei&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">sayHello</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;你好 &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    age<span class="token punctuation">,</span>
    sayHello<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>foo.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;韩梅梅&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-5-es-module"><a href="#_4-5-es-module" class="header-anchor">#</a> 4.5. ES Module</h3> <h4 id="_4-5-1-认识-es-module"><a href="#_4-5-1-认识-es-module" class="header-anchor">#</a> 4.5.1. 认识 ES Module</h4> <p>JavaScript 没有模块化一直是它的痛点，所以才会产生我们前面学习的社区规范：CommonJS、AMD、CMD 等，所以在 ES 推出自己的模块化系统时，大家也是兴奋异常。</p> <p>ES Module 和 CommonJS 的模块化有一些不同之处：</p> <ul><li>一方面它使用了 import 和 export 关键字；</li> <li>另一方面它采用编译期静态类型检测，并且动态引用的方式；</li></ul> <p>ES Module 模块采用 export 和 import 关键字来实现模块化：</p> <ul><li>export 负责将模块内的内容导出；</li> <li>import 负责从其他模块导入内容；</li></ul> <p>了解：采用 ES Module 将自动采用严格模式：<code>use strict</code></p> <ul><li>如果你不熟悉严格模式可以简单看一下 MDN 上的解析；</li> <li>https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Strict_mode</li></ul> <h4 id="_4-5-2-es-module-的使用"><a href="#_4-5-2-es-module-的使用" class="header-anchor">#</a> 4.5.2. ES Module 的使用</h4> <h5 id="_1-代码结构组件"><a href="#_1-代码结构组件" class="header-anchor">#</a> 1.代码结构组件</h5> <p>这里我在浏览器中演示 ES6 的模块化开发：</p> <p>代码结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>├── index<span class="token punctuation">.</span>html
├── main<span class="token punctuation">.</span>js
└── modules
    └── foo<span class="token punctuation">.</span>js
</code></pre></div><p>index.html 中引入两个 js 文件作为模块：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./modules/foo.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果直接在浏览器中运行代码，会报如下错误：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d8.png" alt="图片">模块化运行</p> <p>这个在 MDN 上面有给出解释：</p> <ul><li>https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules</li> <li>你需要注意本地测试 — 如果你通过本地加载 Html 文件 (比如一个 <code>file://</code> 路径的文件), 你将会遇到 CORS 错误，因为 Javascript 模块安全性需要。</li> <li>你需要通过一个服务器来测试。</li></ul> <p>我这里使用的 VSCode，VSCode 中有一个插件：Live Server</p> <ul><li>通过插件运行，可以将我们的代码运行在一个本地服务中；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/d9.png" alt="图片">image-20201012153439900</p> <h4 id="_4-5-3-export-关键字"><a href="#_4-5-3-export-关键字" class="header-anchor">#</a> 4.5.3. export 关键字</h4> <p>export 关键字将一个模块中的变量、函数、类等导出；</p> <p>foo.js 文件中默认代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">&quot;my name is why&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>我们希望将其他中内容全部导出，它可以有如下的方式：</strong></p> <p>方式一：在语句声明的前面直接加上 export 关键字</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">&quot;my name is why&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>方式二：将所有需要导出的标识符，放到 export 后面的 <code>{}</code>中</p> <ul><li>注意：这里的 <code>{}</code>里面不是 ES6 的对象字面量的增强写法，<code>{}</code>也不是表示一个对象的；</li> <li>所以：<code>export {name: name}</code>，是错误的写法；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">&quot;my name is why&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> message<span class="token punctuation">,</span> sayHello <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>方式三：导出时给<code>标识符</code>起一个别名</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token punctuation">{</span>
  name <span class="token keyword">as</span> fName<span class="token punctuation">,</span>
  age <span class="token keyword">as</span> fAge<span class="token punctuation">,</span>
  message <span class="token keyword">as</span> fMessage<span class="token punctuation">,</span>
  sayHello <span class="token keyword">as</span> fSayHello<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-5-4-import-关键字"><a href="#_4-5-4-import-关键字" class="header-anchor">#</a> 4.5.4. import 关键字</h4> <p>import 关键字负责从另外一个模块中导入内容</p> <p><strong>导入内容的方式也有多种：</strong></p> <p>方式一：<code>import {标识符列表} from '模块'</code>；</p> <ul><li>注意：这里的<code>{}</code>也不是一个对象，里面只是存放导入的标识符列表内容；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> message<span class="token punctuation">,</span> sayHello <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;Kobe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>方式二：导入时给标识符起别名</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  name <span class="token keyword">as</span> wName<span class="token punctuation">,</span>
  age <span class="token keyword">as</span> wAge<span class="token punctuation">,</span>
  message <span class="token keyword">as</span> wMessage<span class="token punctuation">,</span>
  sayHello <span class="token keyword">as</span> wSayHello<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>方式三：将模块功能放到一个模块功能对象（a module object）上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> foo <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;Kobe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-5-5-export-和-import-结合"><a href="#_4-5-5-export-和-import-结合" class="header-anchor">#</a> 4.5.5. export 和 import 结合</h4> <p>如果从一个模块中导入的内容，我们希望再直接导出出去，这个时候可以直接使用 export 来导出。</p> <p>bar.js 中导出一个 sum 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>foo.js 中导入，但是只是做一个中转：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./bar.js&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>main.js 直接从 foo 中导入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>甚至在 foo.js 中导出时，我们可以变化它的名字</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token keyword">as</span> barSum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./bar.js&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>为什么要这样做呢？</p> <ul><li>在开发和封装一个功能库时，通常我们希望将暴露的所有接口放到一个文件中；</li> <li>这样方便指定统一的接口规范，也方便阅读；</li> <li>这个时候，我们就可以使用 export 和 import 结合使用；</li></ul> <h4 id="_4-5-6-default-用法"><a href="#_4-5-6-default-用法" class="header-anchor">#</a> 4.5.6. default 用法</h4> <p>前面我们学习的导出功能都是有名字的导出（named exports）：</p> <ul><li>在导出 export 时指定了名字；</li> <li>在导入 import 时需要知道具体的名字；</li></ul> <p>还有一种导出叫做默认导出（default export）</p> <ul><li>默认导出 export 时可以不需要指定名字；</li> <li>在导入时不需要使用 <code>{}</code>，并且可以自己来指定名字；</li> <li>它也方便我们和现有的 CommonJS 等规范相互操作；</li></ul> <p>导出格式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> num1 <span class="token operator">-</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>导入格式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> sub <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意：在一个模块中，只能有一个默认导出（default export）；</p> <h4 id="_4-5-7-import"><a href="#_4-5-7-import" class="header-anchor">#</a> 4.5.7. import()</h4> <p>通过 import 加载一个模块，是不可以在其放到逻辑代码中的，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span> sub <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为什么会出现这个情况呢？</p> <ul><li>这是因为 ES Module 在被 JS 引擎解析时，就必须知道它的依赖关系；</li> <li>由于这个时候 js 代码没有任何的运行，所以无法在进行类似于 if 判断中根据代码的执行情况；</li> <li>甚至下面的这种写法也是错误的：因为我们必须到运行时能确定 path 的值；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token string">'./modules/foo.js'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> sub from path<span class="token punctuation">;</span>
</code></pre></div><p>但是某些情况下，我们确确实实希望动态的来加载某一个模块：</p> <ul><li>如果根据不懂的条件，动态来选择加载模块的路径；</li> <li>这个时候我们需要使用 <code>import()</code> 函数来动态加载；</li></ul> <p>aaa.js 模块：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;aaa被打印&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>bbb.js 模块：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bbb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bbb被执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>main.js 模块：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./modules/aaa.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">aaa</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    aaa<span class="token punctuation">.</span><span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./modules/bbb.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">bbb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    bbb<span class="token punctuation">.</span><span class="token function">bbb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-3-es-module-的原理"><a href="#_4-3-es-module-的原理" class="header-anchor">#</a> 4.3. ES Module 的原理</h3> <h4 id="_4-3-1-es-module-和-commonjs-的区别"><a href="#_4-3-1-es-module-和-commonjs-的区别" class="header-anchor">#</a> 4.3.1. ES Module 和 CommonJS 的区别</h4> <p><strong>CommonJS 模块加载 js 文件的过程是运行时加载的，并且是同步的：</strong></p> <ul><li>运行时加载意味着是 js 引擎在执行 js 代码的过程中加载 模块；</li> <li>同步的就意味着一个文件没有加载结束之前，后面的代码都不会执行；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;main代码执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 同步加载foo文件，并且执行一次内部的代码</span>
  <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;if语句继续执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>CommonJS 通过 module.exports 导出的是一个对象：</strong></p> <ul><li>导出的是一个对象意味着可以将这个对象的引用在其他模块中赋值给其他变量；</li> <li>但是最终他们指向的都是同一个对象，那么一个变量修改了对象的属性，所有的地方都会被修改；</li></ul> <p><strong>ES Module 加载 js 文件的过程是编译（解析）时加载的，并且是异步的：</strong></p> <ul><li><p>编译时（解析）时加载，意味着 import 不能和运行时相关的内容放在一起使用：</p></li> <li><ul><li>比如 from 后面的路径需要动态获取；</li> <li>比如不能将 import 放到 if 等语句的代码块中；</li> <li>所以我们有时候也称 ES Module 是静态解析的，而不是动态或者运行时解析的；</li></ul></li> <li><p>异步的意味着：JS 引擎在遇到<code>import</code>时会去获取这个 js 文件，但是这个获取的过程是异步的，并不会阻塞主线程继续执行；</p></li> <li><ul><li>也就是说设置了 <code>type=module</code> 的代码，相当于在 script 标签上也加上了 <code>async</code> 属性；</li> <li>如果我们后面有普通的 script 标签以及对应的代码，那么 ES Module 对应的 js 文件和代码不会阻塞它们的执行；</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;main.js&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 这个js文件的代码不会被阻塞执行 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;index.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>ES Module 通过 export 导出的是变量本身的引用：</strong></p> <ul><li>export 在导出一个变量时，js 引擎会解析这个语法，并且创建<strong>模块环境记录</strong>（module environment record）；</li> <li><strong>模块环境记录</strong>会和变量进行 <code>绑定</code>（binding），并且这个绑定是实时的；</li> <li>而在导入的地方，我们是可以实时的获取到绑定的最新值的；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e1.png" alt="图片">export 和 import 绑定的过程</p> <p><strong>所以我们下面的代码是成立的：</strong></p> <p>bar.js 文件中修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">&quot;湖人总冠军&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>main.js 文件中获取</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/bar.js&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bar中修改, main中验证</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但是，下面的代码是不成立的：main.js 中修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/bar.js&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// main中修改, bar中验证</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">&quot;kobe&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e2.png" alt="图片">导入的变量不可以被修改</p> <p>思考：如果 bar.js 中导出的是一个对象，那么 main.js 中是否可以修改对象中的属性呢？</p> <ul><li>答案是可以的，因为他们指向同一块内存空间；（自己编写代码验证，这里不再给出）</li></ul> <h4 id="_4-3-2-node-中支持-es-module"><a href="#_4-3-2-node-中支持-es-module" class="header-anchor">#</a> 4.3.2. Node 中支持 ES Module</h4> <p><strong>在 Current 版本中</strong></p> <p>在最新的 Current 版本（v14.13.1）中，支持 es module 我们需要进行如下操作：</p> <ul><li>方式一：在 package.json 中配置 <code>type: module</code>（后续再学习，我们现在还没有讲到 package.json 文件的作用）</li> <li>方式二：文件以 <code>.mjs</code> 结尾，表示使用的是 ES Module；</li></ul> <p>这里我们暂时选择以 <code>.mjs</code> 结尾的方式来演练：</p> <p>bar.mjs</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>main.mjs</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/bar.mjs&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>在 LTS 版本中</strong></p> <p>在最新的 LST 版本（v12.19.0）中，我们也是可以正常运行的，但是会报一个警告：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e3.png" alt="图片">lts 版本的警告</p> <h4 id="_4-3-3-es-module-和-commonjs-的交互"><a href="#_4-3-3-es-module-和-commonjs-的交互" class="header-anchor">#</a> 4.3.3. ES Module 和 CommonJS 的交互</h4> <p><strong>CommonJS 加载 ES Module</strong></p> <p>结论：通常情况下，CommonJS 不能加载 ES Module</p> <ul><li>因为 CommonJS 是同步加载的，但是 ES Module 必须经过静态分析等，无法在这个时候执行 JavaScript 代码；</li> <li>但是这个并非绝对的，某些平台在实现的时候可以对代码进行针对性的解析，也可能会支持；</li> <li>Node 当中是不支持的；</li></ul> <p><strong>ES Module 加载 CommonJS</strong></p> <p>结论：多数情况下，ES Module 可以加载 CommonJS</p> <ul><li>ES Module 在加载 CommonJS 时，会将其 module.exports 导出的内容作为 default 导出方式来使用；</li> <li>这个依然需要看具体的实现，比如 webpack 中是支持的、Node 最新的 Current 版本也是支持的；</li> <li>但是在最新的 LTS 版本中就不支持；</li></ul> <p>foo.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> address <span class="token operator">=</span> <span class="token string">&quot;foo的address&quot;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  address<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>main.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> foo <span class="token keyword">from</span> <span class="token string">&quot;./modules/foo.js&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_05-常见的内置模块"><a href="#_05-常见的内置模块" class="header-anchor">#</a> 05.常见的内置模块</h2> <h3 id="_5-1-内置模块-path"><a href="#_5-1-内置模块-path" class="header-anchor">#</a> 5.1. 内置模块 path</h3> <h4 id="_5-1-1-认识-path-模块"><a href="#_5-1-1-认识-path-模块" class="header-anchor">#</a> 5.1.1. 认识 path 模块</h4> <p>path 模块用于对路径和文件进行处理，提供了很多好用的方法。</p> <p>并且我们知道在 Mac OS、Linux 和 window 上的路径是不一样的</p> <ul><li>window 上会使用 <code>\</code>或者 <code>\\</code> 来作为文件路径的分隔符，当然目前也支持 <code>/</code>；</li> <li>在 Mac OS、Linux 的 Unix 操作系统上使用 <code>/</code> 来作为文件路径的分隔符；</li></ul> <p>那么如果我们在 window 上使用 <code>\</code> 来作为分隔符开发了一个应用程序，要部署到 Linux 上面应该怎么办呢？</p> <ul><li>显示路径会出现一些问题；</li> <li>所以为了屏蔽他们之间的差异，在开发中对于路径的操作我们可以使用 <code>path</code> 模块；</li></ul> <h4 id="_5-1-2-path-常见的-api"><a href="#_5-1-2-path-常见的-api" class="header-anchor">#</a> 5.1.2. path 常见的 API</h4> <p><strong>从路径中获取信息</strong></p> <ul><li>dirname：获取文件的父文件夹；</li> <li>basename：获取文件名；</li> <li>extname：获取文件扩展名；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myPath <span class="token operator">=</span> <span class="token string">&quot;/Users/coderwhy/Desktop/Node/课堂/PPT/01_邂逅Node.pdf&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>myPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>myPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>myPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /Users/coderwhy/Desktop/Node/课堂/PPT</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 01_邂逅Node.pdf</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>extname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .pdf</span>
</code></pre></div><p><strong>路径的拼接</strong></p> <ul><li>如果我们希望将多个路径进行拼接，但是不同的操作系统可能使用的是不同的分隔符；</li> <li>这个时候我们可以使用<code>path.join</code>函数；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;why&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>将文件和某个文件夹拼接</strong></p> <ul><li><p>如果我们希望将某个文件和文件夹拼接，可以使用 <code>path.resolve</code>;</p></li> <li><ul><li><code>resolve</code>函数会判断我们拼接的路径前面是否有 <code>/</code>或<code>../</code>或<code>./</code>；</li> <li>如果有表示是一个绝对路径，会返回对应的拼接路径；</li> <li>如果没有，那么会和当前执行文件所在的文件夹进行路径的拼接</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /Users/coderwhy/Desktop/Node/TestCode/04_learn_node/06_常见的内置模块/02_文件路径/abc.txt</span>
path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;/abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /abc.txt</span>
path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;/User/why&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /User/why/abc.txt</span>
path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;User/why&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /Users/coderwhy/Desktop/Node/TestCode/04_learn_node/06_常见的内置模块/02_文件路径/User/why/abc.txt</span>
</code></pre></div><p>resolve 其实我们在 webpack 中也会使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> CracoLessPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;craco-less&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">plugin</span><span class="token operator">:</span> CracoLessPlugin<span class="token punctuation">,</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">lessLoaderOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">lessOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">modifyVars</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;@primary-color&quot;</span><span class="token operator">:</span> <span class="token string">&quot;#1DA57A&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">javascriptEnabled</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">webpack</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;@&quot;</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;src/components&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-2-内置模块-fs"><a href="#_5-2-内置模块-fs" class="header-anchor">#</a> 5.2. 内置模块 fs</h3> <h4 id="_5-2-1-认识-fs-模块"><a href="#_5-2-1-认识-fs-模块" class="header-anchor">#</a> 5.2.1. 认识 fs 模块</h4> <p>fs 是 File System 的缩写，表示文件系统。</p> <p>对于任何一个为服务器端服务的语言或者框架通常都会有自己的文件系统：</p> <ul><li>因为服务器需要将各种数据、文件等放置到不同的地方；</li> <li>比如用户数据可能大多数是放到数据库中的（后面我们也会学习）；</li> <li>比如某些配置文件或者用户资源（图片、音视频）都是以文件的形式存在于操作系统上的；</li></ul> <p>Node 也有自己的文件系统操作模块，就是 fs：</p> <ul><li>借助于 Node 帮我们封装的文件系统，我们可以在任何的操作系统（window、Mac OS、Linux）上面直接去操作文件；</li> <li>这也是 Node 可以开发服务器的一大原因，也是它可以成为前端自动化脚本等热门工具的原因；</li></ul> <p>Node 文件系统的 API 非常的多：https://nodejs.org/dist/latest-v14.x/docs/api/fs.html</p> <ul><li>我们不可能，也没必要一个个去学习；</li> <li>这个更多的应该是作为一个 API 查询的手册，等用到的时候查询即可；</li> <li>学习阶段我们只需要学习最常用的即可；</li></ul> <p>但是这些 API 大多数都提供三种操作方式：</p> <ul><li>方式一：同步操作文件：代码会被阻塞，不会继续执行；</li> <li>方式二：异步回调函数操作文件：代码不会被阻塞，需要传入回调函数，当获取到结果时，回调函数被执行；</li> <li>方式三：异步 Promise 操作文件：代码不会被阻塞，通过 <code>fs.promises</code> 调用方法操作，会返回一个 Promise，可以通过 then、catch 进行处理；</li></ul> <p><strong>我们这里以获取一个文件的状态为例：</strong></p> <ul><li>注意：都需要引入 <code>fs</code> 模块；</li></ul> <p>方式一：同步操作文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.方式一: 同步读取文件</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;后续代码执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>方式二：异步回调函数操作文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 2.方式二: 异步读取</span>
fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;后续代码执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>方式三：异步 Promise 操作文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 3.方式三: Promise方式</span>
fs<span class="token punctuation">.</span>promises
  <span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;后续代码执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>后续代码演练中，我将以异步回调的方式演练：相对更通用一些；</p> <h4 id="_5-2-2-文件描述符"><a href="#_5-2-2-文件描述符" class="header-anchor">#</a> 5.2.2. 文件描述符</h4> <p>文件描述符（File descriptors）是什么呢？</p> <p>在 POSIX 系统上，对于每个进程，内核都维护着一张当前打开着的文件和资源的表格。</p> <ul><li>每个打开的文件都分配了一个称为文件描述符的简单的数字标识符。</li> <li>在系统层，所有文件系统操作都使用这些文件描述符来标识和跟踪每个特定的文件。</li> <li>Windows 系统使用了一个虽然不同但概念上类似的机制来跟踪资源。</li> <li>为了简化用户的工作，Node.js 抽象出操作系统之间的特定差异，并为所有打开的文件分配一个数字型的文件描述符。</li></ul> <p><code>fs.open()</code> 方法用于分配新的文件描述符。一旦被分配，则文件描述符可用于从文件读取数据、向文件写入数据、或请求关于文件的信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取文件描述符</span>
fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  fs<span class="token punctuation">.</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-2-3-文件的读写"><a href="#_5-2-3-文件的读写" class="header-anchor">#</a> 5.2.3.文件的读写</h4> <p>如果我们希望对文件的内容进行操作，这个时候可以使用文件的读写：</p> <ul><li><code>fs.readFile(path[, options], callback)</code>：读取文件的内容；</li> <li><code>fs.writeFile(file, data[, options], callback)</code>：在文件中写入内容；</li></ul> <p>文件写入：</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面的代码中，你会发现有一个大括号没有填写任何的内容，这个是写入时填写的 option 参数：</p> <ul><li>flag：写入的方式。</li> <li>encoding：字符的编码；</li></ul> <p>我们先来看 flag：</p> <ul><li><p>flag 的值有很多：https://nodejs.org/dist/latest-v14.x/docs/api/fs.html#fs_file_system_flags</p></li> <li><ul><li><code>w</code> 打开文件写入，默认值；</li> <li><code>w+</code>打开文件进行读写，如果不存在则创建文件；</li> <li><code>r+</code> 打开文件进行读写，如果不存在那么抛出异常；</li> <li><code>r</code>打开文件读取，读取时的默认值；</li> <li><code>a</code>打开要写入的文件，将流放在文件末尾。如果不存在则创建文件；</li> <li><code>a+</code>打开文件以进行读写，将流放在文件末尾。如果不存在则创建文件</li></ul></li></ul> <p>我们再来看看编码：</p> <ul><li>我之前在简书上写过一篇关于字符编码的文章：https://www.jianshu.com/p/899e749be47c</li> <li>目前基本用的都是 UTF-8 编码；</li></ul> <p>文件读取：</p> <ul><li>如果不填写 encoding，返回的结果是 Buffer；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf-8&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>文件读取：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;../foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf-8&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-2-3-文件夹操作"><a href="#_5-2-3-文件夹操作" class="header-anchor">#</a> 5.2.3.文件夹操作</h4> <p><strong>新建一个文件夹</strong></p> <p>使用<code>fs.mkdir()</code>或<code>fs.mkdirSync()</code>创建一个新文件夹：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dirname <span class="token operator">=</span> <span class="token string">&quot;../why&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>获取文件夹的内容</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 读取文件夹</span>
<span class="token keyword">function</span> <span class="token function">readFolders</span><span class="token punctuation">(</span><span class="token parameter">folder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>folder<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">withFileTypes</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newFolder <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">readFolders</span><span class="token punctuation">(</span>newFolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">readFolders</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>文件重命名</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;../why&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;../coder&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-3-内置模块-events"><a href="#_5-3-内置模块-events" class="header-anchor">#</a> 5.3. 内置模块 events</h3> <h4 id="_5-3-1-基本使用"><a href="#_5-3-1-基本使用" class="header-anchor">#</a> 5.3.1. 基本使用</h4> <p>Node 中的核心 API 都是基于异步事件驱动的：</p> <ul><li>在这个体系中，某些对象（发射器（Emitters））发出某一个事件；</li> <li>我们可以监听这个事件（监听器 Listeners），并且传入的回调函数，这个回调函数会在监听到事件时调用；</li></ul> <p>发出事件和监听事件都是通过 EventEmitter 类来完成的，它们都属于 events 对象。</p> <ul><li><code>emitter.on(eventName, listener)</code>：监听事件，也可以使用<code>addListener</code>；</li> <li><code>emitter.off(eventName, listener)</code>：移除事件监听，也可以使用<code>removeListener</code>；</li> <li><code>emitter.emit(eventName[, ...args])</code>：发出事件，可以携带一些参数；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmmiter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听事件</span>
<span class="token keyword">const</span> bus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmmiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">clickHanlde</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;监听到click事件&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bus<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> clickHanlde<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  bus<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bus<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> clickHanlde<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bus<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;kobe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-3-1-常见的属性"><a href="#_5-3-1-常见的属性" class="header-anchor">#</a> 5.3.1. 常见的属性</h4> <p>EventEmitter 的实例有一些属性，可以记录一些信息：</p> <ul><li><code>emitter.eventNames()</code>：返回当前 <code>EventEmitter对象</code>注册的事件字符串数组；</li> <li><code>emitter.getMaxListeners()</code>：返回当前 <code>EventEmitter对象</code>的最大监听器数量，可以通过<code>setMaxListeners()</code>来修改，默认是 10；</li> <li><code>emitter.listenerCount(事件名称)</code>：返回当前 <code>EventEmitter对象</code>某一个事件名称，监听器的个数；</li> <li><code>emitter.listeners(事件名称)</code>：返回当前 <code>EventEmitter对象</code>某个事件监听器上所有的监听器数组；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bus<span class="token punctuation">.</span><span class="token function">eventNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bus<span class="token punctuation">.</span><span class="token function">getMaxListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bus<span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bus<span class="token punctuation">.</span><span class="token function">listeners</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-3-1-方法的补充"><a href="#_5-3-1-方法的补充" class="header-anchor">#</a> 5.3.1. 方法的补充</h4> <p><code>emitter.once(eventName, listener)</code>：事件监听一次</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;监听到事件&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>emitter.prependListener()</code>：将监听事件添加到最前面</p> <div class="language-js extra-class"><pre class="language-js"><code>emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;a监听到事件&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// b监听事件会被放到前面</span>
emitter<span class="token punctuation">.</span><span class="token function">prependListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;b监听到事件&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>emitter.prependOnceListener()</code>：将监听事件添加到最前面，但是只监听一次</p> <div class="language-js extra-class"><pre class="language-js"><code>emitter<span class="token punctuation">.</span><span class="token function">prependOnceListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;c监听到事件&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>emitter.removeAllListeners([eventName])</code>：移除所有的监听器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 移除emitter上的所有事件监听</span>
emitter<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 移除emitter上的click事件监听</span>
emitter<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_06-npm-你不知道的细节"><a href="#_06-npm-你不知道的细节" class="header-anchor">#</a> 06.npm 你不知道的细节</h2> <h3 id="_6-1-包管理工具"><a href="#_6-1-包管理工具" class="header-anchor">#</a> 6.1. 包管理工具</h3> <h4 id="_6-1-1-认识-npm"><a href="#_6-1-1-认识-npm" class="header-anchor">#</a> 6.1.1. 认识 npm</h4> <p>我们已经学习了在 JavaScript 中可以通过模块化的方式将代码划分成一个个小的结构：</p> <ul><li>在以后的开发中我们就可以通过模块化的方式来封装自己的代码，并且封装成一个工具；</li> <li>这个工具我们可以让同事通过导入的方式来使用，甚至你可以分享给世界各地的程序员来使用；</li></ul> <p><strong>如果我们分享给世界上所有的程序员使用，有哪些方式呢？</strong></p> <p>方式一：上传到 GitHub 上、其他程序员通过 GitHub 下载我们的代码手动的引用；</p> <ul><li>缺点是大家必须知道你的代码 GitHub 的地址，并且从 GitHub 上手动下载；</li> <li>需要在自己的项目中手动的引用，并且管理相关的依赖；</li> <li>不需要使用的时候，需要手动来删除相关的依赖；</li> <li>当遇到版本升级或者切换时，需要重复上面的操作；</li></ul> <p>显然，上面的方式是有效的，但是这种传统的方式非常麻烦，并且容易出错；</p> <p>方式二：使用一个专业的工具来管理我们的代码</p> <ul><li>我们通过工具将代码发布到特定的位置；</li> <li>其他程序员直接通过工具来安装、升级、删除我们的工具代码；</li></ul> <p>显然，通过第二种方式我们可以更好的管理自己的工具包，其他人也可以更好的使用我们的工具包。</p> <p>包管理工具 npm：</p> <ul><li>Node Package Manager，也就是 Node 包管理器；</li> <li>但是目前已经不仅仅是 Node 包管理器了，在前端项目中我们也在使用它来管理依赖的包；</li> <li>比如 express、koa、react、react-dom、axios、babel、webpack 等等；</li></ul> <p>npm 管理的包可以在哪里查看、搜索呢？</p> <ul><li>https://www.npmjs.com/</li> <li>这是我们安装相关的 npm 包的官网；</li></ul> <p>npm 管理的包存放在哪里呢？</p> <ul><li>我们发布自己的包其实是发布到 registry 上面的；</li> <li>当我们安装一个包时其实是从 registry 上面下载的包；</li></ul> <h4 id="_6-1-2-项目配置文件"><a href="#_6-1-2-项目配置文件" class="header-anchor">#</a> 6.1.2. 项目配置文件</h4> <p>事实上，我们每一个项目都会有一个对应的配置文件，无论是前端项目还是后端项目：</p> <ul><li>这个配置文件会记录着你项目的名称、版本号、项目描述等；</li> <li>也会记录着你项目所依赖的其他库的信息和依赖库的版本号；</li></ul> <p>这个配置文件在 Node 环境下面（无论是前端还是后端）就是 package.json。</p> <p>我们以 vue cli4 脚手架创建的项目为例：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-vue&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service serve&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service lint&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;core-js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.6.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.11&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@vue/cli-plugin-babel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~4.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@vue/cli-plugin-eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~4.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@vue/cli-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~4.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.1.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.7.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eslint-plugin-vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.2.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vue-template-compiler&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.11&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;browserslist&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&gt; 1%&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;last 2 versions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;not dead&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>事实上 Vue ClI4 脚手架创建的项目相对进行了简化，我们来看一下 CLI2 创建的项目：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vuerouterbasic&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A Vue.js project&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'coderwhy' &lt;'coderwhy@gmail.com'&gt;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack-dev-server --inline --progress --config build/webpack.dev.conf.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run dev&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node build/build.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.5.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vue-router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;autoprefixer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.1.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.22.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-helper-vue-jsx-merge-props&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-plugin-syntax-jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.18.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-plugin-transform-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.22.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-plugin-transform-vue-jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-preset-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.3.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-preset-stage-2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.22.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;chalk&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;copy-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;css-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.28.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;extract-text-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;file-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;friendly-errors-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.6.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;html-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.30.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;node-notifier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.1.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;optimize-css-assets-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.2.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ora&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.2.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;portfinder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.13&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;postcss-import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^11.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;postcss-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.8&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;postcss-url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.2.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;rimraf&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;semver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.3.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;shelljs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.7.6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;uglifyjs-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;url-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.5.8&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vue-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^13.3.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vue-style-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vue-template-compiler&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.5.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.6.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack-bundle-analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.9.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack-dev-server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.9.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack-merge&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;engines&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;= 6.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;npm&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;= 3.0.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;browserslist&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&gt; 1%&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;last 2 versions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;not ie &lt;= 8&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们也可以手动创建一个 package.json 文件：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm init #创建时填写信息
npm init <span class="token operator">-</span>y # 所有信息使用默认的
</code></pre></div><p><code>npm init -y</code>生成文件的效果：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;learn-npm&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们会发现属性非常的多，我们这里对一些常见属性进行一些解析。</p> <p><strong>必须填写的属性：name、version</strong></p> <ul><li>name 是项目的名称；</li> <li>version 是当前项目的版本号；</li> <li>description 是描述信息，很多时候是作为项目的基本描述；</li> <li>author 是作者相关信息（发布时用到）；</li> <li>license 是开源协议（发布时用到）；</li></ul> <p><strong>private 属性：</strong></p> <ul><li>private 属性记录当前的项目是否是私有的；</li> <li>当值为 true 时，npm 是不能发布它的，这是防止私有项目或模块发布出去的方式；</li></ul> <p><strong>main 属性：</strong></p> <ul><li><p>设置程序的入口。</p></li> <li><p>很多人会有疑惑，webpack 不是会自动找到程序的入口吗？</p></li> <li><ul><li>这个入口和 webpack 打包的入口并不冲突；</li> <li>它是在你发布一个模块的时候会用到的；</li> <li>比如我们使用 axios 模块 <code>const axios = require('axios');</code></li> <li>实际上是找到对应的 main 属性查找文件的；</li></ul></li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e4.png" alt="图片">axios 的入口</p> <p><strong>scripts 属性</strong></p> <ul><li><p>scripts 属性用于配置一些脚本命令，以键值对的形式存在；</p></li> <li><p>配置后我们可以通过 <code>npm run 命令的key</code>来执行这个命令；</p></li> <li><p><code>npm start</code>和<code>npm run start</code>的区别是什么？</p></li> <li><ul><li>它们是等价的；</li> <li>对于常用的 start、 test、stop、restart 可以省略掉 run 直接通过 <code>npm start</code>等方式运行；</li></ul></li></ul> <p><strong>dependencies 属性</strong></p> <ul><li>dependencies 属性是指定无论开发环境还是生成环境都需要依赖的包；</li> <li>通常是我们项目实际开发用到的一些库模块；</li> <li>与之对应的是 devDependencies；</li></ul> <p><strong>devDependencies 属性</strong></p> <ul><li>一些包在生成环境是不需要的，比如 webpack、babel 等；</li> <li>这个时候我们会通过 <code>npm install webpack --save-dev</code>，将它安装到 devDependencies 属性中；</li></ul> <p>疑问：那么在生成环境如何保证不安装这些包呢？</p> <ul><li>生成环境不需要安装时，我们需要通过 <code>npm install --production</code> 来安装文件的依赖；</li></ul> <p><strong>版本管理的问题</strong></p> <p>我们会发现安装的依赖版本出现：<code>^2.0.3</code>或<code>~2.0.3</code>，这是什么意思呢？</p> <p>npm 的包通常需要遵从 semver 版本规范：</p> <ul><li>semver：https://semver.org/lang/zh-CN/</li> <li>npm semver：https://docs.npmjs.com/misc/semver</li></ul> <p>semver 版本规范是 X.Y.Z：</p> <ul><li>X 主版本号（major）：当你做了不兼容的 API 修改（可能不兼容之前的版本）；</li> <li>Y 次版本号（minor）：当你做了向下兼容的功能性新增（新功能增加，但是兼容之前的版本）；</li> <li>Z 修订号（patch）：当你做了向下兼容的问题修正（没有新功能，修复了之前版本的 bug）；</li></ul> <p>我们这里解释一下 ^和~的区别：</p> <ul><li><code>^x.y.z</code>：表示 x 是保持不变的，y 和 z 永远安装最新的版本；</li> <li><code>~x.y.z</code>：表示 x 和 y 保持不变的，z 永远安装最新的版本；</li></ul> <p><strong>engines 属性</strong></p> <ul><li>engines 属性用于指定 Node 和 NPM 的版本号；</li> <li>在安装的过程中，会先检查对应的引擎版本，如果不符合就会报错；</li> <li>事实上也可以指定所在的操作系统 <code>&quot;os&quot; : [ &quot;darwin&quot;, &quot;linux&quot; ]</code>，只是很少用到；</li></ul> <p><strong>browserslist 属性</strong></p> <ul><li>用于配置打包后的 JavaScript 浏览器的兼容情况，参考；</li> <li>否则我们需要手动的添加 polyfills 来让支持某些语法；</li> <li>也就是说它是为 webpack 等打包工具服务的一个属性（这里不是详细讲解 webpack 等工具的工作原理，所以不再给出详情）；</li></ul> <h3 id="_6-2-npm-工具解析"><a href="#_6-2-npm-工具解析" class="header-anchor">#</a> 6.2. npm 工具解析</h3> <h4 id="_6-2-1-npm-install-命令"><a href="#_6-2-1-npm-install-命令" class="header-anchor">#</a> 6.2.1. npm install 命令</h4> <p>安装 npm 包分两种情况：</p> <ul><li>全局安装（global install）：<code>npm install yarn -g</code>;</li> <li>项目（局部）安装（local install）：<code>npm install</code></li></ul> <p><strong>全局安装</strong></p> <p>全局安装是直接将某个包安装到全局：</p> <p>比如 yarn 的全局安装：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install yarn <span class="token operator">-</span>g
</code></pre></div><p>但是很多人对全局安装有一些误会：</p> <ul><li>通常使用 npm 全局安装的包都是一些工具包：yarn、webpack 等；</li> <li>并不是类似于 axios、express、koa 等库文件；</li> <li>所以全局安装了之后并不能让我们在所有的项目中使用 axios 等库；</li></ul> <p><strong>项目安装</strong></p> <p>项目安装会在当前目录下生产一个 <code>node_modules</code> 文件夹，我们之前讲解 require 查找顺序时有讲解过这个包在什么情况下被查找；</p> <p>局部安装分为开发时依赖和生产时依赖：</p> <div class="language-js extra-class"><pre class="language-js"><code># 安装开发和生产依赖
npm install axios <span class="token operator">--</span>save
npm install axios <span class="token operator">-</span><span class="token constant">S</span>
npm install axios
npm i axios

# 开发者
npm install axios <span class="token operator">--</span>save<span class="token operator">-</span>dev
npm install axios <span class="token operator">-</span><span class="token constant">D</span>
npm i axios <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><h4 id="_6-2-2-npm-install-原理"><a href="#_6-2-2-npm-install-原理" class="header-anchor">#</a> 6.2.2. npm install 原理</h4> <p>很多同学之情应该已经会了 <code>npm install</code>，但是你是否思考过它的内部原理呢？</p> <ul><li>执行 <code>npm install</code>它背后帮助我们完成了什么操作？</li> <li>我们会发现还有一个成为 package-lock.json 的文件，它的作用是什么？</li> <li>从 npm5 开始，npm 支持缓存策略（来自 yarn 的压力），缓存有什么作用呢？</li></ul> <p>这是一幅我画出的根据 <code>npm install</code> 的原理图：</p> <ul><li><p>npm install 会检测是有 package-lock.json 文件：</p></li> <li><ul><li>检测 lock 中包的版本是否和 package.json 中一致（会按照 semver 版本规范检测）；</li> <li>一致的情况下，会去优先查找缓存</li> <li>查找到，会获取缓存中的压缩文件，并且将压缩文件解压到 node_modules 文件夹中；</li> <li>不一致，那么会重新构建依赖关系，直接会走顶层的流程；</li> <li>没有找到，会从 registry 仓库下载，直接走顶层流程；</li> <li>分析依赖关系，这是因为我们可能包会依赖其他的包，并且多个包之间会产生相同依赖的情况；</li> <li>从 registry 仓库中下载压缩包（如果我们设置了镜像，那么会从镜像服务器下载压缩包）；</li> <li>获取到压缩包后会对压缩包进行缓存（从 npm5 开始有的）；</li> <li>将压缩包解压到项目的 node_modules 文件夹中（前面我们讲过，require 的查找顺序会在该包下面查找）</li> <li>没有 lock 文件</li> <li>有 lock 文件</li></ul></li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e5.png" alt="图片">npm install 原理图</p> <p>package-lock.json 文件：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;learn-npm&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;lockfileVersion&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;requires&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;axios&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.20.0&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/axios/-/axios-0.20.0.tgz&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha512-ANA4rr2BDcmmAQLOKft2fufrtuvlqR+cXNNinUmvfeSNCOF98PZL+7M/v1zIdGo7OLjEA9J2gXJL+j4zGsl0bA==&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;requires&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;follow-redirects&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.10.0&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;follow-redirects&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.13.0&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.13.0.tgz&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha512-aq6gF1BEKje4a9i9+5jimNFIpq4Q1WiwBToeRK5NvZBd/TRsmW8BsJfOEGkr76TbOyPVD3OVDN910EcUNtRYEA==&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>package-lock.json 文件解析：</p> <ul><li><p>name：项目的名称；</p></li> <li><p>version：项目的版本；</p></li> <li><p>lockfileVersion：lock 文件的版本；</p></li> <li><p>requires：使用 requires 来跟着模块的依赖关系；</p></li> <li><p>dependencies：项目的依赖</p></li> <li><ul><li>version 表示实际安装的 axios 的版本；</li> <li>resolved 用来记录下载的地址，registry 仓库中的位置；</li> <li>requires 记录当前模块的依赖；</li> <li>integrity 用来从缓存中获取索引，再通过索引去获取压缩包文件；</li> <li>当前项目依赖 axios，但是 axios 依赖 follow-redireacts；</li> <li>axios 中的属性如下：</li></ul></li></ul> <h4 id="_6-2-3-其他-npm-命令"><a href="#_6-2-3-其他-npm-命令" class="header-anchor">#</a> 6.2.3. 其他 npm 命令</h4> <p>我们这里再介绍几个比较常用的：</p> <p>卸载某个依赖包：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm uninstall <span class="token keyword">package</span>
npm uninstall <span class="token keyword">package</span> <span class="token operator">--</span>save<span class="token operator">-</span>dev
npm uninstall <span class="token keyword">package</span> <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><p>强制重新 build</p> <div class="language-js extra-class"><pre class="language-js"><code>npm rebuild
</code></pre></div><p>清除缓存</p> <div class="language-js extra-class"><pre class="language-js"><code>npm cache clean
</code></pre></div><p>npm 的命令其实是非常多的：</p> <ul><li>https://docs.npmjs.com/cli-documentation/cli</li> <li>更多的命令，可以根据需要查阅官方文档</li></ul> <h4 id="_6-2-4-yarn-和-cnpm"><a href="#_6-2-4-yarn-和-cnpm" class="header-anchor">#</a> 6.2.4. yarn 和 cnpm</h4> <p>另一个 node 包管理工具 yarn：</p> <ul><li>yarn 是由 Facebook、Google、Exponent 和 Tilde 联合推出了一个新的 JS 包管理工具；</li> <li>yarn 是为了弥补 npm 的一些缺陷而出现的；</li> <li>早期的 npm 存在很多的缺陷，比如安装依赖速度很慢、版本依赖混乱等等一系列的问题；</li> <li>虽然从 npm5 版本开始，进行了很多的升级和改进，但是依然很多人喜欢使用 yarn；</li></ul> <p>这里给出一张常用命令的对比</p> <p><strong>补充：cnpm</strong></p> <p>由于一些特殊的原因，某些情况下我们没办法很好的从 <code>https://registry.npmjs.org</code>下载下来一些需要的包。</p> <p>查看 npm 镜像：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm config <span class="token keyword">get</span> registry # npm config <span class="token keyword">get</span> registry
</code></pre></div><p>我们可以直接设置 npm 的镜像：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm config <span class="token keyword">set</span> registry https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npm<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>org
</code></pre></div><p>但是对于大多数人来说（比如我），并不希望将 npm 镜像修改了：</p> <ul><li>第一，不太希望随意修改 npm 原本从官方下来包的渠道；</li> <li>第二，担心某天淘宝的镜像挂了或者不维护了，又要改来改去；</li></ul> <p>这个时候，我们可以使用 cnpm，并且将 cnpm 设置为淘宝的镜像：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install <span class="token operator">-</span>g cnpm <span class="token operator">--</span>registry<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npm<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>org
cnpm config <span class="token keyword">get</span> registry # https<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">r.npm.taobao.org</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p><strong>补充：npx</strong></p> <p>npx 是 npm5.2 之后自带的一个命令。</p> <p>npx 的作用非常多，但是比较常见的是使用它来调用项目中的某个模块的指令。</p> <p>我们以 webpack 为例：</p> <ul><li>全局安装的是 webpack5.1.3</li> <li>项目安装的是 webpack3.6.0</li></ul> <p>如果我在终端执行 <code>webpack --version</code>使用的是哪一个命令呢？</p> <ul><li>显示结果会是 <code>webpack 5.1.3</code>，事实上使用的是全局的，为什么呢？</li> <li>原因非常简单，在当前目录下找不到 webpack 时，就会去全局找，并且执行命令；</li></ul> <p>那么如何使用项目（局部）的 webpack，常见的是两种方式：</p> <ul><li>方式一：明确查找到 node_module 下面的 webpack</li> <li>方式二：在 <code>scripts</code>定义脚本，来执行 webpack；</li></ul> <p>方式一：在终端中使用如下命令（在项目根目录下）</p> <div class="language- extra-class"><pre class="language-text"><code>./node_modules/.bin/webpack --version
</code></pre></div><p>方式二：修改 package.json 中的 scripts</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --version&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>终端中执行：</p> <div class="language- extra-class"><pre class="language-text"><code>npm run webpack
</code></pre></div><p>但是这两种方式都有一点点麻烦，更好的办法是直接使用 npx：</p> <div class="language- extra-class"><pre class="language-text"><code>npx webpack --version
</code></pre></div><p>npx 的原理非常简单，它会到当前目录的 node_modules/.bin 目录下查找对应的命令；</p> <h4 id="_6-2-5-nrm"><a href="#_6-2-5-nrm" class="header-anchor">#</a> 6.2.5.nrm</h4> <p>nrm 是 npm 的镜像源管理工具，很多使用我们使用 npm 下载国外的源文件速度太慢，可以使用 nrm 快速地在 npm 镜像源之间进行切换。</p> <div class="language- extra-class"><pre class="language-text"><code>npm install -g nrm
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>nrm ls <span class="token comment">// 查看可选源</span>
nrm test taobao <span class="token comment">// 测试源响应时间</span>
nrm use taobeo <span class="token comment">// 切换源</span>
nrm add imooc https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx <span class="token comment">// 增加定制源</span>
nrm del imooc <span class="token comment">// 删除定制源</span>

</code></pre></div><h2 id="_07-buffer-的使用"><a href="#_07-buffer-的使用" class="header-anchor">#</a> 07.Buffer 的使用</h2> <h3 id="_7-1-认识-buffer"><a href="#_7-1-认识-buffer" class="header-anchor">#</a> 7.1. 认识 Buffer</h3> <h4 id="_7-1-1-数据的二进制"><a href="#_7-1-1-数据的二进制" class="header-anchor">#</a> 7.1.1. 数据的二进制</h4> <p>计算机中所有的内容：文字、数字、图片、音频、视频最终都会使用二进制来表示。</p> <p>JavaScript 可以直接去处理非常直观的数据：比如字符串，我们通常展示给用户的也是这些内容。</p> <p>不对啊，JavaScript 不是也可以处理图片吗？</p> <ul><li>事实上在网页端，图片我们一直是交给浏览器来处理的；</li> <li>JavaScript 或者 HTML，只是负责告诉浏览器一个图片的地址；</li> <li>浏览器负责获取这个图片，并且最终将这个图片渲染出来；</li></ul> <p>但是对于服务器来说是不一样的：</p> <ul><li>服务器要处理的本地文件类型相对较多;</li> <li>比如某一个保存文本的文件并不是使用 <code>utf-8</code>进行编码的，而是用 <code>GBK</code>，那么我们必须读取到他们的二进制数据，再通过 GKB 转换成对应的文字；</li> <li>比如我们需要读取的是一张图片数据（二进制），再通过某些手段对图片数据进行二次的处理（裁剪、格式转换、旋转、添加滤镜），Node 中有一个 Sharp 的库，就是读取图片或者传入图片的 Buffer 对其再进行处理；</li> <li>比如在 Node 中通过 TCP 建立长连接，TCP 传输的是字节流，我们需要将数据转成字节再进行传入，并且需要知道传输字节的大小（客服端需要根据大小来判断读取多少内容）；</li></ul> <p>我们会发现，对于前端开发来说，通常很少会和二进制打交道，但是对于服务器端为了做很多的功能，我们必须直接去操作其二进制的数据；</p> <p>所以 Node 为了可以方便开发者完成更多功能，提供给了我们一个类 Buffer，并且它是全局的。</p> <h4 id="_7-1-2-buffer-和二进制"><a href="#_7-1-2-buffer-和二进制" class="header-anchor">#</a> 7.1.2. Buffer 和二进制</h4> <p>我们前面说过，Buffer 中存储的是二进制数据，那么到底是如何存储呢？</p> <ul><li>我们可以将 Buffer 看成是一个存储二进制的数组；</li> <li>这个数组中的每一项，可以保存 8 位二进制：<code>00000000</code></li></ul> <p>为什么是 8 位呢？</p> <ul><li>在计算机中，很少的情况我们会直接操作一位二进制，因为一位二进制存储的数据是非常有限的；</li> <li>所以通常会将 8 位合在一起作为一个单元，这个单元称之为一个字节（byte）；</li> <li>也就是说 <code>1byte = 8bit</code>，<code>1kb=1024byte</code>，<code>1M=1024kb</code>;</li> <li>比如很多编程语言中的 int 类型是 4 个字节，long 类型是 8 个字节；</li> <li>比如 TCP 传输的是字节流，在写入和读取时都需要说明字节的个数；</li> <li>比如 RGB 的值分别都是 255，所以本质上在计算机中都是用一个字节存储的；</li></ul> <p>也就是说，Buffer 相当于是一个字节的数组，数组中的每一项对于一个字节的大小：</p> <p>如果我们希望将一个字符串放入到 Buffer 中，是怎么样的过程呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> buffer01 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">&quot;why&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer01<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img">字符串存储 buffer 的过程</p> <p>当然目前已经不希望我们这样来做了：</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img">VSCode 的警告</p> <p>那么我们可以通过另外一个创建方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> buffer2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;why&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果是中文呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> buffer3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;王红元&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &lt;Buffer e7 8e 8b e7 ba a2 e5 85 83&gt;</span>
<span class="token keyword">const</span> str <span class="token operator">=</span> buffer3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 王红元</span>
</code></pre></div><p>如果编码和解码不同：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> buffer3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;王红元&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf16le&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> str <span class="token operator">=</span> buffer3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// �s�~CQ</span>
</code></pre></div><h3 id="_7-2-buffer-其他用法"><a href="#_7-2-buffer-其他用法" class="header-anchor">#</a> 7.2. Buffer 其他用法</h3> <h4 id="_7-2-1-buffer-的其他创建"><a href="#_7-2-1-buffer-的其他创建" class="header-anchor">#</a> 7.2.1. Buffer 的其他创建</h4> <p>Buffer 的创建方式有很多：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e6.png" alt="图片">buffer 的创建</p> <p>来看一下<code>Buffer.alloc</code>:</p> <ul><li>我们会发现创建了一个 8 位长度的 Buffer，里面所有的数据默认为 00；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> buffer01 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer01<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 00 00 00 00 00 00 00 00&gt;</span>
</code></pre></div><p>我们也可以对其进行操作：</p> <div class="language-js extra-class"><pre class="language-js"><code>buffer01<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buffer01<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
buffer01<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer01<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以使用相同的方式来获取：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer01<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer01<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-2-2-buffer-和文件读取"><a href="#_7-2-2-buffer-和文件读取" class="header-anchor">#</a> 7.2.2. Buffer 和文件读取</h4> <p>文本文件的读取：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;./test.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 48 65 6c 6c 6f 20 57 6f 72 6c 64&gt;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello World</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>图片文件的读取：</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;./zznh.jpg&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer ff d8 ff e0 ... 40418 more bytes&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>图片文件的读取和转换：</p> <ul><li>将读取的某一张图片，转换成一张 200x200 的图片；</li> <li>这里我们可以借助于 <code>sharp</code> 库来完成；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sharp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;sharp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">sharp</span><span class="token punctuation">(</span><span class="token string">&quot;./test.png&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./test_copy.png&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_7-4-buffer-的内存分配"><a href="#_7-4-buffer-的内存分配" class="header-anchor">#</a> 7.4. Buffer 的内存分配</h3> <p>事实上我们创建 Buffer 时，并不会频繁的向操作系统申请内存，它会默认先申请一个 8 * 1024 个字节大小的内存，也就是 8kb</p> <ul><li>node/lib/buffer.js：135 行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>Buffer<span class="token punctuation">.</span>poolSize <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> poolSize<span class="token punctuation">,</span> poolOffset<span class="token punctuation">,</span> allocPool<span class="token punctuation">;</span>

<span class="token keyword">const</span> encodingsMap <span class="token operator">=</span> <span class="token function">ObjectCreate</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> encodings<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> encodingsMap<span class="token punctuation">[</span>encodings<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  poolSize <span class="token operator">=</span> Buffer<span class="token punctuation">.</span>poolSize<span class="token punctuation">;</span>
  allocPool <span class="token operator">=</span> <span class="token function">createUnsafeBuffer</span><span class="token punctuation">(</span>poolSize<span class="token punctuation">)</span><span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
  <span class="token function">markAsUntransferable</span><span class="token punctuation">(</span>allocPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poolOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>假如我们调用 Buffer.from 申请 Buffer：</p> <ul><li>这里我们以从字符串创建为例</li> <li>node/lib/buffer.js：290 行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>Buffer<span class="token punctuation">.</span><span class="token function-variable function">from</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> encodingOrOffset<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">fromString</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> encodingOrOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果是对象，另外一种处理情况</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们查看 fromString 的调用：</p> <ul><li>node/lib/buffer.js：428 行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fromString</span><span class="token punctuation">(</span><span class="token parameter">string<span class="token punctuation">,</span> encoding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> ops<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> encoding <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> encoding<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>string<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FastBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops <span class="token operator">=</span> encodingOps<span class="token punctuation">.</span>utf8<span class="token punctuation">;</span>
    encoding <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ops <span class="token operator">=</span> <span class="token function">getEncodingOps</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ops <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_UNKNOWN_ENCODING</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>string<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FastBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">fromStringFast</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着我们查看 fromStringFast：</p> <ul><li>这里做的事情是判断剩余的长度是否还足够填充这个字符串；</li> <li>如果不足够，那么就要通过 <code>createPool</code> 创建新的空间；</li> <li>如果够就直接使用，但是之后要进行 <code>poolOffset</code>的偏移变化；</li> <li>node/lib/buffer.js：428 行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fromStringFast</span><span class="token punctuation">(</span><span class="token parameter">string<span class="token punctuation">,</span> ops</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;=</span> Buffer<span class="token punctuation">.</span>poolSize <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">createFromString</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> ops<span class="token punctuation">.</span>encodingVal<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> poolSize <span class="token operator">-</span> poolOffset<span class="token punctuation">)</span> <span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastBuffer</span><span class="token punctuation">(</span>allocPool<span class="token punctuation">,</span> poolOffset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> string<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>actual <span class="token operator">!==</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// byteLength() may overestimate. That's a rare case, though.</span>
    b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastBuffer</span><span class="token punctuation">(</span>allocPool<span class="token punctuation">,</span> poolOffset<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  poolOffset <span class="token operator">+=</span> actual<span class="token punctuation">;</span>
  <span class="token function">alignPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-4-stream"><a href="#_7-4-stream" class="header-anchor">#</a> 7.4. Stream</h3> <h4 id="_7-4-1-认识-stream"><a href="#_7-4-1-认识-stream" class="header-anchor">#</a> 7.4.1. 认识 Stream</h4> <p>什么是流呢？</p> <ul><li>我们的第一反应应该是流水，源源不断的流动；</li> <li>程序中的流也是类似的含义，我们可以想象当我们从一个文件中读取数据时，文件的二进制（字节）数据会源源不断的被读取到我们程序中；</li> <li>而这个一连串的字节，就是我们程序中的流；</li></ul> <p>所以，我们可以这样理解流：</p> <ul><li>是连续字节的一种表现形式和抽象概念；</li> <li>流应该是可读的，也是可写的；</li></ul> <p>在之前学习文件的读写时，我们可以直接通过 <code>readFile</code>或者 <code>writeFile</code>方式读写文件，为什么还需要流呢？</p> <ul><li>直接读写文件的方式，虽然简单，但是无法控制一些细节的操作；</li> <li>比如从什么位置开始读、读到什么位置、一次性读取多少个字节；</li> <li>读到某个位置后，暂停读取，某个时刻恢复读取等等；</li> <li>或者这个文件非常大，比如一个视频文件，一次性全部读取并不合适；</li></ul> <p>事实上 Node 中很多对象是基于流实现的：</p> <ul><li>http 模块的 Request 和 Response 对象；</li> <li>process.stdout 对象；</li></ul> <p>官方：另外所有的流都是 EventEmitter 的实例：</p> <p>我们可以看一下 Node 源码中有这样的操作：</p> <p>Stream 和 EventEmitter 关系</p> <p>流（Stream）的分类：</p> <ul><li><code>Writable</code>：可以向其写入数据的流（例如 <code>fs.createWriteStream()</code>）。</li> <li><code>Readable</code>：可以从中读取数据的流（例如 <code>fs.createReadStream()</code>）。</li> <li><code>Duplex</code>：同时为<code>Readable</code>和的流<code>Writable</code>（例如 <code>net.Socket</code>）。</li> <li><code>Transform</code>：<code>Duplex</code>可以在写入和读取数据时修改或转换数据的流（例如<code>zlib.createDeflate()</code>）。</li></ul> <p>这里我们通过 fs 的操作，讲解一下 Writable、Readable，另外两个大家可以自行学习一下。</p> <h4 id="_7-4-2-readable"><a href="#_7-4-2-readable" class="header-anchor">#</a> 7.4.2. Readable</h4> <p>之前我们读取一个文件的信息：</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这种方式是一次性将一个文件中所有的内容都读取到程序（内存）中，但是这种读取方式就会出现我们之前提到的很多问题：</p> <ul><li>文件过大、读取的位置、结束的位置、一次读取的大小；</li></ul> <p>这个时候，我们可以使用 <code>createReadStream</code>，我们来看几个参数，更多参数可以参考官网：</p> <ul><li>start：文件读取开始的位置；</li> <li>end：文件读取结束的位置；</li> <li>highWaterMark：一次性读取字节的长度，默认是 64kb；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> read <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们如何获取到数据呢？</p> <ul><li>可以通过监听 data 事件，获取读取到的数据；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们也可以监听其他的事件：</p> <div class="language-js extra-class"><pre class="language-js"><code>read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件被打开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件被关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>甚至我们可以在某一个时刻暂停和恢复读取：</p> <div class="language-js extra-class"><pre class="language-js"><code>read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  read<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    read<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-4-3-writable"><a href="#_7-4-3-writable" class="header-anchor">#</a> 7.4.3. Writable</h4> <p>之前我们写入一个文件的方式是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;内容&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这种方式相当于一次性将所有的内容写入到文件中，但是这种方式也有很多问题：</p> <ul><li>比如我们希望一点点写入内容，精确每次写入的位置等；</li></ul> <p>这个时候，我们可以使用 <code>createWriteStream</code>，我们来看几个参数，更多参数可以参考官网：</p> <ul><li>flags：默认是<code>w</code>，如果我们希望是追加写入，可以使用 <code>a</code>或者 <code>a+</code>；</li> <li>start：写入的位置；</li></ul> <p>我们进行一次简单的写入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> writer <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">&quot;a+&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;你好啊&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;写入成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果我们希望监听一些事件：</p> <div class="language-js extra-class"><pre class="language-js"><code>writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件打开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;finish&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件写入结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们会发现，我们并不能监听到 <code>close</code> 事件：</p> <ul><li>这是因为写入流在打开后是不会自动关闭的；</li> <li>我们必须手动关闭，来告诉 Node 已经写入结束了；</li> <li>并且会发出一个 <code>finish</code> 事件的；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;finish&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件写入结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;文件关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>另外一个非常常用的方法是 <code>end</code>：</p> <ul><li><code>end</code>方法相当于做了两步操作：<code>write</code>传入的数据和调用<code>close</code>方法；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>writer<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-4-4-pipe-方法"><a href="#_7-4-4-pipe-方法" class="header-anchor">#</a> 7.4.4. pipe 方法</h4> <p>正常情况下，我们可以将读取到的 <code>输入流</code>，手动的放到 <code>输出流</code>中进行写入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> read <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs/promises&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> reader <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> writer <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./bar.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

reader<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们也可以通过 pipe 来完成这样的操作：</p> <div class="language-js extra-class"><pre class="language-js"><code>reader<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>

writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;输出流关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_08-深入事件循环"><a href="#_08-深入事件循环" class="header-anchor">#</a> 08.深入事件循环</h2> <blockquote><p>事件循环是什么？事实上我把事件循环理解成我们编写的 JavaScript 和浏览器或者 Node 之间的一个桥梁。</p> <p>浏览器的事件循环是一个我们编写的 JavaScript 代码和浏览器 API 调用(setTimeout/AJAX/监听事件等)的一个桥梁, 桥梁之间他们通过回调函数进行沟通。</p> <p>Node 的事件循环是一个我们编写的 JavaScript 代码和系统调用（file system、network 等）之间的一个桥梁, 桥梁之间他们通过回调函数进行沟通的.</p></blockquote> <h3 id="_8-1-浏览器的事件循环"><a href="#_8-1-浏览器的事件循环" class="header-anchor">#</a> 8.1. 浏览器的事件循环</h3> <h4 id="_8-1-1-进程和线程"><a href="#_8-1-1-进程和线程" class="header-anchor">#</a> 8.1.1.进程和线程</h4> <p>线程和进程是操作系统中的两个概念：</p> <ul><li>进程（process）：计算机已经运行的程序；</li> <li>线程（thread）：操作系统能够运行运算调度的最小单位；</li></ul> <p>听起来很抽象，我们直观一点解释：</p> <ul><li>进程：我们可以认为，启动一个应用程序，就会默认启动一个进程（也可能是多个进程）；</li> <li>线程：每一个进程中，都会启动一个线程用来执行程序中的代码，这个线程被称之为主线程；</li> <li>所以我们也可以说进程是线程的容器；</li></ul> <p>再用一个形象的例子解释：</p> <ul><li>操作系统类似于一个工厂；</li> <li>工厂中里有很多车间，这个车间就是进程；</li> <li>每个车间可能有一个以上的工人在工厂，这个工人就是线程；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e7.png" alt="图片">操作系统、线程、进程</p> <p>操作系统是如何做到同时让多个进程（边听歌、边写代码、边查阅资料）同时工作呢？</p> <ul><li>这是因为 CPU 的运算速度非常快，它可以快速的在多个进程之间迅速的切换；</li> <li>当我们的进程中的线程获取获取到时间片时，就可以快速执行我们编写的代码；</li> <li>对于用于来说是感受不到这种快速的切换的；</li></ul> <p>你可以在 Mac 的活动监视器或者 Windows 的资源管理器中查看到很多进程：</p> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e8.png" alt="图片">活动监视器</p> <h4 id="_8-1-2-浏览器和-javascript"><a href="#_8-1-2-浏览器和-javascript" class="header-anchor">#</a> 8.1.2. 浏览器和 JavaScript</h4> <p>我们经常会说 JavaScript 是单线程的，但是 JavaScript 的线程应该有自己的容器进程：浏览器或者 Node。</p> <p>浏览器是一个进程吗，它里面只有一个线程吗？</p> <ul><li>目前多数的浏览器其实都是多进程的，当我们打开一个 tab 页面时就会开启一个新的进程，这是为了防止一个页面卡死而造成所有页面无法响应，整个浏览器需要强制退出；</li> <li>每个进程中又有很多的线程，其中包括执行 JavaScript 代码的线程；</li></ul> <p>但是 JavaScript 的代码执行是在一个单独的线程中执行的：</p> <ul><li>这就意味着 JavaScript 的代码，在同一个时刻只能做一件事；</li> <li>如果这件事是非常耗时的，就意味着当前的线程就会被阻塞；</li></ul> <p>分析下面代码的执行过程：</p> <ul><li>定义变量 name；</li> <li>执行 log 函数，函数会被放入到调用栈中执行；</li> <li>调用 bar()函数，被压入到调用栈中，但是执行未结束；</li> <li>bar 因为调用了 sum，sum 函数被压入到调用栈中，获取到结果后出栈；</li> <li>bar 获取到结果后出栈，获取到结果 result；</li> <li>将 log 函数压入到调用栈，log 被执行，并且出栈；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 1.将该函数放入到调用栈中被执行</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 调用栈</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_8-1-3-浏览器的事件循环"><a href="#_8-1-3-浏览器的事件循环" class="header-anchor">#</a> 8.1.3. 浏览器的事件循环</h4> <p>如果在执行 JavaScript 代码的过程中，有异步操作呢？</p> <ul><li>中间我们插入了一个 setTimeout 的函数调用；</li> <li>这个函数被放到入调用栈中，执行会立即结束，并不会阻塞后续代码的执行；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;coderwhy&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 1.将该函数放入到调用栈中被执行</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2.调用栈</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;settimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>那么，传入的一个函数（比如我们称之为 timer 函数），会在什么时候被执行呢？</p> <ul><li>事实上，setTimeout 是调用了 web api，在合适的时机，会将 timer 函数加入到一个事件队列中；</li> <li>事件队列中的函数，会被放入到调用栈中，在调用栈中被执行；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/e9.png" alt="图片">浏览器的事件循环</p> <h4 id="_8-1-4-宏任务和微任务"><a href="#_8-1-4-宏任务和微任务" class="header-anchor">#</a> 8.1.4. 宏任务和微任务</h4> <p>但是事件循环中并非只维护着一个队列，事实上是有两个队列：</p> <ul><li>宏任务队列（macrotask queue）：ajax、setTimeout、setInterval、DOM 监听、UI Rendering 等</li> <li>微任务队列（microtask queue）：Promise 的 then 回调、 Mutation Observer API、queueMicrotask()等</li></ul> <p>那么事件循环对于两个队列的优先级是怎么样的呢？</p> <ul><li><p>1.main script 中的代码优先执行（编写的顶层 script 代码）；</p></li> <li><p>2.在执行任何一个宏任务之前（不是队列，是一个宏任务），都会先查看微任务队列中是否有任务需要执行</p></li> <li><ul><li>也就是宏任务执行之前，必须保证微任务队列是空的；</li> <li>如果不为空，那么就优先执行微任务队列中的任务（回调）；</li></ul></li></ul> <p>我们来看一个面试题：执行结果如何？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;set1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;then4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;then2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;pr1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;then1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;set2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;queueMicrotask1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;then3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行结果：</p> <div class="language- extra-class"><pre class="language-text"><code>pr1
2
then1
queueMicrotask1
then3
set1
then2
then4
set2
</code></pre></div><p>async、await 是 Promise 的一个语法糖：</p> <ul><li>我们可以将 await 关键字后面执行的代码，看做是包裹在<code>(resolve, reject) =&gt; {函数执行}</code>中的代码；</li> <li>await 的下一条语句，可以看做是<code>then(res =&gt; {函数执行})</code>中的代码；</li></ul> <p>今日头条的面试题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async1 start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async1 end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;script start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;script end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>script start
async1 start
async2
promise1
script end
async1 end
promise2
setTimeout
</code></pre></div><h3 id="_8-2-node-的事件循环"><a href="#_8-2-node-的事件循环" class="header-anchor">#</a> 8.2.Node 的事件循环</h3> <h4 id="_8-2-1-node-的事件循环"><a href="#_8-2-1-node-的事件循环" class="header-anchor">#</a> 8.2.1. Node 的事件循环</h4> <p>浏览器中的 EventLoop 是根据 HTML5 定义的规范来实现的，不同的浏览器可能会有不同的实现，而 Node 中是由 libuv 实现的。</p> <p>我们来看在很早就给大家展示的 Node 架构图：</p> <ul><li>我们会发现 libuv 中主要维护了一个 EventLoop 和 worker threads（线程池）；</li> <li>EventLoop 负责调用系统的一些其他操作：文件的 IO、Network、child-processes 等</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f1.png" alt="图片">Node 的架构图</p> <p>libuv 到底是什么呢？</p> <ul><li>libuv is a multi-platform support library with a focus on asynchronous I/O. It was primarily developed for use by Node.js, but it's also used by Luvit, Julia, pyuv, and others.</li> <li>libuv 是一个多平台的专注于异步 IO 的库，它最初是为 Node 开发的，但是现在也被使用到 Luvit、Julia、pyuv 等其他地方；</li></ul> <p>libuv 到底帮助我们做了什么事情呢？</p> <ul><li>我们以文件操作为例，来讲解一下它内部的结构；</li></ul> <h4 id="_8-2-2-阻塞-io-和非阻塞-io"><a href="#_8-2-2-阻塞-io-和非阻塞-io" class="header-anchor">#</a> 8.2.2. 阻塞 IO 和非阻塞 IO</h4> <p>如果我们希望在程序中对一个文件进行操作，那么我们就需要打开这个文件：通过文件描述符。</p> <ul><li>我们思考：JavaScript 可以直接对一个文件进行操作吗？</li> <li>看起来是可以的，但是事实上我们任何程序中的文件操作都是需要进行系统调用（操作系统封装了文件系统）；</li> <li>事实上对文件的操作，是一个操作系统的 IO 操作（输入、输出）；</li></ul> <p>操作系统为我们提供了<code>阻塞式调用</code>和<code>非阻塞式调用</code>：</p> <ul><li><strong>阻塞式调用：</strong> 调用结果返回之前，当前线程处于阻塞态（阻塞态 CPU 是不会分配时间片的），调用线程只有在得到调用结果之后才会继续执行。</li> <li><strong>非阻塞式调用：</strong> 调用执行之后，当前线程不会停止执行，只需要过一段时间来检查一下有没有结果返回即可。</li></ul> <p>所以我们开发中的很多耗时操作，都可以基于这样的 <code>非阻塞式调用</code>：</p> <ul><li>比如网络请求本身使用了 Socket 通信，而 Socket 本身提供了 select 模型，可以进行<code>非阻塞方式的工作</code>；</li> <li>比如文件读写的 IO 操作，我们可以使用操作系统提供的<code>基于事件的回调机制</code>；</li></ul> <p>但是非阻塞 IO 也会存在一定的问题：我们并没有获取到需要读取（我们以读取为例）的结果</p> <ul><li>那么就意味着为了可以知道是否读取到了完整的数据，我们需要频繁的去确定读取到的数据是否是完整的；</li> <li>这个过程我们称之为轮训操作；</li></ul> <p>那么这个轮训的工作由谁来完成呢？</p> <ul><li>如果我们的主线程频繁的去进行轮训的工作，那么必然会大大降低性能；</li> <li>并且开发中我们可能不只是一个文件的读写，可能是多个文件；</li> <li>而且可能是多个功能：网络的 IO、数据库的 IO、子进程调用；</li></ul> <p>libuv 提供了一个线程池（Thread Pool）：</p> <ul><li>线程池会负责所有相关的操作，并且会通过轮训等方式等待结果；</li> <li>当获取到结果时，就可以将对应的回调放到事件循环（某一个事件队列）中；</li> <li>事件循环就可以负责接管后续的回调工作，告知 JavaScript 应用程序执行对应的回调函数；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f2.png" alt="图片">Event loop in node.js</p> <p>阻塞和非阻塞，同步和异步有什么区别？</p> <ul><li><p>阻塞和非阻塞是对于被调用者来说的；</p></li> <li><ul><li>在我们这里就是系统调用，操作系统为我们提供了阻塞调用和非阻塞调用；</li></ul></li> <li><p>同步和异步是对于调用者来说的；</p></li> <li><ul><li>在我们这里就是自己的程序；</li> <li>如果我们在发起调用之后，不会进行其他任何的操作，只是等待结果，这个过程就称之为同步调用；</li> <li>如果我们再发起调用之后，并不会等待结果，继续完成其他的工作，等到有回调时再去执行，这个过程就是异步调用；</li></ul></li></ul> <h4 id="_8-2-3-node-事件循环的阶段"><a href="#_8-2-3-node-事件循环的阶段" class="header-anchor">#</a> 8.2.3. Node 事件循环的阶段</h4> <p>我们最前面就强调过，事件循环像是一个桥梁，是连接着应用程序的 JavaScript 和系统调用之间的通道：</p> <ul><li>无论是我们的文件 IO、数据库、网络 IO、定时器、子进程，在完成对应的操作后，都会将对应的结果和回调函数放到事件循环（任务队列）中；</li> <li>事件循环会不断的从任务队列中取出对应的事件（回调函数）来执行；</li></ul> <p>但是一次完整的事件循环 Tick 分成很多个阶段：</p> <ul><li><strong>定时器（Timers）</strong>：本阶段执行已经被 <code>setTimeout()</code> 和 <code>setInterval()</code> 的调度回调函数。</li> <li><strong>待定回调（Pending Callback）</strong>：对某些系统操作（如 TCP 错误类型）执行回调，比如 TCP 连接时接收到 ECONNREFUSED。</li> <li><strong>idle, prepare</strong>：仅系统内部使用。</li> <li><strong>轮询（Poll）</strong>：检索新的 I/O 事件；执行与 I/O 相关的回调；</li> <li><strong>检测</strong>：<code>setImmediate()</code> 回调函数在这里执行。</li> <li><strong>关闭的回调函数</strong>：一些关闭的回调函数，如：<code>socket.on('close', ...)</code>。</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f3.png" alt="图片">一次 tick 的事件循环阶段</p> <p>我们会发现从一次事件循环的 Tick 来说，Node 的事件循环更复杂，它也分为微任务和宏任务：</p> <ul><li>宏任务（macrotask）：setTimeout、setInterval、IO 事件、setImmediate、close 事件；</li> <li>微任务（microtask）：Promise 的 then 回调、process.nextTick、queueMicrotask；</li></ul> <p>但是，Node 中的事件循环不只是 <code>微任务队列</code>和 <code>宏任务队列</code>：</p> <ul><li><p>微任务队列：</p></li> <li><ul><li>next tick queue：process.nextTick；</li> <li>other queue：Promise 的 then 回调、queueMicrotask；</li></ul></li> <li><p>宏任务队列：</p></li> <li><ul><li>timer queue：setTimeout、setInterval；</li> <li>poll queue：IO 事件；</li> <li>check queue：setImmediate；</li> <li>close queue：close 事件；</li></ul></li></ul> <p>所以，在每一次事件循环的 tick 中，会按照如下顺序来执行代码：</p> <ul><li>next tick microtask queue；</li> <li>other microtask queue；</li> <li>timer queue；</li> <li>poll queue；</li> <li>check queue；</li> <li>close queue；</li></ul> <h4 id="_8-2-4-node-代码执行面试"><a href="#_8-2-4-node-代码执行面试" class="header-anchor">#</a> 8.2.4. Node 代码执行面试</h4> <p>面试题一：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async1 start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async1 end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;script start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;script end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>script start
async1 start
async2
promise1
promise2
script end
nextTick
async1 end
promise3

setTimeout0
setImmediate
setTimeout2
</code></pre></div><p>面试题二：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行结果：</p> <div class="language- extra-class"><pre class="language-text"><code>情况一：
setTimeout
setImmediate

情况二：
setImmediate
setTimeout
</code></pre></div><p>为什么会出现不同的情况呢？</p> <ul><li>在 Node 源码的 deps/uv/src/timer.c 中 141 行，有一个 <code>uv__next_timeout</code>的函数；</li> <li>这个函数决定了，poll 阶段要不要阻塞在这里；</li> <li>阻塞在这里的目的是当有异步 IO 被处理时，尽可能快的让代码被执行；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>int <span class="token function">uv__next_timeout</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> uv_loop_t<span class="token operator">*</span> loop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> struct heap_node<span class="token operator">*</span> heap_node<span class="token punctuation">;</span>
  <span class="token keyword">const</span> uv_timer_t<span class="token operator">*</span> handle<span class="token punctuation">;</span>
  uint64_t diff<span class="token punctuation">;</span>

  <span class="token comment">// 计算距离当前时间节点最小的计时器</span>
  heap_node <span class="token operator">=</span> <span class="token function">heap_min</span><span class="token punctuation">(</span><span class="token function">timer_heap</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果为空, 那么返回-1,表示为阻塞状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>heap_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* block indefinitely */</span>

  <span class="token comment">// 如果计时器的时间小于当前loop的开始时间, 那么返回0</span>
  <span class="token comment">// 继续执行后续阶段, 并且开启下一次tick</span>
  handle <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>heap_node<span class="token punctuation">,</span> uv_timer_t<span class="token punctuation">,</span> heap_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-</span><span class="token operator">&gt;</span>timeout <span class="token operator">&lt;=</span> loop<span class="token operator">-</span><span class="token operator">&gt;</span>time<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果不大于loop的开始时间, 那么会返回时间差</span>
  diff <span class="token operator">=</span> handle<span class="token operator">-</span><span class="token operator">&gt;</span>timeout <span class="token operator">-</span> loop<span class="token operator">-</span><span class="token operator">&gt;</span>time<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&gt;</span> <span class="token constant">INT_MAX</span><span class="token punctuation">)</span>
    diff <span class="token operator">=</span> <span class="token constant">INT_MAX</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> diff<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和上面有什么关系呢？</p> <ul><li><p>情况一：如果事件循环开启的时间(ms)是小于 <code>setTimeout</code>函数的执行时间的；</p></li> <li><ul><li>也就意味着先开启了 event-loop，但是这个时候执行到 timer 阶段，并没有定时器的回调被放到入 timer queue 中；</li> <li>所以没有被执行，后续开启定时器和检测到有 setImmediate 时，就会跳过 poll 阶段，向后继续执行；</li> <li>这个时候是先检测 <code>setImmediate</code>，第二次的 tick 中执行了 timer 中的 <code>setTimeout</code>；</li></ul></li> <li><p>情况二：如果事件循环开启的时间(ms)是大于 <code>setTimeout</code>函数的执行时间的；</p></li> <li><ul><li>这就意味着在第一次 tick 中，已经准备好了 timer queue；</li> <li>所以会直接按照顺序执行即可；</li></ul></li></ul> <h2 id="_09-http-开发-web-服务器"><a href="#_09-http-开发-web-服务器" class="header-anchor">#</a> 09.http 开发 web 服务器</h2> <blockquote><p>什么是 Web 服务器？</p> <p>当应用程序（客户端）需要某一个资源时，可以向一个台服务器，通过 Http 请求获取到这个资源；提供服务器的这个服务器，就是一个 Web 服务器；</p></blockquote> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f4.png" alt="图片">Web 服务器</p> <p>目前有很多开源的 Web 服务器：Nginx、Apache（静态）、Apache Tomcat（静态、动态）、Node.js</p> <h3 id="一-http-模板基本使用"><a href="#一-http-模板基本使用" class="header-anchor">#</a> 一. Http 模板基本使用</h3> <h4 id="_1-1-如何创建服务"><a href="#_1-1-如何创建服务" class="header-anchor">#</a> 1.1. 如何创建服务</h4> <h5 id="_1-1-1-web-服务器初体验"><a href="#_1-1-1-web-服务器初体验" class="header-anchor">#</a> 1.1.1. Web 服务器初体验</h5> <p>创建一个 Web 服务器的初体验：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">HTTP_PORT</span> <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">🚀服务器在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">HTTP_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">启动~</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-1-2-创建服务器"><a href="#_1-1-2-创建服务器" class="header-anchor">#</a> 1.1.2. 创建服务器</h5> <p>创建服务器对象，我们是通过 <code>createServer</code> 来完成的</p> <ul><li><code>http.createServer</code>会返回服务器的对象；</li> <li>底层其实使用直接 new Server 对象。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token parameter">opts<span class="token punctuation">,</span> requestListener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> requestListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么，当然，我们也可以自己来创建这个对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Server2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server2<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器启动成功~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面我们已经看到，创建 Server 时会传入一个回调函数，这个回调函数在被调用时会传入两个参数：</p> <ul><li>req：request 请求对象，包含请求相关的信息；</li> <li>res：response 响应对象，包含我们要发送给客户端的信息；</li></ul> <h5 id="_1-1-3-监听端口和主机"><a href="#_1-1-3-监听端口和主机" class="header-anchor">#</a> 1.1.3. 监听端口和主机</h5> <p><strong>Server</strong>通过 listen 方法来开启服务器，并且在某一个主机和端口上监听网络请求：</p> <ul><li>也就是当我们通过 <code>ip:port</code>的方式发送到我们监听的 Web 服务器上时；</li> <li>我们就可以对其进行相关的处理；</li></ul> <p><code>listen</code>函数有三个参数：</p> <ul><li><p>端口 port: 可以不传, 系统会默认分配端, 后续项目中我们会写入到环境变量中；</p></li> <li><p>主机 host: 通常可以传入 localhost、ip 地址 127.0.0.1、或者 ip 地址 0.0.0.0，默认是 0.0.0.0；</p></li> <li><ul><li>监听 IPV4 上所有的地址，再根据端口找到不同的应用程序；</li> <li>比如我们监听 <code>0.0.0.0</code>时，在同一个网段下的主机中，通过 ip 地址是可以访问的；</li> <li>正常的数据库包经常 应用层 - 传输层 - 网络层 - 数据链路层 - 物理层 ；</li> <li>而回环地址，是在网络层直接就被获取到了，是不会经常数据链路层和物理层的；</li> <li>比如我们监听 <code>127.0.0.1</code>时，在同一个网段下的主机中，通过 ip 地址是不能访问的；</li> <li>localhost：本质上是一个域名，通常情况下会被解析成 127.0.0.1；</li> <li>127.0.0.1：回环地址（Loop Back Address），表达的意思其实是我们主机自己发出去的包，直接被自己接收；</li> <li>0.0.0.0：</li></ul></li> <li><p>回调函数：服务器启动成功时的回调函数；</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器启动~🚀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-2-request-请求对象"><a href="#_1-2-request-请求对象" class="header-anchor">#</a> 1.2. request 请求对象</h4> <p>在向服务器发送请求时，我们会携带很多信息，比如：</p> <ul><li>本次请求的 URL，服务器需要根据不同的 URL 进行不同的处理；</li> <li>本次请求的请求方式，比如 GET、POST 请求传入的参数和处理的方式是不同的；</li> <li>本次请求的 headers 中也会携带一些信息，比如客户端信息、接受数据的格式、支持的编码格式等；</li> <li>等等...</li></ul> <p>这些信息，Node 会帮助我们封装到一个 request 的对象中，我们可以直接来处理这个 request 对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// request对象</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-2-1-url-的处理"><a href="#_1-2-1-url-的处理" class="header-anchor">#</a> 1.2.1. URL 的处理</h5> <p>客户端在发送请求时，会请求不同的数据，那么会传入不同的请求地址：</p> <ul><li>比如 <code>http://localhost:8000/login</code>；</li> <li>比如 <code>http://localhost:8000/products</code>;</li></ul> <p>服务器端需要根据不同的请求地址，作出不同的响应：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;welcome Back~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">&quot;/products&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;error message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>那么如果用户发送的地址中还携带一些额外的参数呢？</p> <ul><li><code>http://localhost:8000/login?name=why&amp;password=123</code>;</li> <li>这个时候，url 的值是 <code>/login?name=why&amp;password=123</code>；</li></ul> <p>我们如何对它进行解析呢？</p> <ul><li>使用内置模块 url；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 解析请求</span>
<span class="token keyword">const</span> parseInfo <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>parseInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>解析结果：</p> <div class="language-js extra-class"><pre class="language-js"><code>Url <span class="token punctuation">{</span>
  <span class="token literal-property property">protocol</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">slashes</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">auth</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hostname</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hash</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">search</span><span class="token operator">:</span> <span class="token string">'?name=why&amp;password=123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token string">'name=why&amp;password=123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pathname</span><span class="token operator">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/login?name=why&amp;password=123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token string">'/login?name=why&amp;password=123'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们会发现 <code>pathname</code>就是我们想要的结果。</p> <p>但是 <code>query</code> 信息如何可以获取呢？</p> <ul><li>方式一：截取字符串；</li> <li>方式二：使用 querystring 内置模块；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> query <span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> queryObj <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queryObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queryObj<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-2-2-method-的处理"><a href="#_1-2-2-method-的处理" class="header-anchor">#</a> 1.2.2. Method 的处理</h5> <p>在 Restful 规范（设计风格）中，我们对于数据的增删改查应该通过不同的请求方式：</p> <ul><li>GET：查询数据；</li> <li>POST：新建数据；</li> <li>PATCH：更新数据；</li> <li>DELETE：删除数据；</li></ul> <p>所以，我们可以通过判断不同的请求方式进行不同的处理。</p> <p>比如创建一个用户：</p> <ul><li>请求接口为 <code>/users</code>；</li> <li>请求方式为 <code>POST</code>请求；</li> <li>携带数据 <code>username</code>和<code>password</code>；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f5.png" alt="图片">创建用户请求</p> <p>在我们程序中如何进行判断以及获取对应的数据呢？</p> <ul><li>这里我们需要判断接口是 <code>/users</code>，并且请求方式是 POST 方法去获取传入的数据；</li> <li>获取这种 body 携带的数据，我们需要通过监听 req 的 <code>data</code>事件来获取；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以设置编码，也可以在下方通过 data.toString() 获取字符串格式</span>
    req<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;create user success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;users list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;error message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将 JSON 字符串格式转成对象类型，通过<code>JSON.parse</code>方法即可。</p> <h5 id="_1-2-3-header-属性"><a href="#_1-2-3-header-属性" class="header-anchor">#</a> 1.2.3. header 属性</h5> <p>在 request 对象的 header 中也包含很多有用的信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Header&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>浏览器会默认传递过来一些信息：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  'content-type': 'application/json',
  'user-agent': 'PostmanRuntime/7.26.5',
  accept: '*/*',
  'postman-token': 'afe4b8fe-67e3-49cc-bd6f-f61c95c4367b',
  host: 'localhost:8000',
  'accept-encoding': 'gzip, deflate, br',
  connection: 'keep-alive',
  'content-length': '48'
}
</code></pre></div><p><code>content-type</code>是这次请求携带的数据的类型：</p> <ul><li><code>application/json</code>表示是一个 json 类型；</li> <li><code>text/plain</code>表示是文本类型；</li> <li><code>application/xml</code>表示是 xml 类型；</li> <li><code>multipart/form-data</code>表示是上传文件；</li></ul> <p><code>content-length</code>：</p> <ul><li>文件的大小和长度</li></ul> <p><code>keep-alive</code>：</p> <ul><li><p>http 是基于 TCP 协议的，但是通常在进行一次请求和响应结束后会立刻中断；</p></li> <li><p>在 http1.0 中，如果想要继续保持连接：</p></li> <li><ul><li>浏览器需要在请求头中添加 <code>connection: keep-alive</code>；</li> <li>服务器需要在响应头中添加 <code>connection:keey-alive</code>；</li> <li>当客户端再次放请求时，就会使用同一个连接，直接一方中断连接；</li></ul></li> <li><p>在 http1.1 中，所有连接默认是 <code>connection: keep-alive</code>的；</p></li> <li><ul><li>不同的 Web 服务器会有不同的保持 <code>keep-alive</code>的时间；</li> <li>Node 中默认是 5s 中；</li></ul></li></ul> <p><code>accept-encoding</code>：</p> <ul><li>告知服务器，客户端支持的文件压缩格式，比如 js 文件可以使用 gzip 编码，对应 <code>.gz</code>文件；</li></ul> <p><code>accept</code>：</p> <ul><li>告知服务器，客户端可接受文件的格式类型；</li></ul> <p><code>user-agent</code>：</p> <ul><li>客户端相关的信息；</li></ul> <h4 id="_1-3-响应对象-response"><a href="#_1-3-响应对象-response" class="header-anchor">#</a> 1.3. 响应对象 response</h4> <h5 id="_1-3-1-返回响应结果"><a href="#_1-3-1-返回响应结果" class="header-anchor">#</a> 1.3.1. 返回响应结果</h5> <p>如果我们希望给客户端响应的结果数据，可以通过两种方式：</p> <ul><li>Write 方法：这种方式是直接写出数据，但是并没有关闭流；</li> <li>end 方法：这种方式是写出最后的数据，并且写出后会关闭流；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 响应数据的方式有两个:</span>
  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;message end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器启动🚀~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果我们没有调用 <code>end</code>和<code>close</code>，客户端将会一直等待结果，所以客户端在发送网络请求时，都会设置超时时间。</p> <h5 id="_1-3-2-返回状态码"><a href="#_1-3-2-返回状态码" class="header-anchor">#</a> 1.3.2. 返回状态码</h5> <p>Http 状态码（Http Status Code）是用来表示 Http 响应状态的数字代码：</p> <ul><li>Http 状态码非常多，可以根据不同的情况，给客户端返回不同的状态码；</li> <li>常见的状态码是下面这些（后续项目中，也会用到其中的状态码）；</li></ul> <p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f6.png" alt="图片">状态码</p> <p>设置状态码常见的有两种方式：</p> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-3-3-响应头文件"><a href="#_1-3-3-响应头文件" class="header-anchor">#</a> 1.3.3. 响应头文件</h5> <p>返回头部信息，主要有两种方式：</p> <ul><li><code>res.setHeader</code>：一次写入一个头部信息；</li> <li><code>res.writeHead</code>：同时写入 header 和 status；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Header 设置 <code>Content-Type</code>有什么作用呢？</p> <ul><li>默认客户端接收到的是字符串，客户端会按照自己默认的方式进行处理；</li></ul> <p>比如，我们返回的是一段 HTML，但是没有指定格式：</p> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;h2&gt;Hello World&lt;/h2&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f7.png" alt="图片">image-20201030154312050</p> <p>但是，如果我们指定了格式：</p> <div class="language- extra-class"><pre class="language-text"><code>res.setHeader(&quot;Content-Type&quot;, &quot;text/html;charset=utf8&quot;);
res.end('&lt;h2&gt;Hello World&lt;/h2&gt;')
</code></pre></div><p><img src="https://beelz.oss-cn-beijing.aliyuncs.com/blog/imgs/f9.png" alt="图片">image-20201030154404172</p> <p>如果我们希望返回一段 JSON 数据，应该怎么做呢？</p> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;王红元&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1.88</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="二-web-其他补充"><a href="#二-web-其他补充" class="header-anchor">#</a> 二. Web 其他补充</h3> <h4 id="_2-1-文件上传的使用"><a href="#_2-1-文件上传的使用" class="header-anchor">#</a> 2.1. 文件上传的使用</h4> <p>如果是一个很大的文件需要上传到服务器端，服务器端进行保存应该如何操作呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&quot;/upload&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fileWriter <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fileWriter<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> fileSize <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;content-length&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> curSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        curSize <span class="token operator">+=</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>curSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件上传进度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>curSize <span class="token operator">/</span> fileSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;文件上传完成~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;error message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个时候我们发现文件上传成功了，但是文件却打不开：</p> <ul><li>这是因为我们写入的数据，里面包含一些特殊的信息；</li> <li>这些信息打开的软件并不能很好的解析；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&quot;/upload&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 图片文件必须设置为二进制的</span>
      req<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;binary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 获取content-type中的boundary的值</span>
      <span class="token keyword">var</span> boundary <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;boundary=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录当前数据的信息</span>
      <span class="token keyword">const</span> fileSize <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;content-length&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> curSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

      <span class="token comment">// 监听当前的数据</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        curSize <span class="token operator">+=</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件上传进度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>curSize <span class="token operator">/</span> fileSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        body <span class="token operator">+=</span> data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 数据结构</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 切割数据</span>
        <span class="token keyword">const</span> payload <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取最后的类型(image/png)</span>
        <span class="token keyword">const</span> fileType <span class="token operator">=</span> payload<span class="token punctuation">[</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取要截取的长度</span>
        <span class="token keyword">const</span> fileTypePosition <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fileType<span class="token punctuation">)</span> <span class="token operator">+</span> fileType<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">let</span> binaryData <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileTypePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        binaryData <span class="token operator">=</span> binaryData<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s\s*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// binaryData = binaryData.replaceAll('\r\n', '');</span>
        <span class="token keyword">const</span> finalData <span class="token operator">=</span> binaryData<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>
          <span class="token number">0</span><span class="token punctuation">,</span>
          binaryData<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;--&quot;</span> <span class="token operator">+</span> boundary <span class="token operator">+</span> <span class="token string">&quot;--&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">&quot;./boo.png&quot;</span><span class="token punctuation">,</span> finalData<span class="token punctuation">,</span> <span class="token string">&quot;binary&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;文件上传完成~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;error message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-2-http-发送网络请求"><a href="#_2-2-http-发送网络请求" class="header-anchor">#</a> 2.2. http 发送网络请求</h4> <p>axios 库可以在浏览器中使用，也可以在 Node 中使用：</p> <ul><li>在浏览器中，axios 使用的是封装 xhr；</li> <li>在 Node 中，使用的是 http 内置模块；</li></ul> <p>所以 http 模块是可以在 Node 中直接发送网络请求的。</p> <p>发送 get 请求：</p> <div class="language-js extra-class"><pre class="language-js"><code>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8000&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>发送 post 请求：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">hostname</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_10-登录和-session-cookie"><a href="#_10-登录和-session-cookie" class="header-anchor">#</a> 10.登录和 session-cookie</h2> <h3 id="_10-1-邂逅-session-cookie"><a href="#_10-1-邂逅-session-cookie" class="header-anchor">#</a> 10.1.邂逅 session-cookie</h3> <h4 id="_10-1-1-为什么需要登录凭证"><a href="#_10-1-1-为什么需要登录凭证" class="header-anchor">#</a> 10.1.1.为什么需要登录凭证？</h4> <p>web 开发中，我们使用最多的协议是 http，但是 http 是一个无状态的协议，每个 http 请求都是独立的，因此即使是同一个用户的多次连续请求，服务端也无法识别此用户的身份。所以我们必须得有个办法证明我们登录过。</p> <h4 id="_10-1-2-认识-cookie"><a href="#_10-1-2-认识-cookie" class="header-anchor">#</a> 10.1.2.认识 cookie</h4> <ul><li><p>Cookie（复数形态 Cookies），又称为“小甜饼”。类型为“小型文本文件，某些网站为了辨别用户身份而存储在用户本地终端（Client Side）上的数据。</p> <ul><li>浏览器会在特定的情况下携带上 cookie 来发送请求，我们可以通过 cookie 来获取一些信息；</li></ul></li> <li><p>Cookie 总是保存在客户端中，按在客户端中的存储位置，Cookie 可以分为内存 Cookie 和硬盘 Cookie。</p> <ul><li>内存 Cookie 由浏览器维护，保存在内存中，浏览器关闭时 Cookie 就会消失，其存在时间是短暂的；</li> <li>硬盘 Cookie 保存在硬盘中，有一个过期时间，用户手动清理或者过期时间到时，才会被清理；</li></ul></li> <li><p>如果判断一个 cookie 是内存 cookie 还是硬盘 cookie 呢？</p> <ul><li>没有设置过期时间，默认情况下 cookie 是内存 cookie，在关闭浏览器时会自动删除；</li> <li>有设置过期时间，并且过期时间不为 0 或者负数的 cookie，是硬盘 cookie，需要手动或者到期时，才会删除；</li></ul></li></ul> <h4 id="_10-1-3-cookie-常见的属性"><a href="#_10-1-3-cookie-常见的属性" class="header-anchor">#</a> 10.1.3.cookie 常见的属性</h4> <p><strong>cookie 的生命周期：</strong></p> <ul><li>默认情况下（即未设置过期时间）的 cookie 是内存 cookie，也称之为会话 cookie，也就是在浏览器关闭时会自动被删除；</li> <li>我们可以通过设置 expires 或者 max-age 来设置过期的时间；
<ul><li>expires：设置的是 Date.toUTCString()，设置格式是;expires=date-in-GMTString-format；</li> <li>max-age：设置过期的秒钟，;max-age=max-age-in-seconds (例如一年为 60<em>60</em>24*365)；</li></ul></li> <li>cookie 的作用域：（允许 cookie 发送给哪些 URL）
<ul><li>Domain：指定哪些主机可以接受 cookie
<ul><li>如果不指定，那么默认是 origin，不包括子域名。</li> <li>如果指定 Domain，则包含子域名。例如，如果设置 Domain=mozilla.org，则 Cookie 也包含在子域名中（如 developer.mozilla.org）。</li></ul></li> <li>Path：指定主机下哪些路径可以接受 cookie
<ul><li>例如，设置 Path=/docs，则以下地址都会匹配：p/docsp/docs/Web/p/docs/Web/HTTP</li></ul></li></ul></li></ul> <h4 id="_10-1-4-客户端设置-cookie"><a href="#_10-1-4-客户端设置-cookie" class="header-anchor">#</a> 10.1.4.客户端设置 cookie</h4> <p>js 直接设置和获取 cookie：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个 cookie 会在会话关闭时被删除掉；</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">&quot;name=coderwhy&quot;</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">&quot;age=18&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>设置 cookie，同时设置过期时间（默认单位是秒钟）服务器设置 cookie</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">&quot;name=coderwhy;max-age=10&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_10-1-5-服务端设置-cookie"><a href="#_10-1-5-服务端设置-cookie" class="header-anchor">#</a> 10.1.5.服务端设置 cookie</h4> <p>Koa 中默认支持直接操作 cookie</p> <ul><li>/test 请求中设置 cookiep</li> <li>/demo 请求中获取 cookie</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">prefix</span><span class="token operator">:</span> <span class="token string">&quot;/user&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

userRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chh&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

userRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/demo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cookie值为：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>服务端 maxAge 的单位为毫秒，客户端 max-age 单位为秒</p></blockquote> <h4 id="_10-1-6-认识-session"><a href="#_10-1-6-认识-session" class="header-anchor">#</a> 10.1.6.认识 session</h4> <h4 id="_10-1-7-服务端设置-session"><a href="#_10-1-7-服务端设置-session" class="header-anchor">#</a> 10.1.7.服务端设置 session</h4> <p>在 koa 中，我们可以借助于 koa-session 来实现 session 认证</p> <p><code>npm instal koa-session</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> koaSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">prefix</span><span class="token operator">:</span> <span class="token string">&quot;/user&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">koaSession</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;sessionid&quot;</span><span class="token punctuation">,</span> <span class="token comment">// cookie的key</span>
    <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 过期时间</span>
    <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 不允许通过js获取cookie</span>
    <span class="token literal-property property">rolling</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 每次响应时，刷新session的有效期</span>
    <span class="token literal-property property">signed</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否使用signed签名认证，防止数据被篡改</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  app
<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// session加盐</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span>
    name <span class="token operator">=</span> chh<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/demo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-2-邂逅-token"><a href="#_10-2-邂逅-token" class="header-anchor">#</a> 10.2.邂逅 token</h3> <h4 id="_10-2-1-cookie-和-session-的缺点"><a href="#_10-2-1-cookie-和-session-的缺点" class="header-anchor">#</a> 10.2.1.cookie 和 session 的缺点：</h4> <ol><li>Cookie 会被附加在每个 HTTP 请求中，所以无形中增加了流量（事实上某些请求是不需要的）</li> <li>Cookie 是明文传递的，所以存在安全性的问题</li> <li>Cookie 的大小限制是 4KB，对于复杂的需求来说是不够的</li> <li>对于浏览器外的其他客户端（比如 iOS、Android），必须手动的设置 cookie 和 session</li> <li>在分布式系统和服务器集群中线保证其他系统也可以正确的解析 session 是比较麻烦的</li></ol> <h4 id="_10-2-2-认识-token"><a href="#_10-2-2-认识-token" class="header-anchor">#</a> 10.2.2.认识 token</h4> <p>所以，在目前的前后端分离的开发过程中，使用 token 来进行身份验证的是最多的情况：</p> <ul><li>token 可以翻译为令牌；也就是在验证了用户账号和密码正确的情况，给用户颁发一个令牌；</li> <li>这个令牌作为后续用户访问一些接口或者资源的凭证；</li> <li>我们可以根据这个凭证来判断用户是否有权限来访问；</li></ul> <p>token 的使用应该分成两个重要的步骤：</p> <ul><li>生成 token：登录的时候，颁发 token；</li> <li>验证 token：访问某些资源或者接口时，验证 token；</li></ul> <h4 id="_10-2-3-jwt-实现-token-机制"><a href="#_10-2-3-jwt-实现-token-机制" class="header-anchor">#</a> 10.2.3.JWT 实现 Token 机制</h4> <p>JWT 生成的 Token 由三部分组成</p> <ol><li>header
<ul><li>alg：采用的加密算法，默认是 HMAC SHA256（HS256），采用同一个密钥进行加密和解密；</li> <li>typ：JWT，固定值，通常都写成 JWT 即可；</li> <li>会通过 base64Url 算法进行编码；</li></ul></li> <li>payload
<ul><li>携带的数据，比如我们可以将用户的 id 和 name 放到 payload 中</li> <li>默认也会携带 iat（issued at），令牌的签发时间；</li> <li>我们也可以设置过期时间：exp（expiration time）；</li> <li>会通过 base64Url 算法进行编码</li></ul></li> <li>signature
<ul><li>设置一个 secretKey，通过将前两个的结果合并后进行 HMACSHA256 的算法；</li> <li>HMACSHA256(base64Url(header)+.+base64Url(payload), secretKey);</li> <li>但是如果 secretKey 暴露是一件非常危险的事情，因为之后就可以模拟颁发 token，也可以解密 token；</li></ul></li></ol> <h4 id="_10-2-4-token-的使用"><a href="#_10-2-4-token-的使用" class="header-anchor">#</a> 10.2.4.token 的使用</h4></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.984fdec4.js" defer></script><script src="/assets/js/2.f6007b26.js" defer></script><script src="/assets/js/16.808ce394.js" defer></script>
  </body>
</html>
