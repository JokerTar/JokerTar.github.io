<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>八爪鱼小站</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="八爪鱼小站">
    <meta name="referrer" content="never">
    
    <link rel="preload" href="/assets/css/0.styles.e4025035.css" as="style"><link rel="preload" href="/assets/js/app.984fdec4.js" as="script"><link rel="preload" href="/assets/js/2.f6007b26.js" as="script"><link rel="preload" href="/assets/js/8.44873d68.js" as="script"><link rel="prefetch" href="/assets/js/10.59cdb2f4.js"><link rel="prefetch" href="/assets/js/11.4e8427de.js"><link rel="prefetch" href="/assets/js/12.7a10184b.js"><link rel="prefetch" href="/assets/js/13.083a4586.js"><link rel="prefetch" href="/assets/js/14.b100d612.js"><link rel="prefetch" href="/assets/js/15.08fdb981.js"><link rel="prefetch" href="/assets/js/16.808ce394.js"><link rel="prefetch" href="/assets/js/17.c6489116.js"><link rel="prefetch" href="/assets/js/18.8f683b57.js"><link rel="prefetch" href="/assets/js/19.e3c29ff0.js"><link rel="prefetch" href="/assets/js/20.73eecd32.js"><link rel="prefetch" href="/assets/js/21.701951a2.js"><link rel="prefetch" href="/assets/js/22.2013c06b.js"><link rel="prefetch" href="/assets/js/23.957e09cd.js"><link rel="prefetch" href="/assets/js/24.7c713358.js"><link rel="prefetch" href="/assets/js/25.0e6a82f8.js"><link rel="prefetch" href="/assets/js/26.a05ee402.js"><link rel="prefetch" href="/assets/js/27.cf387aa5.js"><link rel="prefetch" href="/assets/js/28.10b336a1.js"><link rel="prefetch" href="/assets/js/29.f95ddc62.js"><link rel="prefetch" href="/assets/js/3.57a28cbb.js"><link rel="prefetch" href="/assets/js/30.0c819ce6.js"><link rel="prefetch" href="/assets/js/31.edb82535.js"><link rel="prefetch" href="/assets/js/32.0da353ea.js"><link rel="prefetch" href="/assets/js/33.b2156d6b.js"><link rel="prefetch" href="/assets/js/34.3b32512e.js"><link rel="prefetch" href="/assets/js/35.c588f8e0.js"><link rel="prefetch" href="/assets/js/36.b306573c.js"><link rel="prefetch" href="/assets/js/37.d0c3967d.js"><link rel="prefetch" href="/assets/js/38.81b57a9f.js"><link rel="prefetch" href="/assets/js/39.e1a6ecaf.js"><link rel="prefetch" href="/assets/js/4.0495b111.js"><link rel="prefetch" href="/assets/js/40.3d350cf1.js"><link rel="prefetch" href="/assets/js/41.11e9c39c.js"><link rel="prefetch" href="/assets/js/42.01710931.js"><link rel="prefetch" href="/assets/js/43.8474ba10.js"><link rel="prefetch" href="/assets/js/44.ede483ee.js"><link rel="prefetch" href="/assets/js/45.fe2a4bf2.js"><link rel="prefetch" href="/assets/js/46.688bd2c0.js"><link rel="prefetch" href="/assets/js/47.c405d292.js"><link rel="prefetch" href="/assets/js/48.7f5d7cad.js"><link rel="prefetch" href="/assets/js/49.22b61fb9.js"><link rel="prefetch" href="/assets/js/5.b3f55925.js"><link rel="prefetch" href="/assets/js/50.315d590f.js"><link rel="prefetch" href="/assets/js/51.304a8e2f.js"><link rel="prefetch" href="/assets/js/52.dc01aad1.js"><link rel="prefetch" href="/assets/js/53.ed974a2f.js"><link rel="prefetch" href="/assets/js/54.3f8ea4f6.js"><link rel="prefetch" href="/assets/js/55.63aef931.js"><link rel="prefetch" href="/assets/js/56.714a0542.js"><link rel="prefetch" href="/assets/js/57.071c0df4.js"><link rel="prefetch" href="/assets/js/58.725c2ccb.js"><link rel="prefetch" href="/assets/js/59.b7faeb7b.js"><link rel="prefetch" href="/assets/js/6.5385b4bb.js"><link rel="prefetch" href="/assets/js/60.8f4b2b12.js"><link rel="prefetch" href="/assets/js/61.eeb76448.js"><link rel="prefetch" href="/assets/js/7.5d579fc3.js"><link rel="prefetch" href="/assets/js/9.937d4458.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4025035.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">八爪鱼小站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/blog/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/JavaScript/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  JavaScript高级语法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/node/01_base.html" class="nav-link">
  node基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/02_scaffold.html" class="nav-link">
  脚手架的实现
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/03_express.html" class="nav-link">
  express核心用法
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/04_koa.html" class="nav-link">
  koa核心用法
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Python/" class="nav-link">
  Python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端架构" class="dropdown-title"><span class="title">前端架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端架构" class="mobile-dropdown-title"><span class="title">前端架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/前端架构/GithubActions.html" class="nav-link">
  Github Actions
</a></li><li class="dropdown-item"><!----> <a href="/blog/前端架构/Docker.html" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/git.html" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/regular.html" class="nav-link">
  正则
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/network.html" class="nav-link">
  网络协议
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/mobile.html" class="nav-link">
  移动端
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/optimize.html" class="nav-link">
  前端性能优化
</a></li><li class="dropdown-item"><h4>
          浏览器工作原理与实践
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/web/browser/01.html" class="nav-link">
  01.Chrome架构：仅仅打开了1个页面，为什么有4个进程？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/02.html" class="nav-link">
  02.TCP协议：如何保证页面文件能被完整送达浏览器？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/03.html" class="nav-link">
  03.HTTP 请求流程：为什么很多站点第二次打开速度会很快？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/04.html" class="nav-link">
  04.导航流程：从输入URL到页面展示，这中间发生了什么？
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="案例库" class="dropdown-title"><span class="title">案例库</span> <span class="arrow down"></span></button> <button type="button" aria-label="案例库" class="mobile-dropdown-title"><span class="title">案例库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/case/article-collects.html" class="nav-link">
  文章收集
</a></li><li class="dropdown-item"><!----> <a href="/blog/case/dry-goods.html" class="nav-link">
  前端开发干货
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档教程" class="dropdown-title"><span class="title">文档教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档教程" class="mobile-dropdown-title"><span class="title">文档教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.imooc.com/wiki/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  慕课教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  菜鸟教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/blog/tutorial/03.印记中文.html" class="nav-link">
  印记中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/blog/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/JavaScript/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  JavaScript高级语法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/node/01_base.html" class="nav-link">
  node基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/02_scaffold.html" class="nav-link">
  脚手架的实现
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/03_express.html" class="nav-link">
  express核心用法
</a></li><li class="dropdown-item"><!----> <a href="/blog/node/04_koa.html" class="nav-link">
  koa核心用法
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Python/" class="nav-link">
  Python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端架构" class="dropdown-title"><span class="title">前端架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端架构" class="mobile-dropdown-title"><span class="title">前端架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/前端架构/GithubActions.html" class="nav-link">
  Github Actions
</a></li><li class="dropdown-item"><!----> <a href="/blog/前端架构/Docker.html" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/html.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/css.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/git.html" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/regular.html" class="nav-link">
  正则
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/network.html" class="nav-link">
  网络协议
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/mobile.html" class="nav-link">
  移动端
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/optimize.html" class="nav-link">
  前端性能优化
</a></li><li class="dropdown-item"><h4>
          浏览器工作原理与实践
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/web/browser/01.html" class="nav-link">
  01.Chrome架构：仅仅打开了1个页面，为什么有4个进程？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/02.html" class="nav-link">
  02.TCP协议：如何保证页面文件能被完整送达浏览器？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/03.html" class="nav-link">
  03.HTTP 请求流程：为什么很多站点第二次打开速度会很快？
</a></li><li class="dropdown-subitem"><a href="/blog/web/browser/04.html" class="nav-link">
  04.导航流程：从输入URL到页面展示，这中间发生了什么？
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="案例库" class="dropdown-title"><span class="title">案例库</span> <span class="arrow down"></span></button> <button type="button" aria-label="案例库" class="mobile-dropdown-title"><span class="title">案例库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/case/article-collects.html" class="nav-link">
  文章收集
</a></li><li class="dropdown-item"><!----> <a href="/blog/case/dry-goods.html" class="nav-link">
  前端开发干货
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档教程" class="dropdown-title"><span class="title">文档教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档教程" class="mobile-dropdown-title"><span class="title">文档教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.imooc.com/wiki/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  慕课教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  菜鸟教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/blog/tutorial/03.印记中文.html" class="nav-link">
  印记中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/JavaScript/#浏览器的工作原理" class="sidebar-link">浏览器的工作原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#浏览器的解析" class="sidebar-link">浏览器的解析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#为什么-js-会阻塞-dom-解析" class="sidebar-link">为什么 js 会阻塞 dom 解析？</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#js-引擎介绍" class="sidebar-link">js 引擎介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#v8-引擎" class="sidebar-link">v8 引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#v8-过程介绍" class="sidebar-link">v8 过程介绍</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#细节-预解析-preparser" class="sidebar-link">细节（预解析 PreParser）</a></li></ul></li><li><a href="/blog/JavaScript/#lhs-和-rhs-查询" class="sidebar-link">LHS 和 RHS 查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#为什么要区分-lhs-和-rhs" class="sidebar-link">为什么要区分 LHS 和 RHS?</a></li></ul></li><li><a href="/blog/JavaScript/#函数作用域" class="sidebar-link">函数作用域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#函数声明和函数表达式" class="sidebar-link">函数声明和函数表达式</a></li></ul></li><li><a href="/blog/JavaScript/#作用域提升" class="sidebar-link">作用域提升</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#函数默认参数的作用域" class="sidebar-link">函数默认参数的作用域</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#js-代码的执行过程" class="sidebar-link">js 代码的执行过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#vo" class="sidebar-link">VO</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#全局代码执行过程-变量" class="sidebar-link">全局代码执行过程（变量）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#全局代码执行过程-函数" class="sidebar-link">全局代码执行过程（函数）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#全局代码的执行过程-函数嵌套" class="sidebar-link">全局代码的执行过程（函数嵌套）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#函数调用函数执行过程-面试题" class="sidebar-link">函数调用函数执行过程（面试题）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#注意" class="sidebar-link">注意</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#最新的-ecma-规范修改了对-vo-的描述" class="sidebar-link">最新的 ECMA 规范修改了对 VO 的描述</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#作用域补充" class="sidebar-link">作用域补充</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#作用域提升-面试题" class="sidebar-link">作用域提升（面试题）</a></li></ul></li><li><a href="/blog/JavaScript/#内存管理" class="sidebar-link">内存管理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#gc" class="sidebar-link">gc</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#高阶函数" class="sidebar-link">高阶函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#map-映射" class="sidebar-link">map 映射</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#filter-过滤" class="sidebar-link">filter 过滤</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#reduce-累加" class="sidebar-link">reduce（累加）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#find-findindex-查找" class="sidebar-link">find/findIndex（查找）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#foreach-遍历" class="sidebar-link">forEach（遍历）</a></li></ul></li><li><a href="/blog/JavaScript/#闭包的定义" class="sidebar-link">闭包的定义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#高阶函数在内存中的执行过程" class="sidebar-link">高阶函数在内存中的执行过程</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#闭包到底是什么" class="sidebar-link">闭包到底是什么</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#闭包的内存泄漏" class="sidebar-link">闭包的内存泄漏</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#闭包引用的自由变量的销毁" class="sidebar-link">闭包引用的自由变量的销毁</a></li></ul></li><li><a href="/blog/JavaScript/#this-在全局作用域中的指向" class="sidebar-link">this 在全局作用域中的指向</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#this-在函数中的指向" class="sidebar-link">this 在函数中的指向</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#this-的绑定规则" class="sidebar-link">this 的绑定规则</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#默认绑定" class="sidebar-link">默认绑定</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#隐式绑定" class="sidebar-link">隐式绑定</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#显示绑定" class="sidebar-link">显示绑定</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#new-绑定" class="sidebar-link">new 绑定</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#特殊规则" class="sidebar-link">特殊规则</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#箭头函数的-this-获取" class="sidebar-link">箭头函数的 this 获取</a></li></ul></li><li><a href="/blog/JavaScript/#this-绑定规则细节" class="sidebar-link">this 绑定规则细节</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#一些内置函数的-this-分析-△△△△△" class="sidebar-link">一些内置函数的 this 分析 △△△△△</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#this-绑定规则的优先级" class="sidebar-link">this 绑定规则的优先级</a></li></ul></li><li><a href="/blog/JavaScript/#面试题" class="sidebar-link">面试题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#call-实现" class="sidebar-link">call 实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#apply-实现" class="sidebar-link">apply 实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#bind-实现" class="sidebar-link">bind 实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#arguments" class="sidebar-link">arguments</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#将-arguments-转成数组" class="sidebar-link">将 arguments 转成数组</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#箭头函数没有-arguments" class="sidebar-link">箭头函数没有 arguments</a></li></ul></li><li><a href="/blog/JavaScript/#纯函数-pure-function" class="sidebar-link">纯函数（Pure function）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#数组的两个函数对比" class="sidebar-link">数组的两个函数对比</a></li></ul></li><li><a href="/blog/JavaScript/#柯里化" class="sidebar-link">柯里化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#单一职责原则" class="sidebar-link">单一职责原则</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#逻辑的复用" class="sidebar-link">逻辑的复用</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#柯里化函数的实现-☆☆☆☆" class="sidebar-link">柯里化函数的实现 ☆☆☆☆</a></li></ul></li><li><a href="/blog/JavaScript/#组合函数" class="sidebar-link">组合函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#组合函数的实现" class="sidebar-link">组合函数的实现</a></li></ul></li><li><a href="/blog/JavaScript/#with-语句-不推荐使用" class="sidebar-link">with 语句（不推荐使用）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#eval-函数" class="sidebar-link">eval 函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#strict-mode" class="sidebar-link">strict mode</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#js-文件开启严格模式" class="sidebar-link">js 文件开启严格模式</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#函数开启严格模式" class="sidebar-link">函数开启严格模式</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#严格模式下常见的限制" class="sidebar-link">严格模式下常见的限制</a></li></ul></li><li><a href="/blog/JavaScript/#创建对象" class="sidebar-link">创建对象</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#对象的属性" class="sidebar-link">对象的属性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#对对象属性的操作" class="sidebar-link">对对象属性的操作</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#对属性操作的控制" class="sidebar-link">对属性操作的控制</a></li></ul></li><li><a href="/blog/JavaScript/#继承" class="sidebar-link">继承</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#原型" class="sidebar-link">原型</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#原型链" class="sidebar-link">原型链</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#原型链实现继承" class="sidebar-link">原型链实现继承</a></li></ul></li><li><a href="/blog/JavaScript/#原型继承的关系" class="sidebar-link">原型继承的关系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#总结-很重要" class="sidebar-link">总结（很重要）</a></li></ul></li><li><a href="/blog/JavaScript/#对象方法的补充-可以参考-reflecrt-的方法" class="sidebar-link">对象方法的补充（可以参考 Reflecrt 的方法）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#object-getownpropertydescriptors" class="sidebar-link">Object.getOwnPropertyDescriptors</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#object-setprototypeof" class="sidebar-link">Object.setPrototypeOf</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#object-getprototypeof" class="sidebar-link">Object.getPrototypeOf</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#object-hasownproperty" class="sidebar-link">Object.hasOwnProperty</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#in-操作符" class="sidebar-link">in 操作符</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#instanceof-操作符" class="sidebar-link">instanceof 操作符</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#isprototypeof-方法" class="sidebar-link">isPrototypeOf 方法</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#object-create" class="sidebar-link">Object.create</a></li></ul></li><li><a href="/blog/JavaScript/#class-定义类的方式" class="sidebar-link">class 定义类的方式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#class-的构造方法" class="sidebar-link">class 的构造方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#class-的方法定义" class="sidebar-link">class 的方法定义</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#类的继承以及-super" class="sidebar-link">类的继承以及 super</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#两种继承方式的比较" class="sidebar-link">两种继承方式的比较</a></li></ul></li><li><a href="/blog/JavaScript/#babel-转-es5▲▲▲▲▲▲▲▲▲▲▲▲▲▲" class="sidebar-link">Babel 转 es5▲▲▲▲▲▲▲▲▲▲▲▲▲▲</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#mixin" class="sidebar-link">mixin</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#类的多态-ts" class="sidebar-link">类的多态（TS）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#let-和-const-的作用域提升" class="sidebar-link">let 和 const 的作用域提升</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#let-和-const-跟-window-的关系" class="sidebar-link">let 和 const 跟 window 的关系</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#展开语法进行的浅拷贝" class="sidebar-link">展开语法进行的浅拷贝</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#对象作为对象的-key" class="sidebar-link">对象作为对象的 key</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#weakmap-与-vue3-响应式原理" class="sidebar-link">WeakMap 与 Vue3 响应式原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#map-创建与-object-entries-结合" class="sidebar-link">map 创建与 Object.entries 结合</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#函数尾逗" class="sidebar-link">函数尾逗</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#es10-的-object-fromentryies-结合-urlsearchparams" class="sidebar-link">ES10 的 Object.fromEntryies 结合 URLSearchParams</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#可选链操作符" class="sidebar-link">可选链操作符?.</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#空值合并运算" class="sidebar-link">？？空值合并运算</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#weakref-弱引用" class="sidebar-link">WeakRef 弱引用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#监听对象的操作" class="sidebar-link">监听对象的操作</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#proxy-代理-类" class="sidebar-link">Proxy（代理）类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#简单使用-可以监听深层属性" class="sidebar-link">简单使用（可以监听深层属性）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#handler-set-和-get" class="sidebar-link">handler：set 和 get</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#preventextensions" class="sidebar-link">preventExtensions</a></li></ul></li><li><a href="/blog/JavaScript/#reflect-反射-对象" class="sidebar-link">Reflect（反射） 对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#reflect-结合-proxy" class="sidebar-link">Reflect 结合 Proxy</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#construct" class="sidebar-link">construct</a></li></ul></li><li><a href="/blog/JavaScript/#关于-proxy-中-set-和-get-的最后一个参数-receiver-改变-this-用的" class="sidebar-link">关于 Proxy 中 set 和 get 的最后一个参数 receiver（改变 this 用的）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#响应式函数的封装" class="sidebar-link">响应式函数的封装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#依赖响应类的封装" class="sidebar-link">依赖响应类的封装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#proxy-自动监听对象属性的变化" class="sidebar-link">Proxy 自动监听对象属性的变化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#weakmap-依赖收集对象的管理" class="sidebar-link">WeakMap 依赖收集对象的管理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#get-的时候收集响应式函数" class="sidebar-link">get 的时候收集响应式函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#depend-类优化" class="sidebar-link">Depend 类优化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#将对象-new-proxy-的部分封装" class="sidebar-link">将对象 new Proxy 的部分封装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#vue2-实现响应式" class="sidebar-link">vue2 实现响应式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#异步处理方式-回调函数" class="sidebar-link">异步处理方式-回调函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#promise-简介" class="sidebar-link">promise 简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#promise-状态" class="sidebar-link">Promise 状态</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#promise-状态的移交-☆☆☆☆" class="sidebar-link">Promise 状态的移交 ☆☆☆☆</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#promise-的方法" class="sidebar-link">Promise 的方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#实例方法" class="sidebar-link">实例方法</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#静态方法" class="sidebar-link">静态方法</a></li></ul></li><li><a href="/blog/JavaScript/#实现-promise-与下面-promisea-结合看" class="sidebar-link">实现 Promise（与下面 promisea+结合看）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#实现-promise-的静态方法" class="sidebar-link">实现 promise 的静态方法</a></li></ul></li><li><a href="/blog/JavaScript/#按照-promisea-实现-promise" class="sidebar-link">按照 PromiseA+实现 Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#初体验" class="sidebar-link">初体验</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#then-方法初步实现" class="sidebar-link">then 方法初步实现</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#异步解决实现" class="sidebar-link">异步解决实现</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#链式调用实现" class="sidebar-link">链式调用实现</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#总结-2" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/JavaScript/#iterator" class="sidebar-link">iterator</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#迭代器初体验" class="sidebar-link">迭代器初体验</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#生成迭代器的函数" class="sidebar-link">生成迭代器的函数</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#可迭代对象" class="sidebar-link">可迭代对象</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#原生的可迭代对象" class="sidebar-link">原生的可迭代对象</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#可迭代对象的应用场景" class="sidebar-link">可迭代对象的应用场景</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#自定义类实现可迭代的案例" class="sidebar-link">自定义类实现可迭代的案例</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#迭代器的中断-return-方法" class="sidebar-link">迭代器的中断（return 方法）</a></li></ul></li><li><a href="/blog/JavaScript/#generator" class="sidebar-link">generator</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#生成器和生成器函数" class="sidebar-link">生成器和生成器函数</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#生成器函数的执行流程" class="sidebar-link">生成器函数的执行流程</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#next-传参" class="sidebar-link">next 传参</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#return-终止执行" class="sidebar-link">return 终止执行</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#throw-抛出异常" class="sidebar-link">throw 抛出异常</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#用生成器代替迭代器-yield" class="sidebar-link">用生成器代替迭代器（yield*)</a></li></ul></li><li><a href="/blog/JavaScript/#概念总结" class="sidebar-link">概念总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#async-函数" class="sidebar-link">async 函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#await-关键字" class="sidebar-link">await 关键字</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#解决异步问题" class="sidebar-link">解决异步问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#方法-1-promise-链式调用" class="sidebar-link">方法 1：promise 链式调用</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#方法-2-promise-generator-async-和-await-的原理" class="sidebar-link">方法 2：promise+generator（async 和 await 的原理）</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#方法-3-async-await-promise" class="sidebar-link">方法 3：async/await+promise</a></li></ul></li><li><a href="/blog/JavaScript/#js-线程" class="sidebar-link">js 线程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#浏览器事件循环" class="sidebar-link">浏览器事件循环</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#事件队列" class="sidebar-link">事件队列</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#node-事件循环" class="sidebar-link">node 事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#node-事件循环的阶段" class="sidebar-link">node 事件循环的阶段</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#node-的宏任务和微任务" class="sidebar-link">node 的宏任务和微任务</a></li></ul></li><li><a href="/blog/JavaScript/#面试题-1" class="sidebar-link">面试题 1</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#面试题-2" class="sidebar-link">面试题 2</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#面试题-3△" class="sidebar-link">面试题 3△</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#面试题-4" class="sidebar-link">面试题 4</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#面试题-5" class="sidebar-link">面试题 5</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#最早期的模块化" class="sidebar-link">最早期的模块化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#commonjs-模块化" class="sidebar-link">CommonJS 模块化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#模块化导出" class="sidebar-link">模块化导出</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#模块化导入" class="sidebar-link">模块化导入</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#模块的加载过程" class="sidebar-link">模块的加载过程</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#总结-3" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/JavaScript/#es-module" class="sidebar-link">ES module</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#注意事项" class="sidebar-link">注意事项</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#导出方式" class="sidebar-link">导出方式</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#导入方式" class="sidebar-link">导入方式</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#导入导出结合" class="sidebar-link">导入导出结合</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#import-函数异步导入" class="sidebar-link">import 函数异步导入</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#补充-import-对象的-meta-属性" class="sidebar-link">补充 import 对象的 meta 属性</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#es-module-解析过程" class="sidebar-link">es module 解析过程</a></li></ul></li><li><a href="/blog/JavaScript/#commonjs-和-es-module-相互引用" class="sidebar-link">commonJS 和 ES module 相互引用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#commonjs-和-esmodule-的区别" class="sidebar-link">commonjs 和 esModule 的区别</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#npm" class="sidebar-link">npm</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#npm-install" class="sidebar-link">npm install</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#package-json" class="sidebar-link">package.json</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#package-lock-json" class="sidebar-link">package-lock.json</a></li></ul></li><li><a href="/blog/JavaScript/#yarn" class="sidebar-link">yarn</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#cnpm" class="sidebar-link">cnpm</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#npx" class="sidebar-link">npx</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#npm-发布自己的包" class="sidebar-link">npm 发布自己的包</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#json-基本语法" class="sidebar-link">JSON 基本语法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#json-序列化" class="sidebar-link">JSON 序列化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#stringify-的细节" class="sidebar-link">stringify 的细节</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#parse-的细节" class="sidebar-link">parse 的细节</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#利用-json-序列化实现深拷贝" class="sidebar-link">利用 JSON 序列化实现深拷贝</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#storage" class="sidebar-link">storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#常见的属性和方法" class="sidebar-link">常见的属性和方法</a></li></ul></li><li><a href="/blog/JavaScript/#indexeddb" class="sidebar-link">IndexedDB</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#防抖-debounce-函数" class="sidebar-link">防抖 debounce 函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#节流-throttle-函数" class="sidebar-link">节流 throttle 函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#防抖和节流的区别" class="sidebar-link">防抖和节流的区别</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#第三方库实现" class="sidebar-link">第三方库实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#实现防抖函数" class="sidebar-link">实现防抖函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#实现节流函数" class="sidebar-link">实现节流函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#实现浅拷贝" class="sidebar-link">实现浅拷贝</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/JavaScript/#实现深拷贝" class="sidebar-link">实现深拷贝</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#深拷贝初步实现" class="sidebar-link">深拷贝初步实现</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#对数组类型进行处理" class="sidebar-link">对数组类型进行处理</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#对函数对象进行处理" class="sidebar-link">对函数对象进行处理</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#symbol-类型作为对象的-key-和作为-value-的处理" class="sidebar-link">Symbol 类型作为对象的 key 和作为 value 的处理</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#set-和-map" class="sidebar-link">Set 和 Map</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#循环引用" class="sidebar-link">循环引用</a></li></ul></li><li><a href="/blog/JavaScript/#排序算法" class="sidebar-link">排序算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/#冒泡排序" class="sidebar-link">冒泡排序</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#插入排序" class="sidebar-link">插入排序</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/#快速排序" class="sidebar-link">快速排序</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_01、浏览器工作原理和-v8-引擎"><a href="#_01、浏览器工作原理和-v8-引擎" class="header-anchor">#</a> 01、浏览器工作原理和 v8 引擎</h1> <h2 id="浏览器的工作原理"><a href="#浏览器的工作原理" class="header-anchor">#</a> 浏览器的工作原理</h2> <p>访问某个 ip 地址的时候，首先是下载 html 文件，然后解析到 link 标签 css 的时候去发送请求下载 css，解析到 script 标签的时候去发送请求下载 js 代码，下载 script 的时候会阻塞浏览器，所以基本上都将 script 标签放到 html 后面</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343894.png" alt="image-20211229204314171"></p> <h2 id="浏览器的解析"><a href="#浏览器的解析" class="header-anchor">#</a> 浏览器的解析</h2> <p>浏览器获取到 html 文件之后就开始解析，遇到 script 标签就去下载 js，link 标签就下载 css，浏览器是不能直接解析 HTML 数据的，所以解析<strong>第一步</strong>是需要将它转换成浏览器能理解的 DOM 树结构，生成 DOM 树之后根据 CSS 样式表计算出 DOM 树中所有节点的样式，最后<strong>计算 DOM 元素的布局信息</strong>，使其都保存在布局树中，然后绘制到浏览器页面上。因为 js 代码会停止解析 HTML（因为接下来的 JavaScript <strong>可能要修改当前已经生成的 DOM 结构</strong>），所以要将 script 标签尽量放在末尾，</p> <ul><li>在 HTML 页面提交给渲染引擎，渲染引擎会将 HTML<strong>解析成 dom 树</strong></li> <li>将 css 转化成浏览器可以理解的 styleSheets，计算出所有 dom 树节点的样式</li> <li>创建布局树，计算出所有节点的位置，保存在<strong>布局树</strong>中</li> <li>网页其实是由一个个<strong>图层构成</strong>的，对布局树<strong>进行分层</strong>，生成分层树</li></ul> <p>浏览器的页面实际上被分成了很多图层，这些<strong>图层叠加后合成了最终的页面</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343895.png" alt="image-20220305172832080"></p> <p>通常情况下，浏览器并不会为每一个节点都创建一个图层。只有满足以下特定条件才会将节点提升为单独的一层</p> <p><strong>拥有层叠上下文属性的元素（会给 html 元素三维的概念）</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343896.png" alt="image-20220305173045278"></p> <p><strong>固定 div，内容被裁剪隐藏的元素</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343897.png" alt="image-20220305173059799"></p> <ul><li>为每个图层<strong>生成绘制列表</strong>，提交给合成线程</li></ul> <p>完成图层树的构建后，<strong>渲染引擎</strong>会对图层树中的每个图层进行<strong>绘制</strong>，进行绘制之前会生成<strong>绘制列表</strong>，绘制列表其实是一个个小的<strong>绘制指令的集合</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343898.png" alt="image-20220305173339471"></p> <ul><li>当图层的<strong>绘制列表</strong>准备好之后，主线程会把该绘制列表提交（commit）给合成线程，合成线程将图层分成图块，在<strong>光栅化</strong>线程池中将<strong>图块转化成位图</strong></li></ul> <p>主线程将图层绘制列表交给合成线程之后</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343899.png" alt="image-20220305173533196"></p> <p>首先将<strong>图层分为一个个图块</strong>，合成线程会按照视口附近的图块优先生成位图。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343901.png" alt="image-20220305173921781"></p> <p>生成位图的操作是由<strong>栅格化线程</strong>来执行的，</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343902.png" alt="image-20220305174216527"></p> <ul><li>一旦所有图块都被光栅化，合成线程发送<strong>绘制图块指令 DrawQuad</strong>给浏览器进程，浏览器进程就会根据<strong>DrawQuad</strong>消息生成页面</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343903.png" alt="image-20211229205024880"></p> <h2 id="为什么-js-会阻塞-dom-解析"><a href="#为什么-js-会阻塞-dom-解析" class="header-anchor">#</a> 为什么 js 会阻塞 dom 解析？</h2> <p>解析到 script 标签时，渲染引擎判断<strong>这是一段脚本</strong>，此时 HTML 解析器就会暂停 DOM 的解析，因为接下来的 JavaScript 可<strong>能要修改当前已经生成的 DOM 结构</strong>。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343904.png" alt="image-20220305182131879"></p> <h2 id="js-引擎介绍"><a href="#js-引擎介绍" class="header-anchor">#</a> js 引擎介绍</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343905.png" alt="image-20211229205352156"></p> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343906.png" alt="image-20211229205746318" style="zoom:80%;"> <h2 id="v8-引擎"><a href="#v8-引擎" class="header-anchor">#</a> v8 引擎</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343907.png" alt="image-20211229210352642"></p> <h3 id="v8-过程介绍"><a href="#v8-过程介绍" class="header-anchor">#</a> v8 过程介绍</h3> <p>将 JavaScript 代码进行词法、语法分析转化成抽象语法树，<strong>抽象语法树</strong>经过解释器转化成字节码，字节码再转成对应 cpu 平台的机器指令。v8 引擎对转换成机器指令的步骤做了优化，内部有一个库可以收集一些信息，如果是高频使用的函数会被标记成热函数，然后在进行解析的时候就直接会转化成对应的机器指令，省去了一个步骤。因为 js 没有类型声明，如果 sum 函数被标记成了热函数，但是如果这个时候，传入了两个字符串，对应的机器指令就无法完成函数的功能，会反编译，转成对应功能的机器指令，所以有类型声明会提高性能优化</p> <ul><li>astexplorer.net(生成抽象语法树的网页 )</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343908.png" alt="image-20211229210511406"></p> <p>跨平台的字节码（之所以是跨平台的，是因为本质上是先将字节码转换成<strong>汇编代码</strong>，然后再转化成在<strong>不同的 cpu 平台上运行的 cpu 指令</strong>，也就是机器指令 ）</p> <p>v8 引擎的性能优化：TurboFan 库可以由 Ignition 收集<strong>函数的执行信息</strong>（如果是高频的函数会被标记成<strong>hot 热函数</strong>，这个被标记的热函数会<strong>直接转换成要被执行的机器指令</strong>，这样就可以<strong>省去了中间转换成汇编指令的过程，性能更高</strong>）</p> <p>但是有一个问题就是，例如下图的 sum 函数，假设被标记成了热函数，转成了对应的机器指令。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343909.png" alt="image-20211229212135659"></p> <p>如果一直都是传入两个数字的话，那么这个机器指令的功能是不会出现问题的。<strong>但是突然传入两个字符串，本质上就是做拼串操作了，那么这个机器指令（它的本质是做相加操作）就无法使用</strong>，这个时候就要生成新的机器指令了，所以有了<strong>Deoptimization</strong>过程（反优化，也就是<strong>重新将机器指令转换为字节码</strong>） ，还原，并且重新进行“**字节码 -&gt; 汇编指令 -&gt; 机器指令”**的过程。所以用 ts 写的代码编译成的 js 代码有了类型约束，代码的执行效率就会很高（底层不需要执行 Deoptimization）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343910.png" alt="image-20211229213223427"></p> <hr> <h3 id="细节-预解析-preparser"><a href="#细节-预解析-preparser" class="header-anchor">#</a> 细节（预解析 PreParser）</h3> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343911.png" alt="image-20211229221225169" style="zoom:80%;"> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343912.png" alt="image-20211229221216554" style="zoom:67%;"> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343913.png" alt="image-20211229230234722" style="zoom:67%;"> <h1 id="_02、作用域"><a href="#_02、作用域" class="header-anchor">#</a> 02、作用域</h1> <p>在传统编译语言的流程中，程序中的一段源代码在执行前会经历三个步骤，统称为<strong>编译</strong></p> <ul><li><p>词法分析</p> <p>这个过程会将由字符组成的字符串分解成有意义的代码块，这些代码块被称为词法单元。例如，考虑程序<code>var a = 2</code>。这段程序通常会被分解称为下面这些词法单元：var 、a 、 = 、 2 、</p></li> <li><p>语法分析</p> <p>这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套锁组成的代表了程序语法结构的树。这个树被称为**“抽象语法树 AST”**</p></li> <li><p>代码生成</p> <p>将 AST 转换为可执行的过程被称为代码生成，这个过程与语言、平台等信息相关</p></li></ul> <h2 id="lhs-和-rhs-查询"><a href="#lhs-和-rhs-查询" class="header-anchor">#</a> LHS 和 RHS 查询</h2> <p>在遇到<code>var a = 2</code>时，编译器会进行如下处理</p> <ul><li>遇到<code>var a</code>，<strong>编译器</strong>会询问<strong>作用域</strong>是否已经有一个该名称的变量存在于同一个作用域的集合中。如果是，编译器会忽略该声明，继续进行编译；否则它会要求作用域在当前作用域的集合中声明一个新的变量并命名为 a</li> <li>接下来编译器会为<strong>引擎</strong>生成运行时所需要的代码，这些代码被用来处理<code>a = 2</code>这个赋值操作。引擎运行时会首先询问作用域，在当前的作用域集合中是否存在一个叫做 a 的变量，如果是，引擎就会使用这个变量，否则就会继续查找该变量</li></ul> <p>编译器在编译过程的第二部中生成了代码，引擎执行它时，会通过查找变量 a 来判断它是否已声明过。查找到过程由作用域进行协助。引擎会为变量进行两种查询：<strong>LHS 查询和 RHS 查询</strong></p> <ul><li><p>RHS 查询是简单地查找某个变量的值，也就是谁是赋值操作的源头</p></li> <li><p>LHS 查询是试图找到变量的容器本身，从而可以对其进行赋值，也就是赋值操作的目标是谁</p></li></ul> <p>考虑以下代码</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其中对 a 的引用是一个<strong>RHS</strong>引用，因为这里 a 并<strong>没有赋予任何值</strong>，反而我们需要查找并获取 a 的值传递给<code>console.log(...)</code></p> <p>相比之下，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>这里对 a 的引用就是<strong>LHS</strong>引用，实际上我们不关心当前的值是什么，只想要为<code>= 2</code>这个赋值操作找到一个<strong>目标</strong></p> <p>考虑下面的程序</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//对a的引用，RHS查询</span>
  <span class="token comment">//console.log本身也是需要一个引用才能执行，所以对console对象进行了RHS查询，并且查询得到的值中是否有一个叫做log的方法</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//这里的foo函数的调用是要对foo进行RHS查询</span>
<span class="token comment">//这里隐含了一个对a的LHS查询，也就是将2传给a</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//LHS:c..,b..,a=2   (三次)</span>
<span class="token comment">//RHS:foo(..),=a,a...,b...  (四次)</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="为什么要区分-lhs-和-rhs"><a href="#为什么要区分-lhs-和-rhs" class="header-anchor">#</a> 为什么要区分 LHS 和 RHS?</h3> <p>考虑如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  b <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>第一次多 b 进行 RHS 查询时是无法找到该变量的，也就是说，这是一个未声明变量，因为在任何相关的作用域中都无法找到它</p> <p>如果 RHS 查询在所有嵌套的的作用域中都找不到所需的变量，引擎就会抛出<strong>ReferenceError 异常</strong>，如果 RHS 查询到了一个变量，但是你厂时对这个变量的值进行不合理的操作（例如对一个非函数类型的值进行函数调用），那么引擎会抛出一个<strong>TypeError</strong>异常</p> <blockquote><p>ReferenceError 同<strong>作用域判别失败</strong>相关，TypeError 表示作用域判别成果了，但是对<strong>结果的操作是非法的</strong></p></blockquote> <p>相比之下，当引擎执行 LHS 查询时，如果在顶层作用域中也无法找到目标变量，<strong>全局作用域中就会创建一个具有该名称的变量，并将其返还给引擎</strong>，前提是程序在非严格模式下。</p> <h2 id="函数作用域"><a href="#函数作用域" class="header-anchor">#</a> 函数作用域</h2> <p>考虑下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2</span>
</code></pre></div><p>函数作用域的是指，<strong>属于这个函数的全部变量都可以在整个函数的范围内使用以及复用（嵌套的作用域 bar 中也可以使用）</strong>。外层作用域无法访问内层作用域，内层作用域可以访问外层作用域。</p> <p>这个 foo 函数将内部变量和函数的<strong>定义</strong>隐藏起来了，外部作用域无法访问函数内部的任何内容。虽然这样可以解决一些问题（规避命名冲突），但是这个 foo 本身污染了所在的作用域（在上面例子中是全局作用域）。其次，必须显式地调用函数才能执行函数内部的代码。</p> <h3 id="函数声明和函数表达式"><a href="#函数声明和函数表达式" class="header-anchor">#</a> 函数声明和函数表达式</h3> <blockquote><p>区分函数声明和函数表达式最简单的方法就是看 function 关键字出现在声明中的位置（不仅仅是在第一行代码中的位置，而是在整个声明中的位置）。<strong>如果 function 是声明中的第一个词，那么就是一个函数声明，否则就是一个函数表达式</strong></p></blockquote> <ul><li>函数声明</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>函数表达式</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//1、用一个括号将整个函数包裹，那么这个函数会被当作函数表达式来处理(第一个词不是function了)</span>
<span class="token comment">//可以在后面紧跟着()来调用函数</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'jzsp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2、一般的函数声明</span>
<span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//这个分号是必须要加的</span>
<span class="token comment">//紧跟着的括号内是可以传入参数的，下面这个例子中，传入的参数是一个函数对象，在函数表达式内部执行传入的函数对象</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">def</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">def</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//3</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*---------------------------------------------------------x*/</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="作用域提升"><a href="#作用域提升" class="header-anchor">#</a> 作用域提升</h2> <p>编译阶段中的一部分工作就是<strong>找到所有的声明，并用合适的作用域将它们关联起来</strong>。当你看到<code>var a = 2</code>时，可能会认为这是一个声明。但是 JS 实际上会将其看成两个声明<code>：var a</code>和 <code>a = 2</code>。<strong>第一个定义声明是在编译阶段进行的（提升到最上面），第二个赋值声明会被留在原地等待执行阶段</strong></p> <blockquote><p>函数内部也会对 var 和 function 的定义进行提升</p></blockquote> <p>但是类似于 <code>var a = function bar(){}</code>里面的函数是不会提升的，也就是说，只对函数声明进行提升，函数表达式是不提升的，并且<strong>函数提升优先于变量提升</strong></p> <h2 id="函数默认参数的作用域"><a href="#函数默认参数的作用域" class="header-anchor">#</a> 函数默认参数的作用域</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343914.png" alt="image-20220127160229348"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>
  x<span class="token punctuation">,</span>
  <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 20</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 30</span>
<span class="token punctuation">}</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343915.png" alt="image-20220127160344265"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343916.png" alt="image-20220127160435089"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span>
  x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1,用默认参数作用域中的x给作用域内部的x赋初值</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span>
  x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10，函数作用域内部没有声明x，往上层作用域(参数作用域查找)</span>
  <span class="token comment">//var x = 'abc';</span>
<span class="token punctuation">}</span>
<span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="js-代码的执行过程"><a href="#js-代码的执行过程" class="header-anchor">#</a> js 代码的执行过程</h2> <h3 id="vo"><a href="#vo" class="header-anchor">#</a> VO</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343917.png" alt="image-20211230162606740"></p> <h3 id="全局代码执行过程-变量"><a href="#全局代码执行过程-变量" class="header-anchor">#</a> 全局代码执行过程（变量）</h3> <p>在 js 引擎中是如何执行下面的简单代码的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343918.png" alt="image-20211229222233481"></p> <ul><li>首先，<strong>执行代码前</strong>，代码被解析，v8 引擎内部会帮助我们创建一个对象（GlobalObject 简称 GO），扫描所有的代码，将一些内置的类和函数，<strong>挂载到 GO 对象的属性上</strong>，同时也挂载在代码中被<strong>定义的一些 var 变量名</strong>（例如上图的 num1），但是这些被挂载的<strong>变量名是作为属性值的，并没有被赋值（undefined）</strong></li></ul> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343919.png" alt="image-20211229223455706" style="zoom:67%;"> <p>firfox</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343920.png" alt="image-20211230141830563"></p> <p>chrom</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343921.png" alt="image-20211230142126612"></p> <ul><li>第二步，为了执行代码，v8 引擎内部会有一个<strong>执行上下文栈</strong>（Execution Context Stack）</li></ul> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343922.png" alt="image-20211229223603261" style="zoom:67%;"> <ul><li>第三步，为了执行全局代码，v8 引擎会在执行代码时，创建全局执行上下文栈（Global execution context），放入 ECS 中。GEC 放入 ECS 中有两个步骤，<strong>第一步就是创建 VO(variable object)指向 GO，第二步是依次执行全局代码</strong>（也就是<code>var name = &quot;why&quot;</code>)，此时如果第二行执行<code>console.log(num1)</code>的话会 undefined，因为此时<strong>VO 指向的 GO 中的 num1 变量还没有被赋值</strong>，是初值 undefined，只有在执行到第三行代码的时候才会被赋值为 20.</li></ul> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343923.png" alt="image-20211229223611345" style="zoom:80%;"> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343924.png" alt="image-20211229223214571" style="zoom:80%;"> <h3 id="全局代码执行过程-函数"><a href="#全局代码执行过程-函数" class="header-anchor">#</a> 全局代码执行过程（函数）</h3> <p>在编译的时候， <strong><code>foo()</code>是执行语句，不会被执行</strong>，检测到<code>function foo()函数声明</code>的时候 ，会在内存中开辟一个<strong>函数存储空间（函数对象）</strong>，这个存储空间中保存了两个东西：<strong>父级作用域以及代码块</strong>。并且 GO 中会挂载一个<strong>foo 属性</strong>指向这个内存空间。</p> <blockquote><p>注意，只有函数声明才有声明提前，函数表达式是不会声明提前的，例如<code>var a = function ()</code></p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343925.png" alt="image-20211230143158059"></p> <p><strong>在执行函数的前，会创建一个函数执行上下文</strong>（functional execution object）<strong>以及 AO</strong>（Activation Object，会先将代码块里的变量名和形参都挂载到 AO 上，初值也是 undefined），并且将函数执行上下文<strong>入栈</strong>，函数执行上下文里面也包括<strong>两个步骤</strong>，第一步也是创建 VO，但是它指向的是 AO（activation object）而不是 GO，第二步是执行代码，执行代码的过程跟 GO 中的代码执行过程差不多，都是依次给 AO 中的属 性赋值。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343926.png" alt="image-20211230144203192"></p> <p>函数执行完了之后会将函数执行上下文出栈，并且跟 AO 一起销毁**（因为是 VO 指向 AO，如果函数执行上下文出栈了，VO 没了，就没有变量指向 AO，那么 AO 会被回收）**</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343927.png" alt="image-20211230144300187"></p> <p>如果在函数执行的过程中，调用了某个变量，v8 引擎会进行查找，真实的查找路径是沿着作用域链来进行的。<strong>作用域链就是当前 VO 指向的 AO 以及函数在编译时保存的 parent scope</strong>（父级作用域）（图中写错了，是 AO+parentScope），如果在当前作用域中 VO 找不到变量，就会去父级作用域去查找。在父级作用域中也是如此。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343928.png" alt="image-20211230152312410"></p> <h3 id="全局代码的执行过程-函数嵌套"><a href="#全局代码的执行过程-函数嵌套" class="header-anchor">#</a> 全局代码的执行过程（函数嵌套）</h3> <p>首先进入编译阶段，对全局代码进行编译，产生 GO 对象，将 name（undefined）保存到 GO 中，同时开辟一个 foo 的函数存储空间，并挂载到 GO 对象中。</p> <p>进入运行阶段，给 name 赋值，执行到<code>foo(123)</code>的时候，会创建一个函数执行上下文（包括 AO）并且入栈，这个执行上下文包括两步，<strong>第一步</strong>是将函数中的<strong>变量名</strong>都挂载到 AO 上并且赋值 undefined，检测到有函数声明（<code>function bar()</code>）的话也会开辟一个新的<strong>函数存储空间</strong>，并且将这个存储空间的<strong>内存地址挂载到 AO 上</strong>。<strong>第二步</strong>是依次执行代码，给 AO 中的属性赋值，如果此时执行了 bar 函数，又会创建一个<strong>新的函数执行上下文</strong>（含有属于 bar 函数的 AO，也是两个步骤）并且入栈，由于 bar 函数中没有声明变量，所以 AO 是空对象，进入第二步执行代码阶段，执行<code>console.log(name)</code>的时候，**由于 AO 中没有，它就依据作用域链去查找，先查找 bar 函数存储空间中保存的 parentScope，如果父级作用域中也没有 name 属性的话，就会向父级作用域的 parentScope 中去查找。直到找到全局。**执行完 bar 函数之后，bar 函数的函数执行上下文出栈，随之就是 foo 函数执行结束，foo 函数的执行上下文出栈。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343929.png" alt="image-20211230153259513"></p> <h3 id="函数调用函数执行过程-面试题"><a href="#函数调用函数执行过程-面试题" class="header-anchor">#</a> 函数调用函数执行过程（面试题）</h3> <p>首先是全局代码的预编译阶段，创建一个 GO，将 message 挂载到 go 上（值为 undefined），<strong>在检测到<code>function foo()</code>时创建了 foo 的函数存储空间，里面保存了父级作用域（GO）以及自身的代码块</strong>（检测到<code>function bar()</code>也是如此），在 GO 上挂载 foo 属性，指向 foo 的函数存储空间。</p> <p>进入全局代码执行阶段，会在<strong>执行调用栈</strong>里创建 GEC（第一步将 VO 指向 GO，第二步依次执行全局代码），执行到<code>bar()</code>代码的时候，会创建 bar 函数的函数执行上下文并且入栈，第一步创建 VO 指向 bar 的 AO 对象，属性为 message 值为 undefined，第二步执行代码块中的代码</p> <p><strong>执行到<code>foo()</code>的时候会新建 foo 函数的执行上下文并且入栈</strong>，第一步创建 VO 指向 AO 对象，这个 AO 对象为空，第二步执行代码块的代码</p> <p>执行到<code>console.log(message)</code>时<strong>发现 foo 执行上下文中保存的 AO 中没有 message 属性值</strong>，就去 parentScope 父级作用域中去找，此时的<strong>父级作用域是在 foo 函数存储空间在创建时就保存的</strong>，这个父级作用域指向 GO，GO 中有 message，于是输出 GO 中的 Hello Global。</p> <p>然后 foo 的执行上下文和 bar 的执行上下文依次出栈。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343930.png" alt="image-20211230160421614"></p> <h3 id="注意"><a href="#注意" class="header-anchor">#</a> 注意</h3> <p>函数在<strong>编译阶段</strong>只是创建<strong>函数存储空间（函数对象）</strong>，里面保存了作用域以及代码块，<strong>只有在执行的时候才会创建 AO 对象</strong>，将内部声明的一些变量挂载到 AO 上。</p> <h3 id="最新的-ecma-规范修改了对-vo-的描述"><a href="#最新的-ecma-规范修改了对-vo-的描述" class="header-anchor">#</a> 最新的 ECMA 规范修改了对 VO 的描述</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343931.png" alt="image-20211230163005490"></p> <h3 id="作用域补充"><a href="#作用域补充" class="header-anchor">#</a> 作用域补充</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343932.png" alt="image-20211230165525849"></p> <p>函数内定义变量 m 本应该是 var m = 100，但是没写 var，js 引擎把它当做特殊语法处理，直接挂载到 GO 中</p> <h3 id="作用域提升-面试题"><a href="#作用域提升-面试题" class="header-anchor">#</a> 作用域提升（面试题）</h3> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343933.png" alt="image-20211230163420690"></p> <p>因为 foo 函数执行上下文中的 AO 中没有 n 属性，就会在作用域链上找，找到 GO 的 n 并且赋值给 200，所以输出 200</p> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343934.png" alt="image-20211230163750675"></p> <p>执行 foo 的时候会创建 AO，AO 对象中有 n 为 undefined，执行第一个<code>console.log</code>的时候 n 为 undefined，执行到<code>var n = 200</code>时给 AO 中的 n 赋值为 200，第二个<code>console.log</code>输出 200（因为 foo 执行上下文中的 AO 中有 n 属性，就不会去父级作用域中去找 n 了）</p> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343935.png" alt="image-20211230164051393"></p> <p>执行 foo2 的时候，foo2 的函数执行上下文的 AO 中有 n，所以中间的<code>console.log()</code>输出的是 200，然后执行 foo1，foo1 的函数执行上下文中的 AO 里没有 n，就去 parentScope（GO，<strong>在函数被编译时生成的函数存储空间中保存了 parentScope</strong>）中去找，所以另外两个 clg 输出的是 100</p> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343936.png" alt="image-20211230164359588"></p> <p>在执行 foo 的时候，入栈 foo 的函数执行上下文，并且生成 AO，<strong>在编译阶段是不会去管执行代码的，所以 return 后面的代码声明的变量的变量名依然会被挂载到 AO 中</strong>。此时 ao 中有 a 但是为 undefined。第二步是执行代码，输出的是 undefined，然后 return 掉了。</p> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343937.png" alt="image-20211230164943706"></p> <p>a 是 not define 报错</p> <p>b 是 10</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343938.png" alt="image-20211230165812906"></p> <hr> <p>块级作用域中的函数提升</p> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343939.png" alt="image-20220124211006369" style="zoom:67%;"> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343940.png" alt="image-20220123175745352"></p> <hr> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343941.png" alt="image-20220123175625857"></p> <p>分析第一个例子的执行流程。首先创建 GO 对象，对全局代码进行预编译，扫描 var 变量和函数的定义。</p> <p>发现 var foo = 1 时，在 GO 中声明一个属性名为 foo 的 undefined 的值</p> <p>发现 function foo(){}时，会在堆内存创建这个函数的函数对象，里面保存了两个部分（父级作用域 GO 以及代码块）并在 GO 中创建 foo 变量指向这个函数对象（此时已经有 foo 变量了，无需创建）</p> <p>然后将 GEC（全局执行上下文）入栈，执行两个步骤：创建 VO 指向 GO；执行代码块中的代码。</p> <p>执行第一行的时候，在 VO 指向的 GO 中寻找 foo 的定义，找到的 foo 是指向函数对象的，输出 Function</p> <p>执行第二行的时候，本质上执行的是<code>foo = 1</code>赋值语句，将原来指向函数对象的 foo 的值改为 1</p> <hr> <p>参数的作用域</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span>
  x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1,用默认参数作用域中的x给作用域内部的x赋初值</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span>
  x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10，函数作用域内部没有声明x，往上层作用域(参数作用域查找)</span>
  <span class="token comment">//var x = 'abc';</span>
<span class="token punctuation">}</span>
<span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="_03、-内存"><a href="#_03、-内存" class="header-anchor">#</a> 03、 内存</h1> <h2 id="内存管理"><a href="#内存管理" class="header-anchor">#</a> 内存管理</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343942.png" alt="image-20211230170845185"></p> <h2 id="gc"><a href="#gc" class="header-anchor">#</a> gc</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343943.png" alt="image-20211230170947434"></p> <ul><li>gc 算法 1：引用计数</li></ul> <p>当引用类型的对象，被引用的次数为 0 的时候，GC 就会自动回收掉该对象，释放对应的堆空间</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343944.png" alt="image-20211230171133747"></p> <p>存在问题，就是内存泄漏</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343945.png" alt="image-20211230171330034"></p> <ul><li>gc 算法 2：标记清除</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343946.png" alt="image-20211230171543390"></p> <h1 id="_04、闭包"><a href="#_04、闭包" class="header-anchor">#</a> 04、闭包</h1> <h2 id="高阶函数"><a href="#高阶函数" class="header-anchor">#</a> 高阶函数</h2> <p>函数是一等公民，可以作为另外一个函数的参数，也可以作为另外一个函数的返回值来使用。</p> <p>如果一个函数<strong>接收</strong>另外一个函数作为参数，或者该函数会<strong>返回</strong>另外一个函数作为返回值，那么这个函数就成为是一个<strong>高阶函数</strong></p> <blockquote><p>下面的高阶函数都可以传入第二个参数，来修改 this 的绑定</p></blockquote> <h3 id="map-映射"><a href="#map-映射" class="header-anchor">#</a> map 映射</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343947.png" alt="image-20211231213836510"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//map接收一个函数作为参数</span>
<span class="token comment">//这个函数在map内部也会被调用共数组长度次，返回值作为新数组中对应index的内容</span>
<span class="token comment">//下面实现的是，给数组中所有元素*10并存入新数组</span>
<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> newNums2 <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> item <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="filter-过滤"><a href="#filter-过滤" class="header-anchor">#</a> filter 过滤</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//filter接收一个函数</span>
<span class="token comment">//这个函数有三个参数item,index,arr（可以只传item）,返回值是boolean值，</span>
<span class="token comment">//在filter内部会自动调用函数共数组长度次，如果调用函数之后返回值为true，则将当前item加入新数组中，否则就不加</span>
<span class="token comment">//如此过滤，下面的结果是返回偶数</span>
<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> newNums <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> item <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="reduce-累加"><a href="#reduce-累加" class="header-anchor">#</a> reduce（累加）</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343948.png" alt="image-20211231215425429"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//reduce有两个参数，第一个是回调函数，这个callback函数有四个参数，第一个是上一次执行return的值，第二个是当前遍历到的item的值，第三个是index，第四个是arr</span>
<span class="token comment">//第二个是initialValue，初始化值，也就是第一次执行回调时的第一个参数中对应的上一次执行return的值。</span>
<span class="token comment">//每次调用回调函数的返回值会作为下一次回调的第一个参数，整个reduce的返回值是累加的结果</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>nums<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> pre <span class="token operator">+</span> item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="find-findindex-查找"><a href="#find-findindex-查找" class="header-anchor">#</a> find<code>/</code>findIndex（查找）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//find传入一个函数，如果这个函数的返回值为true，那么find就返回当前遍历到的item</span>
<span class="token comment">//findIndex返回的是item对应的index</span>
<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> item <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343949.png" alt="image-20211231214959361"></p> <h3 id="foreach-遍历"><a href="#foreach-遍历" class="header-anchor">#</a> forEach（遍历）</h3> <p>forEach 是不能跟定时器一起使用的，内部是执行了 while 循环</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
nums<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//不会改变原数组的值</span>
  item <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343950.png" alt="image-20211231214607298"></p> <h2 id="闭包的定义"><a href="#闭包的定义" class="header-anchor">#</a> 闭包的定义</h2> <ul><li>计算机科学领域的闭包解释</li></ul> <blockquote><p>头等函数就是指，函数是一等公民，词法绑定的话，可以在解析函数，创建函数对象时保存父级作用域以及代码块
结构体是指，闭包（严格意义上的闭包）存储的是两个部分：函数和自由变量
最后一句是<strong>重点</strong></p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343951.png" alt="image-20211231220821635"></p> <ul><li>js 中闭包的解释</li></ul> <blockquote><p>第一句说明，闭包是函数和自由变量</p></blockquote> <p>这种函数也是闭包，自由变量是全局中的 name</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343952.png" alt="image-20220101131244966"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343953.png" alt="image-20211231220904747"></p> <ul><li>总结</li></ul> <p>广义的是<strong>可以访问</strong>，狭义的是<strong>访问了</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343954.png" alt="image-20211231235524465"></p> <h3 id="高阶函数在内存中的执行过程"><a href="#高阶函数在内存中的执行过程" class="header-anchor">#</a> 高阶函数在内存中的执行过程</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343955.png" alt="image-20211231232714480"></p> <p>首先是编译阶段，创建<code>GlobalObject</code>对象，扫描全局代码，扫描到<code>function foo()</code>代码，会在堆内存中创建函数存储空间（函数对象，里面保存了父级作用域以及代码块），并且挂载这个地址给 GO 对象，扫描到<code>var fn = foo()</code>时并不会执行<code>foo()</code>，但是会在 GO 中挂载值为 undefined 的<code>fn</code>属性。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343956.png" alt="image-20211231233019414"></p> <p>执行阶段，第一步将 GEC 中的 VO 指向 GO，第二部执行全局代码。执行到<code>var fn = foo()</code>时，会执行<code>foo()</code>，此时会将 foo 的函数执行上下文入栈，同时经过两步（<strong>第一步</strong>创建 AO 并且 VO 指向 AO，AO 创建的时候扫描代码块中的代码，扫描到<code>function bar()</code>，就会创建 bar 的函数存储空间，扫描结束，<strong>第二步</strong>执行代码，也就是执行 return bar），执行完两步之后将 foo 函数的执行上下文出栈，然后将 bar 的函数存储空间的地址赋值给 fn，此时<code>var fn = foo()</code>代码结束</p> <p>​ <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343957.png" alt="image-20211231233601969"></p> <p>下面执行<code>fn()</code>，因为是函数执行，所以也要创建函数执行上下文并且入栈，以及创建属于 fn 的 AO 对象等等，执行完代码块的代码之后也将函数执行上下文出战</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343958.png" alt="image-20211231233722552"></p> <h3 id="闭包到底是什么"><a href="#闭包到底是什么" class="header-anchor">#</a> 闭包到底是什么</h3> <p><strong>闭包是两部分组成的</strong>：函数+可以访问的自由变量</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343959.png" alt="image-20211231234403417"></p> <p>在 foo 函数执行完之后，本来里面的内容应该销毁的（执行完函数，foo 的函数执行上下文本应该出栈，并且 AO 应该被销毁），但是在执行 fn 的时候又能访问到 name。</p> <p>这是因为<strong>bar 这个函数以及 bar 函数内部可以访问到的自由变量</strong>（name）组成了闭包，使得 foo 的 AO 没有销毁。</p> <p>本质上是 GO 中的 fn 指向 bar 函数对象（因为 return 了 bar 将 bar 的函数对象地址赋值给了 fn），所以 bar 函数对象不会销毁。<strong>bar 函数对象的 parentScope 中指向了 foo 中的 AO ，所以 foo 的 AO 不会销毁。</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343960.png" alt="image-20220101134032604"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343961.png" alt="image-20220101134245272"></p> <h3 id="闭包的内存泄漏"><a href="#闭包的内存泄漏" class="header-anchor">#</a> 闭包的内存泄漏</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343962.png" alt="image-20220101134702729"></p> <p>这种情况下，bar 函数只被调用一次，但是 bar 的函数对象一直在堆内存中保存（因为全局中有一个 fn 一直指向着 bar 函数对象），进而导致 bar 的 parentScope（也就是 AO）也一<strong>直在堆内存中保存</strong>（因为 bar 的 parentScope 指向 foo 函数的 AO），导致了内存泄漏（本应被回收的却没被回收）。</p> <p>只需要将 fn 置为 null 即可解决内存泄漏问题，此时虽然在 GO 中仍然存有 foo 的函数对象的引用，但是 fn 指向了 null 而非指向 bar 函数对象，<strong>虽然此时 bar 函数对象和 foo 的 AO 对象形成了循环引用</strong>，但是根据 gc 垃圾回收的新算法，即便他们之间有循环引用，<strong>但是从根开始访问不到</strong>他们俩，那么他们俩就会被回收</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343963.png" alt="image-20220101135255206"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343964.png" alt="image-20220101135305443"></p> <h4 id="极端的案例"><a href="#极端的案例" class="header-anchor">#</a> 极端的案例</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createFnArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//创建1024*1024长度的数组，并且填充内容</span>
  <span class="token comment">//整数是4个字节，字符是8个字节，</span>
  <span class="token comment">//这个数组占了1024*1024*4字节 = 4MB</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> arrayFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//在push之前，会执行一次createFnArray函数</span>
  <span class="token comment">//执行函数的前会先将该函数的执行上下文入栈，创建该函数的AO，</span>
  <span class="token comment">//扫描到第五行的时候AO里面是arr:undefined</span>
  <span class="token comment">//扫描到return function()时，在堆内存中创建了匿名函数的对象（里面有父级作用域AO以及代码块），并且挂载地址到AO中</span>
  <span class="token comment">//第二步是执行代码，先是给arr赋值了长度为4兆的数组，然后返回AO中函数的地址</span>
  <span class="token comment">//此时，createFnArray的函数执行上下文出栈</span>
  <span class="token comment">//并且将返回的AO中的函数地址存入arrayFns中，此时即使createFnArray的上下文出栈了，但是在GO中有arrayFns保存了一个函数的地址</span>
  <span class="token comment">//这个函数地址指向了堆中对应的匿名函数，而这个匿名函数中也有父级作用域（也就是原来createFnArray函数的AO）</span>
  <span class="token comment">//所以即使createFnArray出栈了，但是AO仍然不会销毁，会停留在堆内存中</span>
  arrayFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createFnArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  arrayFns <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343966.png" alt="image-20220101173039197"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343967.png" alt="image-20220101174001594"></p> <p>设置定时器后</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343968.png" alt="image-20220101183409069"></p> <p>点击<img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343969.png" alt="image-20220101183340768">并且手动刷新页面，可以看到一段时间之后内存被 GC 销毁了</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343970.png" alt="image-20220101174359090"></p> <p>其实就是，执行了一百次的 push 操作，push 的是<code>createFnArray()</code>返回的<strong>函数地址</strong>，而在调用 createFnArray 的时候解析到有<code>function()</code>会创建对应的函数对象，在这个函数对象中保存了<strong>父级作用域</strong>（也就是 createFnArray 函数的 AO）。这些函数地址一直保存在数组中，所以从<strong>根开始可以访问到每次执行函数创建的 AO</strong>，所以那些 AO 会留在堆内存中，导致内存泄漏。</p> <blockquote><p>注意，函数的 AO 只有在执行函数的时候才会创建</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343971.png" alt="image-20220101190645445"></p> <h3 id="闭包引用的自由变量的销毁"><a href="#闭包引用的自由变量的销毁" class="header-anchor">#</a> 闭包引用的自由变量的销毁</h3> <blockquote><p>AO 中<strong>没有被用到的属性</strong>会被 v8 引擎回收，下面是验证（图中的 Closure foo 是指 bar 和外面的自由变量组成的闭包访问的是 foo 中的自由变量）</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'wjj'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//写debugger的话，网页中运行代码到这行debugger的时候，会停下来，并且可以查看内存等情况</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343972.png" alt="image-20220101194300668"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343973.png" alt="image-20220101194320943"></p> <h1 id="_05、this"><a href="#_05、this" class="header-anchor">#</a> 05、this</h1> <p>注意，this 指向的是<strong>对象</strong></p> <h2 id="this-在全局作用域中的指向"><a href="#this-在全局作用域中的指向" class="header-anchor">#</a> this 在全局作用域中的指向</h2> <ul><li><p>浏览器环境下：window（GlobalObject）</p></li> <li><p>Node 环境：{}，因为</p></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343974.png" alt="image-20220101195954363"></p> <blockquote><p>在 node 中，声明的变量不会挂载到全局的 this 上</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343975.png" alt="image-20220109185002319"></p> <h2 id="this-在函数中的指向"><a href="#this-在函数中的指向" class="header-anchor">#</a> this 在函数中的指向</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343976.png" alt="image-20220101200324928"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343977.png" alt="image-20220101200409620"></p> <h2 id="this-的绑定规则"><a href="#this-的绑定规则" class="header-anchor">#</a> this 的绑定规则</h2> <h3 id="默认绑定"><a href="#默认绑定" class="header-anchor">#</a> 默认绑定</h3> <p><strong>独立的</strong>函数调用，我们可以理解成函数没有绑定到<strong>某个对象</strong>上进行调用</p> <blockquote><p>注意区别 <code>a.foo1()</code>和 <code>let b = a.foo1 ; b()</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//案例1</span>
<span class="token keyword">function</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出三次window</span>

<span class="token comment">//案例2</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//这里只是将obj中的foo属性值赋值给fn</span>
<span class="token comment">//这个属性值保存的是function的指向</span>
<span class="token comment">//fn是独立的函数调用，没有依赖于其他的任何对象</span>
<span class="token keyword">var</span> fn <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出window</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出window</span>
</code></pre></div><p>注意</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'222'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'111'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">say</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fun <span class="token operator">=</span> a<span class="token punctuation">.</span>say<span class="token punctuation">;</span>
<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'333'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">say</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

b<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>say<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这个也是默认绑定哦，因为输出的this是say内部的func，而这个func没有使用任何绑定规则</span>

b<span class="token punctuation">.</span>say <span class="token operator">=</span> a<span class="token punctuation">.</span>say<span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="隐式绑定"><a href="#隐式绑定" class="header-anchor">#</a> 隐式绑定</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343978.png" alt="image-20220101203823889"></p> <p><code>object.fn()</code> object 对象会被作为函数中的 this</p> <blockquote><p>前提是<strong>fn 属性保存的必须是函数的引用</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//案例1</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'wjj'</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span>foo
<span class="token punctuation">}</span>

obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//输出obj</span>

<span class="token comment">//案例2</span>
<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&quot;obj1&quot;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&quot;obj2&quot;</span><span class="token punctuation">,</span>
 	<span class="token comment">//在bar属性中保存的是function的指向，所以输出的是obj2</span>
    <span class="token literal-property property">bar</span><span class="token operator">:</span>obj1<span class="token punctuation">.</span>foo
<span class="token punctuation">}</span>
<span class="token comment">//通过obj2运行function</span>
obj2<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="显示绑定"><a href="#显示绑定" class="header-anchor">#</a> 显示绑定</h3> <p>通过 call，apply，bind 来调用函数</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343985.png" alt="image-20220101210100851"></p> <ul><li>call 和 apply</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//call和apply有什么区别？主要是传参的区别，</span>
<span class="token comment">//apply第二个参数是一个数组，里面保存了要传入function的参数</span>
<span class="token comment">//call要传入的参数放在第二个参数及以后</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num1 <span class="token operator">+</span> num2 <span class="token operator">+</span> num3<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this指向的是对象{name:&quot;wjj1&quot;}</span>
<span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this指向的是对象{name:&quot;wjj2&quot;}</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343986.png" alt="image-20220101211136666"></p> <ul><li>bind</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343987.png" alt="image-20220102195639858"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//bind函数会生成一个新的函数对象，</span>
<span class="token comment">//这里默认绑定和显示绑定发生冲突，高优先级（显示绑定）</span>
<span class="token comment">//并且bind函数不会影响原函数</span>
<span class="token keyword">var</span> newFoo <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">newFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="new-绑定"><a href="#new-绑定" class="header-anchor">#</a> new 绑定</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343988.png" alt="image-20220101211626210"></p> <p>构造函数，<strong>通过 new 执行方法</strong>，每次会创建一个新的对象，返回的是 this 的指向（也就是创建的对象的引用）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343989.png" alt="image-20220101211752136"></p> <p>注意，变量和对象的属性的区别</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343990.png" alt="image-20220109181312970"></p> <h3 id="特殊规则"><a href="#特殊规则" class="header-anchor">#</a> 特殊规则</h3> <h4 id="忽略显示绑定"><a href="#忽略显示绑定" class="header-anchor">#</a> 忽略显示绑定</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出window</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出window</span>
</code></pre></div><h4 id="间接函数引用"><a href="#间接函数引用" class="header-anchor">#</a> 间接函数引用</h4> <blockquote><p>注意，<code>(obj1.foo)()</code>跟<code>obj1.foo()</code>是一样的，而<code>(obj2.bar = obj1.foo)()</code>这个赋值语句的返回值是 obj1.foo，<strong>本质上是取出了 obj1.foo 的地址，独立函数调用</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'obj1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'obj2'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//注意一定要写这个;号，不然无法解析，会报错，解析器会以为代码还没结束，吧{}()当成一个整体了</span>

<span class="token comment">//将obj1.foo赋值给obj2.bar，这是个赋值表达式</span>
<span class="token comment">//赋值表达式的话会取出obj1.foo并且返回</span>
<span class="token comment">//返回的是function的内存地址，在这里进行调用</span>
<span class="token comment">//这里其实就是独立函数调用了，输出的是window</span>
<span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>bar <span class="token operator">=</span> obj1<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token comment">//区分的点。下面的代码跟执行obj1.foo是一个效果的</span>
  obj1<span class="token punctuation">.</span>foo
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>关于()的话，我个人的理解是，里面可以放一句 js 代码，返回这个 js 代码的结果</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343991.png" alt="image-20220101231241299"></p> <p>关于分号，下图中的 obj 定义的末尾也要写分号，不然会报错，他会把<code>{id:'awesome'}[1,2,3]</code>当做一个整体，这个整体不是数组，自然会报错</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343992.png" alt="image-20220101231520233"></p> <h3 id="箭头函数的-this-获取"><a href="#箭头函数的-this-获取" class="header-anchor">#</a> 箭头函数的 this 获取</h3> <blockquote><p>箭头函数中的 this 不适用上面介绍的四种绑定规则。</p></blockquote> <p>应用场景</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343993.png" alt="image-20220101235140409"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343994.png" alt="image-20220101235235497"></p> <p>总而言之，箭头函数中的 this 绑定的是<strong>定义时</strong>所在的作用域。</p> <blockquote><p>注意，如果箭头函数是在普通 function 中定义的，那么箭头函数的 this 会指向这个 function，当 function 的 this 因为四种绑定规则而改变时，箭头函数的 this 也会跟着改变。</p></blockquote> <ul><li>当箭头函数是声明为<strong>字面量对象的方法</strong>时，因为<strong>对象是没有独立的作用域的</strong>，所以会向上找 this 的定义。</li> <li>如果箭头函数是在<strong>构造方法里面声明成对象的方法</strong>，因为函数是有作用域的，所以这个对象的方法的箭头函数中的 this 指向的是构造方法中的 this</li></ul> <h2 id="this-绑定规则细节"><a href="#this-绑定规则细节" class="header-anchor">#</a> this 绑定规则细节</h2> <h3 id="一些内置函数的-this-分析-△△△△△"><a href="#一些内置函数的-this-分析-△△△△△" class="header-anchor">#</a> 一些内置函数的 this 分析 △△△△△</h3> <hr> <p><code>setTimeout</code>在函数实现的地方是通过独立调用函数来执行函数的，所以传入的<code>function</code>中输出的 this 指向 window</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343995.png" alt="image-20220101220345463"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343996.png" alt="image-20220101220335772"></p> <hr> <p>监听事件</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343997.png" alt="image-20220101220535878"></p> <p>输出的 this 是 dom 元素</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343998.png" alt="image-20220101220615873"></p> <p>内部是通过<code>boxDiv.onclick</code>隐式调用来绑定的（可能）</p> <hr> <p>数组的<code>forEach/map/filter/find</code></p> <p>这个<strong>thisArg</strong>的参数要表达的是，<strong>第二个参数可以传入以修改 this 的指向</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343999.png" alt="image-20220101221104762"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//forEach的第二个参数是传入this的绑定对象</span>
<span class="token comment">//如果不传入第二个参数，会默认this绑定window</span>
names<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="this-绑定规则的优先级"><a href="#this-绑定规则的优先级" class="header-anchor">#</a> this 绑定规则的优先级</h3> <p>总结：默认 &lt; 隐式 &lt; 显示 &lt; new</p> <h4 id="_1、默认绑定优先级最低"><a href="#_1、默认绑定优先级最低" class="header-anchor">#</a> 1、默认绑定优先级最低</h4> <h4 id="_2、显示绑定高于隐式绑定"><a href="#_2、显示绑定高于隐式绑定" class="header-anchor">#</a> 2、显示绑定高于隐式绑定</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> newFoo <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> foo<span class="token punctuation">,</span>
  newFoo<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//隐式绑定</span>
obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Object{name:'wjj',foo:foo()}</span>

<span class="token comment">//显示绑定</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//String(&quot;abc&quot;)</span>

<span class="token comment">//显示绑定＋隐式绑定 （call/apply)</span>
obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'abcd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//String(&quot;abcd&quot;)</span>

<span class="token comment">//显示绑定＋隐式绑定 （bind）</span>
obj<span class="token punctuation">.</span><span class="token function">newFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//String(&quot;123&quot;)</span>
</code></pre></div><blockquote><p>注意，bind 的优先级高于 call 和 apply</p></blockquote> <h4 id="_3、new-绑定优先于隐式绑定"><a href="#_3、new-绑定优先于隐式绑定" class="header-anchor">#</a> 3、new 绑定优先于隐式绑定</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343000.png" alt="image-20220101222634641"></p> <h4 id="_4、new-绑定优先于显示绑定"><a href="#_4、new-绑定优先于显示绑定" class="header-anchor">#</a> 4、new 绑定优先于显示绑定</h4> <p>new 关键字不能和 apply / call 一起来使用</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343001.png" alt="image-20220101222858415"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343002.png" alt="image-20220101223118003"></p> <h2 id="面试题"><a href="#面试题" class="header-anchor">#</a> 面试题</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'222'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'111'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">say</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fun <span class="token operator">=</span> a<span class="token punctuation">.</span>say<span class="token punctuation">;</span>
<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//222</span>
a<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//111</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'333'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">say</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

b<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>say<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//222</span>
b<span class="token punctuation">.</span>say <span class="token operator">=</span> a<span class="token punctuation">.</span>say<span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//333</span>
</code></pre></div><p>上面倒数第二个输出 222 是因为，<strong>在 say 内部调用的函数没有使用任何绑定规则</strong>，使用默认绑定</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'person'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">sayName</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//默认绑定，将function的地址赋值给sss，然后独立调用</span>
  <span class="token keyword">var</span> sss <span class="token operator">=</span> person<span class="token punctuation">.</span>sayName<span class="token punctuation">;</span>
  <span class="token function">sss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window</span>

  <span class="token comment">//隐式绑定</span>
  person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person</span>

  <span class="token comment">//相当于是person.sayName(),隐式调用</span>
  person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person</span>

  <span class="token comment">//获取person.sayName的地址，独立调用</span>
  <span class="token punctuation">(</span>b <span class="token operator">=</span> person<span class="token punctuation">.</span>sayName<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window</span>
<span class="token punctuation">}</span>
<span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>关于闭包和 this，在网上有这种说法：</p> <p>1：在闭包函数中，<strong>不使用 this</strong>对变量进行访问时，函数会通过文法环境中的外部引用，一级一级地向上找（<strong>作用域链</strong>），直到找到（或者最终找不到）对应的变量。这个作用域链是在<strong>函数定义的时候就决定</strong>了的</p> <p>2：在函数闭包中，<strong>使用 this</strong>对变量进行访问时，和大多数语言不同，JavaScript 的 this 保存的是<strong>调用环境的上下文</strong>。也就是说 this 中的内容是在<strong>调用的时候决定</strong>的，所以访问到的是当前环境下的对应的变量，并不会像前一种情况一样进行逐级查找。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'person1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo3</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo4</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">foo5</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">foo6</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'person2'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，隐式调用</span>
person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2，隐式调用和显示调用结合</span>

person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window，对象是没有作用域的，所以箭头函数处在的作用域是window</span>
person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//箭头函数不适用绑定规则，且对象是没有作用域的，所以箭头函数处在的作用域是window</span>

person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用函数，获取函数的引用，然后独立调用，输出window</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window，独立函数调用</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2，显示绑定</span>

person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1,因为箭头函数的上层this是person1隐式绑定调用的function的this</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2，因为箭头函数的上层this是person2显示绑定调用的function中的this</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，因为箭头函数的上层this是person1隐式调用的function，用call来绑定是不会改变this的指向的</span>

person1<span class="token punctuation">.</span>foo5<span class="token punctuation">.</span><span class="token function">foo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//windwo,对象是没有作用域的，所以foo6定义的箭头函数的this指向的是window</span>
</code></pre></div><p>我个人的总结，<strong>对象<code>{}</code>是没有作用域的</strong>，在这个<code>{}</code>对象中声明箭头函数作为方法，会向这个对象外去找作用域的定义，而通过<strong>构造方法创建的对象</strong>，在这个对象中声明箭头函数，<strong>因为构造方法（函数）是有作用域的</strong>，那么在这个对象中声明的箭头函数<strong>作为方法</strong>，那么这个箭头函数的 this 指向的就是构造方法中的<code>this</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo1</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo3</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo4</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>me <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">do</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">person</span><span class="token punctuation">(</span><span class="token string">'person1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">person</span><span class="token punctuation">(</span><span class="token string">'person2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1</span>
person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2</span>

person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，因为函数是有作用域的，箭头函数定义的地方向外找，发现有一层function围住了，所以箭头函数的this取决于这个function的this</span>
person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，call对箭头函数的this不起作用</span>

person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window,独立函数调用</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window，独立函数调用</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2</span>

person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，person1.foo4调用的话，function指向的是person1，那么function中的箭头函数的this指向的就是这个function中的this</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2，通过person1.foo4.call(person2)调用function，那么这个function中的this指向的是person2，那么箭头函数指向的就是这个functino中的this</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，foo4使得function中的this绑定的是person1，那么箭头函数的this也是person1</span>

person1<span class="token punctuation">.</span>me<span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person1，因为对象字面量是没有作用域的，所以this处于的作用域是构造方法的作用域，指向构造方法的this</span>
</code></pre></div><p>箭头函数总结</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//对于下面这种代码形式，箭头函数是写在function函数中的，那么此时，箭头函数的this取决于这个function函数的this指向</span>
<span class="token function-variable function">foo2</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//对于下面这种代码形式，箭头函数是作为对象字面量的方法的，对象字面量没有作用域，那么箭头函数中的this就会向这个对象a外面去找，直到找到window或者有this 的定义为止</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">b</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//对于下面这种代码形式，箭头函数是构造方法中声明的，作为对象的方法，由于这个箭头函数外部有一层function包裹（function是有作用域的），所以这里的箭头函数的this指向的是构造方法创建出来的对象</span>
<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'obj'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window，独立函数调用</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window,独立函数调用</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2，显示绑定</span>

person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//obj，通过person.obj.foo2()调用的function，function内部的this指向obj，因为这里的箭头函数所处的作用域取决于foo2这个函数，所以this指向也是obj</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//person2，通过person1.obj.foo2.call(person2)调用的function，funciton内部指向的是person2，所以function内部所处的作用域指的this指向的是person2</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//obj，通过person.obj.foo2()调用的function，function内部的this指向obj，所以this指向也是obj，call无法改变箭头函数的this</span>
</code></pre></div><p>总结：<strong>如果是判断箭头函数的 this 的话，需要先向外找作用域（看看有没有被某个 function 包裹，没有就是全局）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//独立调用，输出window</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="_06、call、apply-和-bind-的实现"><a href="#_06、call、apply-和-bind-的实现" class="header-anchor">#</a> 06、call、apply 和 bind 的实现</h1> <p>下面的实现都还有一些问题，例如传入参数显示绑定的时候，我们是将 fn（也就是后面要执行的函数对象）挂载到传入<strong>参数的 fn 属性</strong>上的，假如传入的参数是一个对象，里面有 fn 属性，那就会造成影响（这个时候就要用 es6 的<strong>symbol</strong>来解决）</p> <p>下面的 fn 是用于获取调用方法的<strong>函数对象</strong>，thisArg 用于<strong>隐式绑定</strong>this</p> <h2 id="call-实现"><a href="#call-实现" class="header-anchor">#</a> call 实现</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//给所有的函数添加一个wjjCall方法，第二个参数为“剩余参数”</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">wjjCall</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">thisArg<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//2、对类thisArg转换成对象类型（防止它传入的是非对象的值）</span>
  <span class="token comment">//另外还要考虑传入的是null和undefined的情况，这个情况的this指向window</span>
  <span class="token comment">//不能像下面直接这样，不然传入0或者是空字符串的话就会绑定window</span>
  <span class="token comment">//thisArg = thisArg ? Object(thisArg) : window</span>
  thisArg <span class="token operator">=</span>
    thisArg <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> thisArg <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">;</span>

  <span class="token comment">//1、获取函数对象，因为是通过function.wjjCall来调用的方法，有隐式绑定，可以通过this获取到调用时的function对象</span>
  <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token comment">//系统的call方法可以传入参数作为函数的this</span>
  <span class="token comment">//这里给传入的参数添加一个fn属性，值为fn，相当于隐式绑定</span>
  thisArg<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>

  <span class="token comment">//通过thisArg.fn()调用函数，隐式绑定，fn中的this指向的就是thisArg了</span>
  <span class="token comment">//但是有一个缺点就是，输出的this中会有fn属性</span>
  <span class="token comment">//传参的话用展开运算符来传参</span>
  <span class="token comment">//3、调用需要被执行的函数</span>
  <span class="token keyword">var</span> res <span class="token operator">=</span> thisArg<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">delete</span> thisArg<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
  <span class="token comment">//4、返回结果</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo函数被执行'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//系统的call方法</span>
<span class="token comment">// foo.call(&quot;jzsp&quot;)</span>
foo<span class="token punctuation">.</span><span class="token function">wjjCall</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="apply-实现"><a href="#apply-实现" class="header-anchor">#</a> apply 实现</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">wjjApply</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">thisArg<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取函数对象</span>
  <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token comment">//修改thisArg防止传入的是非对象的值,如果是null或者是undefined，就指向window</span>
  thisArg <span class="token operator">=</span>
    thisArg <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> thisArg <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">;</span>
  thisArg<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>

  <span class="token comment">//处理无参调用，因为接收的时候没有用剩余参数运算符，没传入参数的话会是undefined（否则是空数组）</span>
  arr <span class="token operator">=</span> arr <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> res <span class="token operator">=</span> thisArg<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> thisArg<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>

  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//系统的apply方法中传入一个参数的话也必须要放到一个数组中，否则会报错，所以我们这里不需要处理</span>
<span class="token comment">// foo.wjjApply(&quot;wjj&quot;,1)</span>

<span class="token comment">//系统的apply方法可以不传入参数，就是无参调用</span>
foo<span class="token punctuation">.</span><span class="token function">wjjApply</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="bind-实现"><a href="#bind-实现" class="header-anchor">#</a> bind 实现</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//这里的argArray接收的是bind传入的参数，充当返回的函数的默认参数用</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">wjjBind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">thisArg<span class="token punctuation">,</span> <span class="token operator">...</span>argArray</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//1、获取到真实需要调用的函数</span>
  <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token comment">//2、绑定this</span>
  thisArg <span class="token operator">=</span>
    thisArg <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> thisArg <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">;</span>
  <span class="token comment">//这里的arr接收的是调用函数的时候传的参数</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//3、隐式绑定this</span>
    thisArg<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
    <span class="token comment">//这里需要将两处传入的参数进行拼接，并且bind的参数在前，调用function传入的参数在后</span>
    <span class="token keyword">var</span> res <span class="token operator">=</span> thisArg<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>argArray<span class="token punctuation">,</span> <span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> thisArg<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num3<span class="token punctuation">,</span> num4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> num1<span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num3<span class="token punctuation">,</span> num4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">wjjBind</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bar2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">bar2</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="arguments"><a href="#arguments" class="header-anchor">#</a> arguments</h2> <p>arguments 对象的属性描述如下</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343003.png" alt="image-20220118203130155"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343004.png" alt="image-20220102203807083"></p> <h3 id="将-arguments-转成数组"><a href="#将-arguments-转成数组" class="header-anchor">#</a> 将 arguments 转成数组</h3> <h4 id="第一种方法-prototype"><a href="#第一种方法-prototype" class="header-anchor">#</a> 第一种方法(prototype)</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//因为arguments不是数组类型，所以不能调用slice方法（slice方法可以将选中的内容封装到数组中）</span>
  <span class="token comment">//获取到slice方法之后，通过call方法显示绑定this给原型</span>
  <span class="token keyword">var</span> newArr <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//也可以这么写</span>
  <span class="token comment">//[].slice.call(arguments)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>slice 内部<strong>大致</strong>是像下面一样实现的(但是下面没有判断传入的第二个参数为负数的情况)</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343005.png" alt="image-20220102205019754"></p> <h4 id="第二种方法-array-from"><a href="#第二种方法-array-from" class="header-anchor">#</a> 第二种方法(Array.from)</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343006.png" alt="image-20220102211457399"></p> <h4 id="第三种方法"><a href="#第三种方法" class="header-anchor">#</a> 第三种方法(...)</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> newArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="箭头函数没有-arguments"><a href="#箭头函数没有-arguments" class="header-anchor">#</a> 箭头函数没有 arguments</h3> <p>因为箭头函数中没有 arguments，那么会向上层作用域中去找。有两种情况</p> <ul><li><strong>node 中的全局</strong>是有 arguments 的，因为<strong>模块</strong>本质上是把他放到了函数中运行</li> <li><strong>浏览器全局</strong>是没有 arguments 的</li></ul> <p>没有 arguments 的话，要怎么在箭头函数中获取多余的参数呢？答案是用 es6 的剩余参数运算符来接收其他的参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num1<span class="token punctuation">,</span> <span class="token operator">...</span>nums</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[2,3]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="_07、js-函数式编程-编程范式"><a href="#_07、js-函数式编程-编程范式" class="header-anchor">#</a> 07、JS 函数式编程（编程范式）</h1> <h2 id="纯函数-pure-function"><a href="#纯函数-pure-function" class="header-anchor">#</a> 纯函数（Pure function）</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343007.png" alt="image-20220102223028684"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343008.png" alt="image-20220115101454510"></p> <p><strong>严格意义上来说</strong>，<code>console.log</code>是不允许出现在纯函数中的，因为进行了输出设备<strong>输出</strong>，但是它可以在测试的时候用。。</p> <p>副作用</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343009.png" alt="image-20220115101549926"></p> <h3 id="数组的两个函数对比"><a href="#数组的两个函数对比" class="header-anchor">#</a> 数组的两个函数对比</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//slice是一个纯函数，对于同一个数组来说，传入同样的值，返回的值也是确定的</span>
<span class="token comment">//slice不会修改原数组</span>
<span class="token keyword">var</span> newname <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//splice会修改掉调用该函数的数组，修改这个操作就是副作用</span>
<span class="token comment">//那么这个splice就不是一个纯函数了</span>
<span class="token keyword">var</span> name2 <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="练习-判断是否是纯函数"><a href="#练习-判断是否是纯函数" class="header-anchor">#</a> 练习，判断是否是纯函数</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>info<span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">test</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是纯函数，相同输入会有相同输出，并且没有修改原来的值</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  info<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">test</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不是纯函数，修改了原来的值，产生了副作用</span>
</code></pre></div><h2 id="柯里化"><a href="#柯里化" class="header-anchor">#</a> 柯里化</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343010.png" alt="image-20220115110922342"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343011.png" alt="image-20220115111454707"></p> <p>例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> n3<span class="token punctuation">,</span> n4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2 <span class="token operator">+</span> n3 <span class="token operator">+</span> n4<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token parameter">n1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2 <span class="token operator">+</span> n3 <span class="token operator">+</span> n4<span class="token punctuation">;</span> <span class="token comment">//有闭包，可以找到外面的变量</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//用箭头函数简化柯里化</span>
<span class="token keyword">var</span> <span class="token function-variable function">a1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">n2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">n3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">n4</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n1 <span class="token operator">+</span> n2 <span class="token operator">+</span> n3 <span class="token operator">+</span> n4<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10</span>
</code></pre></div><h3 id="单一职责原则"><a href="#单一职责原则" class="header-anchor">#</a> 单一职责原则</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//假如现在要实现的是 (n1+1) + (n2 * 2) + (n3 ** 3)</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> n3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> n2 <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> n3 <span class="token operator">*</span> n3 <span class="token operator">*</span> n3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  n1 <span class="token operator">=</span> n1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">n2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    n2 <span class="token operator">=</span> n2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">n3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      n3 <span class="token operator">=</span> n3 <span class="token operator">*</span> n3 <span class="token operator">*</span> n3<span class="token punctuation">;</span>
      <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2 <span class="token operator">+</span> n3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="逻辑的复用"><a href="#逻辑的复用" class="header-anchor">#</a> 逻辑的复用</h3> <p>样例 1</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//假如在程序中，我们经常需要把5和另外一个数字进行相加</span>
<span class="token keyword">var</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> count5 <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> res1 <span class="token operator">=</span> <span class="token function">count5</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> res2 <span class="token operator">=</span> <span class="token function">count5</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> res3 <span class="token operator">=</span> <span class="token function">count5</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">,</span> res2<span class="token punctuation">,</span> res3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//6,7,8</span>
</code></pre></div><p>样例 2</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//打印日志的函数</span>
<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">date<span class="token punctuation">,</span> type<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>date<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>date<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'DEBUG'</span><span class="token punctuation">,</span> <span class="token string">'查找轮播图的bug1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[11:37] [DEBUG]:[查找轮播图的bug1]</span>

<span class="token keyword">function</span> <span class="token function">log2</span><span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>date<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>date<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//可以用柯里化复用函数的功能来&quot;定制&quot;函数</span>
<span class="token keyword">var</span> debug <span class="token operator">=</span> <span class="token function">log2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'DEBUG'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> warn <span class="token operator">=</span> <span class="token function">log2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'WARN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'这个是debug'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这样就不需要每次都传入date和type了</span>

<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'这个是warn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="柯里化函数的实现-☆☆☆☆"><a href="#柯里化函数的实现-☆☆☆☆" class="header-anchor">#</a> 柯里化函数的实现 ☆☆☆☆</h3> <p>主要是理解递归的调用以及参数拼接</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//传入一个函数，返回这个函数的柯里化结果</span>
<span class="token keyword">function</span> <span class="token function">wjjCurrying</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">curried</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果参数个数大于fn的参数，那么就直接执行，并且返回执行结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> fn<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//用apply调用函数的话防止this的指向改变了</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//否则就返回一个可以继续接收参数的函数</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//这个返回的函数内部要返回的内容也是要进行相同操作的，所以直接调用curried</span>
      <span class="token comment">//这里传入的第二个参数是将前面接收的所有参数和当前接收的参数拼接起来</span>
      <span class="token comment">//所以在外面判断长度的话就是判断的总共传入多少个参数和总参数比较</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">curried</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token operator">...</span>args2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">wjjCurrying</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="组合函数"><a href="#组合函数" class="header-anchor">#</a> 组合函数</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343012.png" alt="image-20220115124026373"></p> <p>例子</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343013.png" alt="image-20220115124327236"></p> <p>组合后的函数（这个返回的函数执行的功能跟上面的一样，先乘 2 再平方，也就是先执行里面的 m 函数再执行后面的 n 函数）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343014.png" alt="image-20220115124342964"></p> <h3 id="组合函数的实现"><a href="#组合函数的实现" class="header-anchor">#</a> 组合函数的实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fnc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//传入了几个函数对象</span>
  <span class="token keyword">var</span> length <span class="token operator">=</span> fnc<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token comment">//判断是否全部传入的是function对象</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fnc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'要求传入的都是函数类型'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//如果length不是0的话，就先保存fnc中第一个函数的执行结果res</span>
    <span class="token keyword">var</span> res <span class="token operator">=</span> length <span class="token operator">?</span> fnc<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//在这里将上一个函数的调用结果作为参数进行调用</span>
      res <span class="token operator">=</span> fnc<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dou</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> count <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token function">dou</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//生成一个新的函数，依次从前往后执行dou和sqr</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">compo</span><span class="token punctuation">(</span>dou<span class="token punctuation">,</span> sqr<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//如果没有传入函数对象构成组合函数的话，就返回传入的arg</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">compo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[1,2,3,4,5]</span>
</code></pre></div><h1 id="_08、with-eval-strict"><a href="#_08、with-eval-strict" class="header-anchor">#</a> 08、with-eval-strict</h1> <h2 id="with-语句-不推荐使用"><a href="#with-语句-不推荐使用" class="header-anchor">#</a> with 语句（不推荐使用）</h2> <p>with 语句也是会有自己的作用域的，使用 with 的时候，跟 if 一样需要在小括号里传入一些东西，with 传入的是一个对象，里面封装了各种键值对。那么在 with 语句块里查找变量的话，<strong>会先在对象中查找，然后再一层一层往上层作用域查找</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">'GO message'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'obj message'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">with</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以这样理解，当我们传递 o1 给 with 时，with 所声明的作用域是 o1，而这个作用域中包含有一个同 o1.a 属性相符的标识符。但当我们将 o2 作为作用域时，其中并没有 a 标识符，<strong>因此进行了正常的 LHS 查找</strong>，一直查找到全局都没找到，所以在全局中创建了 a 属性并且赋值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">with</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> o2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//因为o2中没有a的定义,，所以在执行with中的代码 a = 2的时候，并不会创建这个属性，保持o2.a = undefined，而在全局对象中创建出了a属性并且赋值为2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="eval-函数"><a href="#eval-函数" class="header-anchor">#</a> eval 函数</h2> <p>是一个特殊的函数，可以将传入的字符串当做 js 代码执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> jsString <span class="token operator">=</span> <span class="token string">'var message = &quot;hello&quot;;console.log(message)'</span><span class="token punctuation">;</span>
<span class="token function">eval</span><span class="token punctuation">(</span>jsString<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343015.png" alt="image-20220115165601566"></p> <h2 id="strict-mode"><a href="#strict-mode" class="header-anchor">#</a> strict mode</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343016.png" alt="image-20220115165741888"></p> <h3 id="js-文件开启严格模式"><a href="#js-文件开启严格模式" class="header-anchor">#</a> js 文件开启严格模式</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343017.png" alt="image-20220115170734685"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343019.png" alt="image-20220115170744012"></p> <p>但是真正在项目打包的时候是不需要我们手动给 js 文件中开启严格模式的，因为它<strong>打包</strong>会自动开启严格模式</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343020.png" alt="image-20220115170935738"></p> <h3 id="函数开启严格模式"><a href="#函数开启严格模式" class="header-anchor">#</a> 函数开启严格模式</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343021.png" alt="image-20220115171347982"></p> <h3 id="严格模式下常见的限制"><a href="#严格模式下常见的限制" class="header-anchor">#</a> 严格模式下常见的限制</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343022.png" alt="image-20220115171425552"></p> <p>1.无法 7 意外的创建全局变量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  age <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//意外创建了全局变量</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>2.不允许函数参数有相同名称</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//3，2</span>
</code></pre></div><p>3.不能修改不可修改的属性(如果不开启严格模式的话，不会报错，但是也不能修改)</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343023.png" alt="image-20220115173217656"></p> <p>4.不允许使用原来的八进制格式（0 开头）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//最新的进制格式(下面都是可以在严格模式中用的进制)</span>
<span class="token keyword">var</span> num8 <span class="token operator">=</span> <span class="token number">0o123</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> num16 <span class="token operator">=</span> <span class="token number">0x123</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> num2 <span class="token operator">=</span> <span class="token number">0b100</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num2<span class="token punctuation">,</span> num8<span class="token punctuation">,</span> num16<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>5.严格模式下的 this（默认绑定）指向 undefined</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//window</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//不管在严格模式还是非严格模式，输出的都是window</span>
</code></pre></div><p>chrom 内部 setTimeout 实现</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343024.png" alt="image-20220115174827948"></p> <h1 id="_09、es5-面向对象"><a href="#_09、es5-面向对象" class="header-anchor">#</a> 09、ES5 面向对象</h1> <h2 id="创建对象"><a href="#创建对象" class="header-anchor">#</a> 创建对象</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343025.png" alt="image-20220115190105798"></p> <h2 id="对象的属性"><a href="#对象的属性" class="header-anchor">#</a> 对象的属性</h2> <h3 id="对对象属性的操作"><a href="#对对象属性的操作" class="header-anchor">#</a> 对对象属性的操作</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//获取属性</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//给属性赋值</span>
obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>

<span class="token comment">//删除属性</span>
<span class="token keyword">delete</span> obj<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
</code></pre></div><h3 id="对属性操作的控制"><a href="#对属性操作的控制" class="header-anchor">#</a> 对属性操作的控制</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343026.png" alt="image-20220115190943788"></p> <p><code>Object.defineProperty(obj,property,desc)</code>方法会直接在一个对象上定义一个新的属性，或者修改现有的属性，并且返回该对象</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343027.png" alt="image-20220115191326541"></p> <p>注意，通过这个方法添加的属性<strong>默认</strong>是不可被枚举的，并且这个方法不是一个纯函数，会改变原对象（所以不用接收返回值也行）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ name: 'wjj', age: 18 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//180</span>
</code></pre></div><h4 id="关于第三个参数-desc"><a href="#关于第三个参数-desc" class="header-anchor">#</a> 关于第三个参数 desc</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343028.png" alt="image-20220115192333620"></p> <ul><li>数据属性描述符</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343029.png" alt="image-20220115192441166"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'lover'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">//设置值</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'zyl'</span><span class="token punctuation">,</span>
  <span class="token comment">//说明这个属性不可配置（删除，修改）</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">//说明这个属性是不可被枚举出来的</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">//说明这个属性不可重新赋值（修改）</span>
  <span class="token literal-property property">writeable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">delete</span> obj<span class="token punctuation">.</span>lover<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>lover<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//还是输出zyl</span>

<span class="token comment">//如果设置enumerable为false的话，输出obj中是没有lover属性的(但是浏览器输出obj的话会显示，但是颜色会变成浅色，为了帮助调试)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//通过keys获取所有的key也不显示</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//forin来遍历也不会显示</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意，通过这种 Object.defineProperty 定义的属性的话，那四个配置的属性，三个是 false，一个是 undefined；通过字面量形式创建的话，那三个配置的属性都是 true（value 是创建时声明的值）</p> <ul><li>存取属性描述符</li></ul> <p>隐藏某个一私有属性不希望<strong>直接</strong>被外界使用或者赋值</p> <p>希望获取某一个属性它<strong>访问和设置值的过程</strong>时，也会使用存取属性描述符中的 get 和 set</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">_lover</span><span class="token operator">:</span> <span class="token string">'zyl'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'lover'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">//说明这个属性不可配置（删除，修改）</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">//说明这个属性是不可被枚举出来的</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">//get会在读取的时候调用</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//可以在返回要取的值之前做一些操作</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_lover<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//set会在赋值的时候调用</span>
  <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//可以在设置值之前做一些操作</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_lover <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>lover<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>_lover <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="继承"><a href="#继承" class="header-anchor">#</a> 继承</h2> <h3 id="原型"><a href="#原型" class="header-anchor">#</a> 原型</h3> <p>1.在 JS 里，万物皆对象。方法（Function）是对象，方法的原型(Function.prototype)是对象。因此，它们都会具有对象共有的特点。</p> <p>即：对象具有属性<code>__proto__</code>，可称为<strong>隐式原型</strong>，一个对象的隐式原型指向<strong>构造该对象的构造函数的原型</strong>，这也保证了实例能够访问在构造函数原型中定义的属性和方法。</p> <p>2.方法(Function)</p> <p>方法这个特殊的对象，除了和其他对象一样有上述<code>__proto__</code>属性之外，还有自己特有的属性——原型属性 prototype，这个属性是一个指针，指向一个对象，这个对象的用途就是<strong>包含所有实例共享的属性和方法</strong>（我们把这个对象叫做<strong>原型对象</strong>)。原型对象也有一个属性，叫做 constructor，这个属性包含了一个指针，指回<strong>原构造函数</strong>。</p> <blockquote><p>当某个对象，访问某个属性的时候，会先从自身找，有则直接用，没有则就找到<strong>隐式原型</strong>对象，有则使用，否则就继续，直到找到顶层原型</p></blockquote> <h3 id="原型链"><a href="#原型链" class="header-anchor">#</a> 原型链</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343030.png" alt="image-20220116125335383"></p> <p>顶层原型</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343031.png" alt="image-20220116125547128"></p> <p>虽然原型显示的是<code>[Object:null prototype] {}</code>，因为它声明的属性都是不可枚举的，但是可以通过<code>Object.getOwnPropertyDescriptors()</code>方法来打印出</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343032.png" alt="image-20220116132609865"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343033.png" alt="image-20220116130033774"></p> <p>只要将 obj 的<code>__proto__</code>的<strong>指向修改</strong>为另一个对象，就可以达到继承的效果 <code>obj.__proto__ = obj2</code></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343034.png" alt="image-20220116131850043"></p> <blockquote><p>每个<strong>函数</strong>都有一个显示原型 prototype 对象，凡是对象都有一个隐式属性<code>__proto__</code>，该对象的隐式属性<code>__proto__</code>指向顶层原型，因为该对象本质上是<strong>通过 Object 函数构造</strong>出来的，所以指向 Object 的原型对象。<strong>通过构造方法 new 出来的对象的<code>__proto__</code>会指向这个函数的 prototype 对象</strong></p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343035.png" alt="image-20220116133204583"></p> <blockquote><p>所有类都继承自 Object 类</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343036.png" alt="image-20220116161747531"></p> <h3 id="原型链实现继承"><a href="#原型链实现继承" class="header-anchor">#</a> 原型链实现继承</h3> <h4 id="初步实现"><a href="#初步实现" class="header-anchor">#</a> 初步实现</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343037.png" alt="image-20220116141311285"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'wjj'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eating</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">sno</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//修改Student的默认显示原型为new的Person对象</span>
<span class="token comment">//那么通过new出来的Student对象的原型都会指向这个Person对象</span>
<span class="token comment">//就继承了这个Person对象的所有内容</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1905010502</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="弊端"><a href="#弊端" class="header-anchor">#</a> 弊端</h5> <p>1、打印 stu 对象，某些属性是看不到的（看下图，name 和 age 打印时是无法显示的），因为它只打印 stu 对象中的<strong>可枚举属性</strong>，不包括<code>__proto__</code>中的属性</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343038.png" alt="image-20220116141442807"></p> <p>2、每个 new 出来的 Student 对象的原型都<strong>共享同一个 Person 对象</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>friends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">sno</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'wjj'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stu1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1905010502</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stu2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1905010503</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//因为stu1对象中没有friends，所以会找到原型对象中friends数组的引用，因为stu1和stu2对象的原型都指向同一个person对象</span>
<span class="token comment">//所以两个都输出[&quot;jzsp&quot;]</span>
stu1<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'jzsp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu1<span class="token punctuation">.</span>friends<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[&quot;jzsp&quot;]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu2<span class="token punctuation">.</span>friends<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[&quot;jzsp&quot;]</span>

stu1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span> <span class="token comment">//这个本质上是在stu1中添加name属性，而不是修改原型上的属性</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343039.png" alt="image-20220116142325385"></p> <p>3、在类的实现过程中没有传值</p> <h4 id="借用构造函数优化"><a href="#借用构造函数优化" class="header-anchor">#</a> 借用构造函数优化</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> friends</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>friends <span class="token operator">=</span> friends<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eating</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">sno<span class="token punctuation">,</span> name<span class="token punctuation">,</span> friends</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//借用构造函数，在这里调用Person的构造函数，作为普通的函数来调用</span>
  <span class="token comment">//相当于在这里调用了this.xxx = xxx，这样就可以解决上面的三个问题</span>
  <span class="token comment">//第一个问题，在这里调用构造方法的话，会给当前的student对象添加上name和friends属性，打印时会显示</span>
  <span class="token comment">//第二个问题，因为student对象中有friends属性了，那么每一个student对象中的friends都是不同的，互不影响</span>
  <span class="token comment">//第三个问题，实现了传参</span>
  <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> friends<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stu1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1905010502</span><span class="token punctuation">,</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'jzsp'</span><span class="token punctuation">,</span> <span class="token string">'jzsp2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343040.png" alt="image-20220116143856987"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343041.png" alt="image-20220116144215756"></p> <h5 id="弊端-2"><a href="#弊端-2" class="header-anchor">#</a> 弊端</h5> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343042.png" alt="image-20220116144140146"></p> <h4 id="错误的优化方法"><a href="#错误的优化方法" class="header-anchor">#</a> 错误的优化方法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> friends</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>friends <span class="token operator">=</span> friends<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eating</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">sno<span class="token punctuation">,</span> name<span class="token punctuation">,</span> friends</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> friends<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//社区里有人说，直接将Person的原型赋值给Student的原型，不就没有两次new和两份父类属性了吗？确实如此，但是从面向对象的角度来看是不对的</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token comment">//由于Student的原型指向了Person原型，那么这里相当于是修改了父类的属性，此时如果有其他的类继承了Person，那么其他类中也会有running方法，这样显然是不对的，因为running方法应该是Student类才特有的方法</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">running</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'student '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stu1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1905010502</span><span class="token punctuation">,</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'jzsp'</span><span class="token punctuation">,</span> <span class="token string">'jzsp2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu1<span class="token punctuation">)</span><span class="token punctuation">;</span>
stu1<span class="token punctuation">.</span><span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stu1<span class="token punctuation">.</span><span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="原型式继承函数-对象"><a href="#原型式继承函数-对象" class="header-anchor">#</a> 原型式继承函数 - 对象</h4> <p><strong>要优化的根本</strong></p> <p>要实现的应该是，<strong>Student 的原型</strong>指向的是一个新的对象，这个对象的<strong>隐式原型</strong>指向的是 Person 对象，这样的话，给 Student 对象的原型添加属性和方法本质上就是对那个新对象添加，而不会影响到 Person 对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Student</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//这样是不推荐的，因为__proto__是方便读取原型来使用的，不建议修改</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
</code></pre></div><ul><li>将 obj 对象作为新建对象的原型（原型式继承函数的实现）</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343043.png" alt="image-20220116152858244"></p> <h4 id="寄生式继承-对象"><a href="#寄生式继承-对象" class="header-anchor">#</a> 寄生式继承 - 对象</h4> <p>用上面的原型式继承有缺陷，就是新建出来的<strong>stu 对象</strong>要拓展重复的 name 属性和 studying 方法的话，需要逐个添加。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343044.png" alt="image-20220116153611704"></p> <p>此时可以结合工厂函数来实现继承**（工厂函数中少写了个 return stu）**</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343045.png" alt="image-20220116153817947"></p> <h4 id="最终实现继承-寄生组合式继承"><a href="#最终实现继承-寄生组合式继承" class="header-anchor">#</a> 最终实现继承（寄生组合式继承）</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> friends</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>friends <span class="token operator">=</span> friends<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eating</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">sno<span class="token punctuation">,</span> name<span class="token punctuation">,</span> friends</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> friends<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//将Student的原型指向一个新的对象，这个对象的原型指向的是Person的原型</span>
<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//输出的时候显示Person{xxx}，前面拼接的字符串是由constructor的name决定的</span>
<span class="token comment">//原本Student的原型中是有constructor的，但是修改了原型之后，会在原型链中找，最后找到了Person中的constructor中的name</span>
<span class="token comment">//所以这里需要给Student.prototype新增一个constructor属性，value为Student函数对象</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> Student<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">running</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'student '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stu1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1905010502</span><span class="token punctuation">,</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'jzsp'</span><span class="token punctuation">,</span> <span class="token string">'jzsp2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu1<span class="token punctuation">)</span><span class="token punctuation">;</span>
stu1<span class="token punctuation">.</span><span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stu1<span class="token punctuation">.</span><span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343046.png" alt="image-20220116154936460"></p> <p>但是如果有很多个类继承 person 的话，处理 constructor 的部分就会重复书写，所以我们封装一个函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">inherit</span><span class="token punctuation">(</span><span class="token parameter">son<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//这个create也可以用上面介绍的另外两种方法实现</span>
  son<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>son<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> son<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//在调用的时候只需要</span>
<span class="token function">inherit</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="原型继承的关系"><a href="#原型继承的关系" class="header-anchor">#</a> 原型继承的关系</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343047.png" alt="image-20220116172959749"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343048.png" alt="image-20220116163401532"></p> <p>函数对象的<code>__proto__</code>和 prototype</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343049.png" alt="image-20220116163246226"></p> <ul><li><p><code>function Foo()</code>作为一个<strong>函数</strong>，有自己的显式原型 prototype 对象</p></li> <li><p><code>function Foo</code>又是一个<strong>函数对象</strong>，对象就有隐式<code>__proto__</code>属性，<strong>（没有继承的情况下）一个对象的隐式原型指向构造该对象的构造函数的原型</strong>，这个 Foo 函数对象是通过<code>function Function()</code>函数构造的，所以 Foo 函数对象内部的<code>__proto__</code>指向 Function 的原型对象</p></li> <li><p>Foo 的 prototype 是<strong>对象</strong>，所以有<code>__proto__</code>属性，这个属性指向的是<strong>Object 原型对象</strong>，因为这个对象是通过 Object 函数构造出来的</p></li> <li><p>如果 Foo 继承了 A，那么 Foo 的<code>__proto__</code>指向的是 A 对象，</p></li> <li><p>Foo 的 prototype 指向的是一个对象，这个对象的<code>__proto__</code>是 A 的 prototype</p></li> <li><p><code>function Function()</code>本身是一个<strong>函数</strong>，那么内部有一个显式 prototype 指向 Function 的原型对象</p></li> <li><p><code>function Function</code>本身又是一个<strong>函数对象</strong>，是对象就会有<code>__proto__</code>属性，这个属性指向的是 Function 对象的原型，因为<strong>Function 本身肯定也是通过 Function 函数构造出来的</strong></p></li> <li><p>Function 的原型对象<strong>是对象</strong>，所以有<code>__proto__</code>属性，这个属性指向的是<strong>Object 函数的原型对象</strong>，因为 Function 的原型对象是由 Object 函数构造出来的</p></li> <li><p><code>function Object</code>是一个<strong>函数对象</strong>，是对象就会有<code>__proto__</code>属性，该属性指向的是 Function 对象的原型，因为这个函数对象是通过 Function 函数构造出来的</p></li> <li><p><code>function Object</code>本身又是一个<strong>函数</strong>，那么它就会有一个 prototype 属性指向它的原型对象（顶层原型），这个原型对象虽然是对象，但是这个对象的<code>__proto__</code>为 null，因为已经是顶层原型了</p></li></ul> <h3 id="总结-很重要"><a href="#总结-很重要" class="header-anchor">#</a> 总结（很重要）</h3> <p>重点是要看一个对象是不是函数对象，如果是函数对象的话，那么它的<code>__proto__</code>分情况讨论</p> <ul><li><p>继承的函数对象，<code>__proto__</code>指向父类函数对象</p></li> <li><p>没有继承的函数对象，<code>__proto__</code>指向<code>Function.prototype</code></p></li> <li><p>继承的函数对象，<code>prototype.__proto__</code>指向的是父类函数对象的<code>prototype</code></p></li> <li><p>没继承的函数对象，<code>prototype.__proto__</code>指向的是<code>Object的prototype</code></p></li></ul> <p>如果不是函数对象，是普通对象的话，它的<code>__proto__</code>指向的就是构造出它的函数的原型</p> <ul><li>有继承的情况下
<ul><li>函数对象的<code>__proto__</code>指向的是父类的函数对象（继承静态方法）</li> <li>函数对象的<code>prototype</code>指向的是自身的显示原型对象，这个对象的<code>__proto__</code>指向的是父类的<code>prototype</code></li> <li>实例对象的<code>__proto__</code>（new 出来的）指向的是父类的 prototype</li> <li>实例对象的 constructor 和<code>__proto__</code>的 constructor 都指向，构造函数对象</li></ul></li> <li>有继承的情况下
<ul><li>函数对象的<code>__proto__</code>指向的是 Function 的 prototype（因为函数对象是通过 Function 构造出来的）</li> <li>函数对象的<code>prototype</code>指向的是自身的显示原型对象，这个对象的<code>__proto__</code>指向的是 Object.prototype</li></ul></li></ul> <p>所以，<code>Function.__proto__ == Function.prototype //true</code></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343050.png" alt="image-20220304090041600"></p> <blockquote><p>注意：es6 的继承的话，子类<strong>函数对象</strong>的<code>__proto__</code>（es5 的函数对象的<code>__proto__</code>指向的应该是 Function 的 prototype）是直接指向<strong>父类函数对象</strong>的，是为了实现静态方法的继承（在下面 ES6 面向对象会有说到）</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">foo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">foo2</span> <span class="token keyword">extends</span> <span class="token class-name">foo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">===</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//函数对象的prototype的构造函数就是函数对象本身</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> foo2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>constructor <span class="token operator">===</span> foo2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true,new出来的实例对象的构造方法指向该实例的函数对象</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//函数对象的constructor指向Function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//foo函数对象 __proto__指向Function.prototype</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo2<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//foo2.__proto__指向foo，foo函数对象的构造函数指向Function</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> foo2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> foo2<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo2<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">===</span> foo2<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> foo<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo2<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> foo<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//继承的情况下，子类函数对象的prototype指向一个对象，这个对象的__proto__指向的是父类的prototype</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//没有继承的情况下，子类函数对象的prototype的__proto__指向的是Object.prototype</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343051.png" alt="image-20220116170713187"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这个指向的是Function的原型对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这个指向的是foo函数自身的原型对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> foo<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指向的是foo.prototype指向的对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> foo<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//undefined 只有函数对象有prototype属性。</span>
</code></pre></div><h2 id="对象方法的补充-可以参考-reflecrt-的方法"><a href="#对象方法的补充-可以参考-reflecrt-的方法" class="header-anchor">#</a> 对象方法的补充（可以参考 Reflecrt 的方法）</h2> <h3 id="object-getownpropertydescriptors"><a href="#object-getownpropertydescriptors" class="header-anchor">#</a> Object.getOwnPropertyDescriptors</h3> <p>获取对象的属性描述（包括不可枚举的属性）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343052.png" alt="image-20220117145146995"></p> <h3 id="object-setprototypeof"><a href="#object-setprototypeof" class="header-anchor">#</a> Object.setPrototypeOf</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343053.png" alt="image-20220117144702935"></p> <h3 id="object-getprototypeof"><a href="#object-getprototypeof" class="header-anchor">#</a> Object.getPrototypeOf</h3> <p>因为<code>__proto__</code>存在浏览器兼容性问题，所以通过这个方法可以达到<code>__proto__</code>属性一样的效果</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="object-hasownproperty"><a href="#object-hasownproperty" class="header-anchor">#</a> Object.hasOwnProperty</h3> <p>对象是否有一个属于自己的属性（<strong>不包括原型上的属性</strong>）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343054.png" alt="image-20220116160743096"></p> <h3 id="in-操作符"><a href="#in-操作符" class="header-anchor">#</a> in 操作符</h3> <p>in 操作符判断的是包括原型上的属性的</p> <p><code>&quot;address&quot; in obj // true(在原型上的address属性)</code></p> <h3 id="instanceof-操作符"><a href="#instanceof-操作符" class="header-anchor">#</a> instanceof 操作符</h3> <p>用于检测<strong>构造函数</strong>的<strong>prototype</strong>，是否出现在某个<strong>实例对象</strong>的<strong>原型链</strong>上</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343055.png" alt="image-20220116161520817"></p> <h3 id="isprototypeof-方法"><a href="#isprototypeof-方法" class="header-anchor">#</a> isPrototypeOf 方法</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//判断Person的原型对象是否出现在obj的原型链上</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意它和 instanceof 的区别，instanceof 的右操作数只能是<strong>函数对象</strong>，如果是下面这种情况的话就无法判断了</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343056.png" alt="image-20220116162422733"></p> <h3 id="object-create"><a href="#object-create" class="header-anchor">#</a> Object.create</h3> <p>创建一个<strong>包括特定原型的对象</strong>，并且这个对象可以选择性的包括一些特定的属性（第二个参数是一个对象，对象中的属性会<strong>添加在新建的对象上</strong>而非原型上）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343057.png" alt="image-20220116160510811"></p> <h1 id="_10、es6-面向对象"><a href="#_10、es6-面向对象" class="header-anchor">#</a> 10、ES6 面向对象</h1> <h2 id="class-定义类的方式"><a href="#class-定义类的方式" class="header-anchor">#</a> class 定义类的方式</h2> <p>用 class 关键字定义类，主要是原来构造函数、原型、原型链的语法糖，所以有一切之前的特点</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//类的声明</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">//类的表达式</span>
<span class="token keyword">var</span> Person <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//在new的时候，同样会把Person的原型对象的地址赋值给p.__proto__属性</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//function</span>
</code></pre></div><h2 id="class-的构造方法"><a href="#class-的构造方法" class="header-anchor">#</a> class 的构造方法</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token comment">//类的构造方法</span>
  <span class="token comment">//注意：一个类只能有一个构造方法</span>
  <span class="token comment">//1.在内存中创建一个对象{}</span>
  <span class="token comment">//2.将类的原型prototype赋值给这个对象的__proto__属性</span>
  <span class="token comment">//3.将对象赋值给函数的this：new 绑定</span>
  <span class="token comment">//4.执行函数体中的代码</span>
  <span class="token comment">//5.自动返回创建出来的对象</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="class-的方法定义"><a href="#class-的方法定义" class="header-anchor">#</a> class 的方法定义</h2> <ul><li>实例方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'wjj'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//这种添加方法的方式，跟es5一样，本质上都是添加到原型对象中</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343058.png" alt="image-20220117123950430"></p> <ul><li>静态方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Person<span class="token punctuation">.</span><span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>属性的 get 和 set</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_address <span class="token operator">=</span> <span class="token string">'台州市'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//对取值进行拦截</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_address<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//对设置值进行拦截</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_address <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'wjj'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//台州市</span>
p<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//jzsp</span>
</code></pre></div><h2 id="类的继承以及-super"><a href="#类的继承以及-super" class="header-anchor">#</a> 类的继承以及 super</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">saying</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'saying'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//也可以继承系统内置的类Array,String这些</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> sno</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、在子类构造方法中，使用this前，必须通过super调用父类的构造方法</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//可以在自己的原型上写一个同名的方法，那么就会优先找本原型上的的方法了（相当于覆盖了父原型上的方法）</span>
  <span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//假如不希望全部重写，而是在原来的基础上添加一些内容，可以用super来调用父类的方法</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...写一些特有的逻辑</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">'wjj'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1905010502</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//继承过来的方法是保存在原型的原型上的</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span>stu<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//也会继承父类的静态方法</span>
Student<span class="token punctuation">.</span><span class="token function">saying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343059.png" alt="image-20220117132311244"></p> <h3 id="两种继承方式的比较"><a href="#两种继承方式的比较" class="header-anchor">#</a> 两种继承方式的比较</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指向的是Person的空对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>__proto__ <span class="token operator">==</span> Person<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true，es6和es5的继承最大的差别就是这一步，子类的__proto__指向的是父类的对象，为了继承静态方法，代码在下面有介绍</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>__proto__ <span class="token operator">==</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__proto__ <span class="token operator">==</span> <span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>

<span class="token keyword">function</span> <span class="token function">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

student<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
student<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> student<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指向的是一个新的对象，这个对象的__proto__属性指向person的原型对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>__proto__ <span class="token operator">==</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>__proto__ <span class="token operator">==</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__proto__ <span class="token operator">==</span> student<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
</code></pre></div><h2 id="babel-转-es5▲▲▲▲▲▲▲▲▲▲▲▲▲▲"><a href="#babel-转-es5▲▲▲▲▲▲▲▲▲▲▲▲▲▲" class="header-anchor">#</a> Babel 转 es5▲▲▲▲▲▲▲▲▲▲▲▲▲▲</h2> <p><a href="babeljs.io">babel 官网</a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
	class Person{
	
	}
*/</span>

<span class="token comment">//判断传入的this是不是由Person构造出来的，也就是只能用new来调用Person方法</span>
<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot call a class as a function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Person <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">_createClass</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
    class Person{
       constructor(name,age){
          this.name = name
          this.age = age
       }
       eating(){
        console.log(this.name + ' is eating')
       }
    }  
*/</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot call a class as a function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//如果是createClass的第一个if，那么target就是原型对象</span>
<span class="token keyword">function</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//对props进行遍历</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> props<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> descriptor <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//如果enumerable属性存在就用这个，否则就是false</span>
    descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    descriptor<span class="token punctuation">.</span>configurable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//如果有value属性就设置writable为true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> descriptor<span class="token punctuation">)</span> descriptor<span class="token punctuation">.</span>writable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//定义属性</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span>key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_createClass</span><span class="token punctuation">(</span><span class="token parameter">Constructor<span class="token punctuation">,</span> protoProps<span class="token punctuation">,</span> staticProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果是原型的Props，就在传入的对象的原型对象上添加这个属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>protoProps<span class="token punctuation">)</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> protoProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果是静态方法，就直接定义到对象上而非原型对象，那么就可以通过Person.xxx直接调用静态方法了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>staticProps<span class="token punctuation">)</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">,</span> staticProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">,</span> <span class="token string">'prototype'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Constructor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//这个注释PURE表示是一个纯函数，在用webpack打包的时候会进行tree-shaking，如果这个函数后面没有被用到的话，在进行压缩的时候会进行优化，在打包后的代码就不会包括这个代码，利于压缩</span>
<span class="token keyword">var</span> Person <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//本来在class中声明方法，本质上是Person.prototype.eating = function(){}</span>
  <span class="token comment">//但是在这里，封装了一个方法来添加，第一个参数是Person的函数对象，第二个参数是一个数组，里面有对方法的描述</span>
  <span class="token function">_createClass</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'eating'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Person<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>这里最重要的是比 es5 的继承多了一步设置原型为父类对象</strong></p> <p>这里有一些关于 proxy 和 reflect 的东西，在 12 集的 2:30 开始，后面再看</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
    class Person{
        constructor(name,age){
            this.name = name
            this.age = age
        }
        running(){
            console.log(this.name + &quot; running&quot;)
        }
    }

    class Student extends Person{
        constructor(name,age,sno){
            super(name,age)
            this.sno = sno
        }
        studying(){
            console.log(this.name + &quot; is studying&quot;)
        }
    }
*/</span>

<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_typeof</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'@babel/helpers - typeof'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>_typeof <span class="token operator">=</span>
      <span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">&amp;&amp;</span> <span class="token string">'symbol'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> Symbol<span class="token punctuation">.</span>iterator
        <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span>
              <span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">&amp;&amp;</span>
              obj<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Symbol <span class="token operator">&amp;&amp;</span>
              obj <span class="token operator">!==</span> <span class="token class-name">Symbol</span><span class="token punctuation">.</span>prototype
              <span class="token operator">?</span> <span class="token string">'symbol'</span>
              <span class="token operator">:</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_typeof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_inherits</span><span class="token punctuation">(</span><span class="token parameter">subClass<span class="token punctuation">,</span> superClass</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//边界判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> superClass <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> superClass <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Super expression must either be null or a function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//新建一个对象，它的__proto__指向superClass的prototype，并且通过create函数的第二个参数设置constructor</span>
  <span class="token comment">//让subClass子对象的原型指向这个新建的对象</span>
  subClass<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>superClass <span class="token operator">&amp;&amp;</span> superClass<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> subClass<span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>subClass<span class="token punctuation">,</span> <span class="token string">'prototype'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//如果superClass有值的情况下还会调用，使得Student.__proto__ = Person，目的是静态方法的继承</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>superClass<span class="token punctuation">)</span> <span class="token function">_setPrototypeOf</span><span class="token punctuation">(</span>subClass<span class="token punctuation">,</span> superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">o<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _setPrototypeOf <span class="token operator">=</span>
    Object<span class="token punctuation">.</span>setPrototypeOf <span class="token operator">||</span>
    <span class="token keyword">function</span> <span class="token function">_setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">o<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      o<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> p<span class="token punctuation">;</span>
      <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_setPrototypeOf</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_createSuper</span><span class="token punctuation">(</span><span class="token parameter">Derived</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hasNativeReflectConstruct <span class="token operator">=</span> <span class="token function">_isNativeReflectConstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">_createSuperInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> Super <span class="token operator">=</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span>Derived<span class="token punctuation">)</span><span class="token punctuation">,</span>
      result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNativeReflectConstruct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> NewTarget <span class="token operator">=</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
      result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>Super<span class="token punctuation">,</span> arguments<span class="token punctuation">,</span> NewTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token function">Super</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">_possibleConstructorReturn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_possibleConstructorReturn</span><span class="token punctuation">(</span><span class="token parameter">self<span class="token punctuation">,</span> call</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>call <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">_typeof</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> call <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> call<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>call <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>
      <span class="token string">'Derived constructors may only return object or undefined'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">_assertThisInitialized</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_assertThisInitialized</span><span class="token punctuation">(</span><span class="token parameter">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span>
      <span class="token string">&quot;this hasn't been initialised - super() hasn't been called&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> self<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_isNativeReflectConstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Reflect <span class="token operator">===</span> <span class="token string">'undefined'</span> <span class="token operator">||</span> <span class="token operator">!</span>Reflect<span class="token punctuation">.</span>construct<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span>construct<span class="token punctuation">.</span>sham<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Proxy <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _getPrototypeOf <span class="token operator">=</span> Object<span class="token punctuation">.</span>setPrototypeOf
    <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function-variable function">getPrototypeOf</span>
    <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> o<span class="token punctuation">.</span>__proto__ <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot call a class as a function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> props<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> descriptor <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    descriptor<span class="token punctuation">.</span>configurable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> descriptor<span class="token punctuation">)</span> descriptor<span class="token punctuation">.</span>writable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span>key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_createClass</span><span class="token punctuation">(</span><span class="token parameter">Constructor<span class="token punctuation">,</span> protoProps<span class="token punctuation">,</span> staticProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>protoProps<span class="token punctuation">)</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> protoProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>staticProps<span class="token punctuation">)</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">,</span> staticProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">,</span> <span class="token string">'prototype'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Constructor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Person <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Person<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_createClass</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'running'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Person<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Student <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_Person</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_inherits</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> _Person<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> _super <span class="token operator">=</span> <span class="token function">_createSuper</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> sno</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this<span class="token punctuation">;</span>

    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Student<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _this <span class="token operator">=</span> <span class="token function">_super</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _this<span class="token punctuation">.</span>sno <span class="token operator">=</span> sno<span class="token punctuation">;</span>
    <span class="token keyword">return</span> _this<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_createClass</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'studying'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">studying</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is studying'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Student<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="mixin"><a href="#mixin" class="header-anchor">#</a> mixin</h2> <p>mixin 本质上是为了实现多继承，但是 js 本身并不能直接支持多继承，只不过是用函数的技巧来间接实现混入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Runner</span> <span class="token punctuation">{</span>
  <span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Eater</span> <span class="token punctuation">{</span>
  <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//如果要person同时继承两个的话，是不能这么写的</span>
<span class="token comment">//class Person extends Runner,Eater</span>

<span class="token keyword">function</span> <span class="token function">mixinRunner</span><span class="token punctuation">(</span><span class="token parameter">baseClass</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//混入返回的是一个新的类，这个类继承了传入baseClass的所有功能，并且在自己的原型上添加了自己特有的功能</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> baseClass <span class="token punctuation">{</span>
    <span class="token function">running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mixinEater</span><span class="token punctuation">(</span><span class="token parameter">baseClass</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> baseClass <span class="token punctuation">{</span>
    <span class="token function">eating</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'eating'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> mix <span class="token operator">=</span> <span class="token function">mixinEater</span><span class="token punctuation">(</span><span class="token function">mixinRunner</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">mix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343060.png" alt="image-20220117151003220"></p> <h2 id="类的多态-ts"><a href="#类的多态-ts" class="header-anchor">#</a> 类的多态（TS）</h2> <p>有三个前提</p> <ul><li>必须有继承</li> <li>必须有重写（重写父类的方法）</li> <li>必须有<strong>父类的引用指向子类对象</strong>（例如下面的 Circle 的父类是 Shape，所以 c 对象既可以说是 Circle 类又可以说是 Shape 类）</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343061.png" alt="image-20220117151712923"></p> <h1 id="_11、es-小知识点"><a href="#_11、es-小知识点" class="header-anchor">#</a> 11、ES 小知识点</h1> <h2 id="let-和-const-的作用域提升"><a href="#let-和-const-的作用域提升" class="header-anchor">#</a> let 和 const 的作用域提升</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>let foo = 1</code> 之前无法打印<code>foo</code>并不是因为它没有在解析的时候创建 foo 属性，而是<strong>它创建了，但是不能被访问</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343062.png" alt="image-20220117160407144"></p> <p>由上图可知，确实如此（var 声明的 foo 在 Global 对象中）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343063.png" alt="image-20220117155417351"></p> <blockquote><p>所以，let 和 const 声明的变量会在执行上下文创建的时候被创建，但是没有进行作用域提升，在声明前不能访问，这叫暂时性死区</p></blockquote> <h2 id="let-和-const-跟-window-的关系"><a href="#let-和-const-跟-window-的关系" class="header-anchor">#</a> let 和 const 跟 window 的关系</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343064.png" alt="image-20220117164243892"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343065.png" alt="image-20220117164229163"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343066.png" alt="image-20220117164558660"></p> <ul><li><code>在ES5中，全局变量直接挂载到全局对象window的属性上</code>，所以能在 window 上看到 var 和 function 声明的全局变量</li> <li><code>在ES6中，全局变量从全局对象window中脱离</code>，但是为了保持兼容性，<code>旧的不变</code>，所以 var、**function 声明的全局变量依然可以在 window 对象上看到，而 let、const 声明的全局变量在 window 对象上看不到，在 script 中形成了一个块级作用域，**这样在全局就可以访问到</li></ul> <p>通过设置断点，看看浏览器是怎么处理的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343067.png" alt="image-20220118112020699"></p> <p>通过上图也可以看到，<code>在全局作用域中，用 let 和 const 声明的全局变量并没有在全局对象中，只是一个块级作用域（Script）中</code>。
那要怎么获取呢？在定义变量的块级作用域中就能获取啊。</p> <p>可以发现 let 和 const 声明的变量<strong>不属于顶层对象 Window</strong>，所以 window.aa 为 undefined。若要访问，直接访问即可。</p> <h2 id="展开语法进行的浅拷贝"><a href="#展开语法进行的浅拷贝" class="header-anchor">#</a> 展开语法进行的浅拷贝</h2> <ul><li>浅拷贝是指，只是单纯的复制了那一层的数据（<strong>引用类型复制内存地址</strong>）</li> <li>深拷贝的话，引用数据类型指向的对象会<strong>新建</strong>，不会指向同一个引用</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343068.png" alt="image-20220117191422740"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">friend</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>info <span class="token punctuation">}</span><span class="token punctuation">;</span>
me<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzspjzsp'</span><span class="token punctuation">;</span>
<span class="token comment">//会发现，改变了me这个对象的name的话，影响到了info对象中friend的name</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//jzspjzsp</span>
</code></pre></div><h2 id="对象作为对象的-key"><a href="#对象作为对象的-key" class="header-anchor">#</a> 对象作为对象的 key</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343069.png" alt="image-20220118103217936"></p> <h2 id="weakmap-与-vue3-响应式原理"><a href="#weakmap-与-vue3-响应式原理" class="header-anchor">#</a> WeakMap 与 Vue3 响应式原理</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343070.png" alt="image-20220211161808049"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343071.png" alt="image-20220118105555091"></p> <h2 id="map-创建与-object-entries-结合"><a href="#map-创建与-object-entries-结合" class="header-anchor">#</a> map 创建与 Object.entries 结合</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> school <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//entries,传入一个对象,他获取到的是一个数组</span>
<span class="token comment">//数组里面是一个数组，这个数组只有两个值，对应了key和value，这种结构方便创建map</span>
<span class="token comment">//[[1,'a'],[2,'b'],[3,'c']]</span>
<span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>school<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343072.png" alt="image-20220120122544448"></p> <h2 id="函数尾逗"><a href="#函数尾逗" class="header-anchor">#</a> 函数尾逗</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="es10-的-object-fromentryies-结合-urlsearchparams"><a href="#es10-的-object-fromentryies-结合-urlsearchparams" class="header-anchor">#</a> ES10 的 Object.fromEntryies 结合 URLSearchParams</h2> <p>URLSearchParams 是一个可以操作类似于 URL 中 queryString 字符串的接口（interface）， 实现这个接口的对象可以直接用 for...of 结构来迭代这个对象的键值对</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343073.png" alt="image-20220120132043358"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> queryString <span class="token operator">=</span> <span class="token string">'name=jzsp&amp;age=20'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ name: 'jzsp', age: '20' }</span>
</code></pre></div><h2 id="可选链操作符"><a href="#可选链操作符" class="header-anchor">#</a> 可选链操作符?.</h2> <blockquote><p>判断前面的属性是否是 undefined</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token comment">//addr:{</span>
  <span class="token comment">//    area:'lq'</span>
  <span class="token comment">//}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>addr<span class="token punctuation">.</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//相当于是info.undefined.area，会报错的</span>
<span class="token comment">//要处理上面这种情况的话得逐个判断是否有值(用与运算符逐个判断，如果都是true就会返回最后一个的值，如果有一个是undefined就返回undefined)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>addr <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>addr<span class="token punctuation">.</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//同样的，也可以用?.来达到一样的效果，看上去更简洁</span>
<span class="token comment">//它的作用是，判断前面的那个属性是否是undefined，如果是的话就直接返回undefined，否则就按链取到最后一个值</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token operator">?.</span>addr<span class="token operator">?.</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="空值合并运算"><a href="#空值合并运算" class="header-anchor">#</a> ？？空值合并运算</h2> <p>因为<code>0</code>和<code>&quot;&quot;</code>空字符串是<strong>假值</strong>，在进行逻辑或赋默认值的时候会出现问题，如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> a <span class="token operator">||</span> <span class="token string">'defaultValue'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//defaultValue</span>
</code></pre></div><p>??的出现就是为了处理这种情况，只用于判断一个变量是否为 null 或者 undefined</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> a <span class="token operator">??</span> <span class="token string">'defaultValue'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//0</span>
</code></pre></div><h2 id="weakref-弱引用"><a href="#weakref-弱引用" class="header-anchor">#</a> WeakRef 弱引用</h2> <p><strong>deref 方法</strong>获取弱引用指向的对象，如果没有被销毁就能获取，否则就返回 undefined</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343074.png" alt="image-20220120143549256"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//注意要在浏览器环境下运行哦</span>
<span class="token comment">//这个类是用于注册要监听的对象，如果被gc回收的时候执行传入的函数，这个函数的参数是register实例方法传入的第二个参数，用于标识当前销毁的是哪个对象</span>
<span class="token keyword">const</span> finalRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'寄！'</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//这里直接赋值是强引用，obj2指向obj指向的对象，那么将obj设置为空的话，因为还有引用指着他，所以它不会被gc回收</span>
<span class="token comment">//let obj2 = obj</span>

<span class="token comment">//这样创建的就是弱引用了，当obj赋值为null的时候，obj会被销毁</span>
<span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//弱引用可以用dref获取弱引用指向的对象，然后就是正常使用</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//注册监听</span>
finalRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'jzsp1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="_12、proxy-reflect-响应式原理"><a href="#_12、proxy-reflect-响应式原理" class="header-anchor">#</a> 12、Proxy/Reflect 响应式原理</h1> <h2 id="监听对象的操作"><a href="#监听对象的操作" class="header-anchor">#</a> 监听对象的操作</h2> <p>可以用<code>Object.defineProperty</code>来实现对**完整对象（不需要删除，增加属性）**的属性的监听</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343075.png" alt="image-20220120145434949"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> v <span class="token operator">=</span> obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//形成闭包，对象的值从v获取，并不是从对象中获取</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">属性被get了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newV</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//set本质上是修改的数据来源，而不是给对象设置属性值</span>
      v <span class="token operator">=</span> newV<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">属性被set了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>缺点</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343076.png" alt="image-20220120152643642"></p> <h2 id="proxy-代理-类"><a href="#proxy-代理-类" class="header-anchor">#</a> Proxy（代理）类</h2> <p>也就是说，如果我们希望监听一个 obj 对象的相关操作，那么我们可以创建一个代理对象（Proxy），对 obj 对象的所有操作，都通过代理对象来完成，代理对象可以监听我们想要对原对象进行哪些操作（有十三种）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343077.png" alt="image-20220120161725718"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343078.png" alt="image-20220120165507212"></p> <blockquote><p>apply 和 construct 是针对函数对象的，通过 Proxy 对函数对象执行 apply 或者 new 的时候</p></blockquote> <h3 id="简单使用-可以监听深层属性"><a href="#简单使用-可以监听深层属性" class="header-anchor">#</a> 简单使用（可以监听深层属性）</h3> <p>我们使用的是第二种 new 的方式来创建 Proxy 的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343079.png" alt="image-20220120162401793"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//第一个参数是要代理的目标对象，第二个参数是重写的handler，传入空对象是默认不重写handler</span>
<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//可以通过Proxy来获取，以及修改原来对象的属性</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//wjj</span>

objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
<span class="token comment">//来检验原来的对象中的name属性是否被修改了</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//jzsp</span>
</code></pre></div><h3 id="handler-set-和-get"><a href="#handler-set-和-get" class="header-anchor">#</a> handler：set 和 get</h3> <blockquote><p><code>proxy</code>中的<code>get</code>中<code>return target[key]</code> 是不会造成递归调用的，而<code>Object.defineProperty</code>会</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343080.png" alt="image-20220120164701359"></p> <h3 id="preventextensions"><a href="#preventextensions" class="header-anchor">#</a> preventExtensions</h3> <blockquote><p>有些 handler 对返回值有明确规定的，需要查看 mdn 来判断</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>canEvolve <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//执行对应的操作</span>
    Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="reflect-反射-对象"><a href="#reflect-反射-对象" class="header-anchor">#</a> Reflect（反射） 对象</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343081.png" alt="image-20220120171803199"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343082.png" alt="image-20220120172730325"></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect/Comparing_Reflect_and_Object_methods" target="_blank" rel="noopener noreferrer">Object 和 Reflect 的细微区别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Reflect 对象内部的静态方法跟 Proxy 的方法是<strong>一一对应</strong>的，因为 Proxy 是代理，为了<strong>避免直接对原对象进行操作</strong>，所以就有了 Reflect，通过 Reflect 对象对原对象进行操作</p> <h3 id="reflect-结合-proxy"><a href="#reflect-结合-proxy" class="header-anchor">#</a> Reflect 结合 Proxy</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过Reflect避免对原对象直接操作</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="construct"><a href="#construct" class="header-anchor">#</a> construct</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">//执行Student构造函数，但是创建出来的是Person类型</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'wjj'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343083.png" alt="image-20220120182358968"></p> <h2 id="关于-proxy-中-set-和-get-的最后一个参数-receiver-改变-this-用的"><a href="#关于-proxy-中-set-和-get-的最后一个参数-receiver-改变-this-用的" class="header-anchor">#</a> 关于 Proxy 中 set 和 get 的最后一个参数 receiver（改变 this 用的）</h2> <p>先看下面一段代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">_name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> v<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343084.png" alt="image-20220120181019354"></p> <p>这段代码访问的是 Proxy 中的 name，它会访问到 obj 中的<code>get name()</code>，进而通过这个<code>return this._name</code>。但是这样的话，<strong>获取<code>_name</code>属性的过程并没有经过 Proxy 中的 get 代理</strong>，如果在 Proxy 中 get 前我们需要进行一些操作，再返回数值的话，就无法达到效果。所以我们要<strong>修改 obj 对象中的 this 的指向</strong>，<strong><code>receiver</code>指向的是 Proxy 本身</strong>，在调用<code>Reflect.get</code>的时候传入<code>receiver</code><strong>可以改变 obj 对象中 get 方法里<code>this</code>的指向</strong>，进而避免这种直接操作 obj 对象而不经过 Proxy 的另一种途径</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">_name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> v<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343085.png" alt="image-20220120181054523"></p> <h1 id="_13、响应式原理实现"><a href="#_13、响应式原理实现" class="header-anchor">#</a> 13、响应式原理实现</h1> <h2 id="响应式函数的封装"><a href="#响应式函数的封装" class="header-anchor">#</a> 响应式函数的封装</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//保存所有在变量改变需要执行的依赖函数的数组</span>
<span class="token keyword">let</span> reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">//用于收集传入的依赖函数</span>
<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 先假设这个name是响应式数据</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">&quot;wjj&quot;</span><span class="token punctuation">,</span>

<span class="token comment">//name发生改变要执行的依赖函数</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是依赖函数1'</span><span class="token operator">+</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//name发生改变要执行的函数</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是依赖函数2'</span><span class="token operator">+</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//修改响应式数据</span>
name <span class="token operator">=</span> <span class="token string">'jzsp'</span>
<span class="token comment">//当name改变时，执行响应式函数</span>
reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="依赖响应类的封装"><a href="#依赖响应类的封装" class="header-anchor">#</a> 依赖响应类的封装</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addDepend</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFn<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'wjj'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> nameDepend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nameDepend<span class="token punctuation">.</span><span class="token function">addDepend</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//name发生改变要执行的函数</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是依赖函数1'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//name发生改变要执行的函数</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是依赖函数2'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
nameDepend<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="proxy-自动监听对象属性的变化"><a href="#proxy-自动监听对象属性的变化" class="header-anchor">#</a> Proxy 自动监听对象属性的变化</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//用于收集某个属性的所有响应式函数</span>
<span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addDepend</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//用于收集name属性的响应式函数</span>
<span class="token keyword">const</span> nameDepend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nameDepend<span class="token punctuation">.</span><span class="token function">addDepend</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//监听对象属性的变化：Vue3（Proxy） / Vue2（Object.defineProperty)</span>
<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当name改变时，执行响应式函数</span>
    nameDepend<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是哥响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是哥响应式函数2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="weakmap-依赖收集对象的管理"><a href="#weakmap-依赖收集对象的管理" class="header-anchor">#</a> WeakMap 依赖收集对象的管理</h2> <p>每个对象对应一个 map（防止 key 重名），这个 map 里保存的 key-value 是属性名以及属性名对应的 Depend（依赖响应类的实例，里面收集了所有关于该属性的响应式函数），然后将对象和这个 map 以键值对的形式保存在 WeakMap 中</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343086.png" alt="image-20220120193746954"></p> <p>当 obj.name 发生改变的时候，我们就可以先从 WeakMap 中取出 obj 的 map 对象，再在这个 map 对象中取出 name 的 Depend 实例，然后调用内部的 notify 方法执行所有的响应式函数</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343087.png" alt="image-20220120194136917"></p> <p>数据结构</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343088.png" alt="image-20220120195900293"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addDepend</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//封装一个获取depend实例的方法</span>
<span class="token keyword">function</span> <span class="token function">getDepend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//根据key获取depend</span>
  <span class="token keyword">let</span> depend <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果是第一次获取的话，是没有对应的depend的，所以需要创建</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> depend<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> depend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> nameDepend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nameDepend<span class="token punctuation">.</span><span class="token function">addDepend</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//监听对象属性的变化：Vue3（Proxy） / Vue2（Object.defineProperty)</span>
<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当target的p属性发生改变时，执行对应的响应式函数</span>
    <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是哥响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是哥响应式函数2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="get-的时候收集响应式函数"><a href="#get-的时候收集响应式函数" class="header-anchor">#</a> get 的时候收集响应式函数</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addDepend</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//很重要哦</span>
<span class="token keyword">function</span> <span class="token function">getDepend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> depend <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> depend<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> depend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeReactiveFn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  <span class="token comment">//怎么知道这个fn要存入到哪个map的哪个depend对象中呢？</span>
  <span class="token comment">//我们先执行一次这个函数</span>
  <span class="token comment">//如果函数内部用到了某个对象的某个属性的话，在执行到那一行代码的时候会经过Proxy代理进入get的handler</span>
  <span class="token comment">//在get中，我们根据target和key已经获取到了对应的 depend，但是我们毕竟是要将函数对象添加到depend中的</span>
  <span class="token comment">//怎么获取函数对象呢？我们这里在全局声明一个变量，在执行函数之前赋值，在执行时，经过get的时候就可以获取这个fn了</span>
  <span class="token comment">//在执行结束的时候最好赋值为null重置一下</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取对应的depend</span>
    <span class="token keyword">const</span> depend <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//给depend对象添加对应的响应函数</span>
    depend<span class="token punctuation">.</span><span class="token function">addDepend</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//这里对上面重新进行解释，因为我们在watchFn传入function对象的时候会先执行一遍fn，因为所有的对象都是经过Proxy代理的，在执行fn的时候，如果用到了某个对象的某个属性，就会进入Proxy中的get方法，进入getDepend，如果发现某个对象的map或者是这个对象的某个属性的depend没有创建的话，则在getDepend中创建。</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">'obj.age的响应式函数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>age <span class="token operator">+</span> objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.age和obj.name的响应式函数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//开始修改</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------开始修改----------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="depend-类优化"><a href="#depend-类优化" class="header-anchor">#</a> Depend 类优化</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// this.reactiveFns = new Set()</span>
  <span class="token punctuation">}</span>

  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">selectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果activeReactiveFn不为null，并且reactiveFns数组中没有activeReactiveFn这个函数时才添加</span>
    <span class="token comment">//第二个判断是为了防止，如果一个函数中多次使用了某个属性，多次进入get，多次执行了selectFn，被重复添加到数组中（是不是可以用set嘞？）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeReactiveFn <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if(activeReactiveFn){</span>
    <span class="token comment">//   this.reactiveFns.add(activeReactiveFn)</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getDepend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> depend <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> depend<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> depend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeReactiveFn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> depend <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//我们这里并不需要管activeReactiveFn这个变量，我们只需要知道，在这里的时候需要收集响应式函数即可</span>
    <span class="token comment">//depend.addDepend(activeReactiveFn)</span>
    depend<span class="token punctuation">.</span><span class="token function">selectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">'obj.age的响应式函数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>age <span class="token operator">+</span> objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.age和obj.name的响应式函数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//开始修改</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------开始修改----------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="将对象-new-proxy-的部分封装"><a href="#将对象-new-proxy-的部分封装" class="header-anchor">#</a> 将对象 new Proxy 的部分封装</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// this.reactiveFns = new Set()</span>
  <span class="token punctuation">}</span>

  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">selectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果activeReactiveFn不为null，并且reactiveFns数组中没有activeReactiveFn这个函数时才添加</span>
    <span class="token comment">//第二个判断是为了防止，如果一个函数中多次使用了某个属性，多次进入get，多次执行了selectFn，被重复添加到数组中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeReactiveFn <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if(activeReactiveFn){</span>
    <span class="token comment">//   this.reactiveFns.add(activeReactiveFn)</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getDepend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> depend <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> depend<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> depend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> depend <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//我们这里并不需要管activeReactiveFn这个变量，我们只需要知道，在这里的时候需要收集响应式函数即可</span>
      <span class="token comment">//depend.addDepend(activeReactiveFn)</span>
      depend<span class="token punctuation">.</span><span class="token function">selectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">getDepend</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeReactiveFn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'初始化阶段执行的fn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objProxy2 <span class="token operator">=</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchFn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy2<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj2.name的响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--------开始修改---------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
objProxy2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>

<span class="token comment">//简化使用</span>
<span class="token comment">// const p = proxy({name:'jzsp'})</span>
<span class="token comment">// watchFn(()=&gt;{</span>
<span class="token comment">//   console.log(p.name)</span>
<span class="token comment">// })</span>
<span class="token comment">// p.name = '123'</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>封装一个 Depend 类，这个类用于<strong>管理某个对象的某个属性</strong>的所有响应式函数，并且封装添加（<code>selectFn</code>）和执行全部响应式函数（<code>notify</code>）的操作</li> <li>创建一个<strong>WeakMap</strong>来保存所有<strong>对象的<code>map</code></strong>（这个<code>map</code>里保存的是对应对象的所有属性的<code>depend</code>）</li> <li>创建<code>getDepend</code>方法用于获取<code>WeakMap</code>对应的<code>map</code>中对应属性的<code>depend</code>对象（<strong>注意要进行空值判断，为空的时候是第一次<code>get</code>某个对象的某个属性的<code>depend</code>，需要创建这个对象的<code>map</code>和这个属性的<code>depend</code></strong>）</li> <li>创建方法，根据传入的 obj 生成对应的<code>Proxy</code>代理，设置<code>set</code>和<code>get</code>方法，<code>set</code>中执行所有响应式函数（通过<code>target</code>和<code>key</code>获取<code>depend</code>，调用<code>notify</code>），get 中收集响应式函数（通过<code>target</code>和<code>key</code>获取<code>depend</code>，调用<code>selectFn</code>）</li> <li>创建一个<code>watchFn(fn)</code>来收集响应式函数，为了知道 fn 中用到了哪些对象的哪些属性，我们在<code>watchFn</code>的时候执行一次<code>fn</code>函数，<strong>用到某个对象的某个属性的时候会进入 Proxy 代理</strong>，进入对应属性的 get 方法，此时<code>get</code>方法中有对应的<code>target</code>和<code>key</code>可以通过 getDepend 方法获取到对应属性的<code>depend</code>实例，此时需要将调用<code>selectFn</code>收集这个函数对象到这个类中。<strong>为了知道这个函数对象是谁，我们还设置了一个全局变量<code>activeReactiveFn</code></strong>（在执行 fn 前赋值函数对象给<code>activeReactiveFn</code>）来指向这个函数对象</li></ul> <blockquote><p>这个 WeakMap 和 map 结合的数据结构，实现自动化收集对象属性的响应式函数的核心是，在<code>watchFn(fn)</code>的时候进入了 Proxy 中的 get，在 get 中根据对象和属性调用<code>getDepend</code>，这个时候是如果第一次<code>getDepend</code>这个对象属性，那么就创建对应的<code>map</code>和<code>depend</code>并保存到 WeakMap 中。</p></blockquote> <h2 id="vue2-实现响应式"><a href="#vue2-实现响应式" class="header-anchor">#</a> vue2 实现响应式</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Depend</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeReactiveFn <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>activeReactiveFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getDepend</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> depend <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> depend<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> depend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//通过Object.defineProperty来实现响应式</span>
<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> depend <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        depend<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> v<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        v <span class="token operator">=</span> newV<span class="token punctuation">;</span>
        <span class="token keyword">const</span> depend <span class="token operator">=</span> <span class="token function">getDepend</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        depend<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  activeReactiveFn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'初始化阶段执行的fn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeReactiveFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> objProxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> objProxy2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj.name的响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objProxy2<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'obj2.name的响应式函数1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--------开始修改---------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
objProxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
objProxy2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>

<span class="token comment">//简化使用</span>
<span class="token comment">// const p = reactive({name:'jzsp'})</span>
<span class="token comment">// watchEffect(()=&gt;{</span>
<span class="token comment">//   console.log(p.name)</span>
<span class="token comment">// })</span>
<span class="token comment">// p.name = '123'</span>
</code></pre></div><h1 id="_14、promise"><a href="#_14、promise" class="header-anchor">#</a> 14、Promise</h1> <h2 id="异步处理方式-回调函数"><a href="#异步处理方式-回调函数" class="header-anchor">#</a> 异步处理方式-回调函数</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> suc<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'jzsp'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//成功，异步无法返回数据，只能通过回调函数的形式来返回</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">'success'</span><span class="token punctuation">;</span> <span class="token comment">//假设这个是成功的数据</span>
      <span class="token function">suc</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//失败</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">'err'</span><span class="token punctuation">;</span>
      <span class="token function">err</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">request</span><span class="token punctuation">(</span>
  <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样的处理方式导致的最经典的弊端是会有回调地狱问题</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//现在要模拟的是，发送三次网络请求，每次都返回一个字符串</span>
<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> suc<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//这里就假设都是成功的吧</span>
    <span class="token function">suc</span><span class="token punctuation">(</span><span class="token string">'success1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">suc</span><span class="token punctuation">(</span><span class="token string">'success2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">suc</span><span class="token punctuation">(</span><span class="token string">'success3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//传入成功和失败的回调</span>
<span class="token function">request</span><span class="token punctuation">(</span>
  <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="promise-简介"><a href="#promise-简介" class="header-anchor">#</a> promise 简介</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343089.png" alt="image-20220121132721750"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//在new的时候传入executor，会被立即执行</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'suc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//then的作用是指定promise状态改变之后要执行的回调函数</span>
  <span class="token comment">//如果调用resolve改变promise的状态为fulfilled，就会执行then第一个参数传入的回调函数</span>
  <span class="token comment">//如果调用reject改变promise的状态为rejected，就会执行then第二个参数传入的回调函数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="promise-状态"><a href="#promise-状态" class="header-anchor">#</a> Promise 状态</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343090.png" alt="image-20220121134153743"></p> <h2 id="promise-状态的移交-☆☆☆☆"><a href="#promise-状态的移交-☆☆☆☆" class="header-anchor">#</a> Promise 状态的移交 ☆☆☆☆</h2> <ul><li>resolve（reject 同理）传入的参数是一个 Promise 对象（或者 thenable 对象）时，原 promise 的状态由这个传入的 promise 对象决定</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> newPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'jzsp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//虽然这里用的是resolve，本应将pending -&gt; fulfilled</span>
  <span class="token comment">//但是因为这里传入的是promise对象，所以状态和传值由这个promise对象来决定，这个叫做promise的移交</span>
  <span class="token comment">//如果这个传入的promise是失败的，则执行catch回调（then第二个参数）</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>newPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>传入的参数是一个有 then 方法（这个方法会当作 Promise 后的 then 方法执行，也可以有两个参数 resolve 和 reject）的对象时，后续 Promise 状态由这个对象中的 then 方法决定</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//虽然这里用的是resolve，本应将pending -&gt; fulfilled</span>
  <span class="token comment">//但是这里传入的对象实现了then方法，那么会先执行这个then方法，并且由该then方法决定后续Promise的状态</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'传入对象的then方法中调用了resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343091.png" alt="image-20220121152338169"></p> <p>其实状态移交并不好，因为如果用状态移交的方式写 promise 的话，会造成回调地狱的。。。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'最终结果'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="promise-的方法"><a href="#promise-的方法" class="header-anchor">#</a> Promise 的方法</h2> <h3 id="实例方法"><a href="#实例方法" class="header-anchor">#</a> 实例方法</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343092.png" alt="image-20220121141812891"></p> <h4 id="then-onfulfilled-onrejected"><a href="#then-onfulfilled-onrejected" class="header-anchor">#</a> <code>then(onfulfilled,onrejected)</code></h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//1、一个promise可以按照下面这种形式可以执行多个then</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//2、then方法本身是有返回值的，它返回的是一个promise对象(所以有了promise的链式调用)</span>
<span class="token comment">//    1&gt; 如果then中的回调函数返回的是一个普通值（数值/字符串/普通对象/undefined等），那么这个普通值会作为Promise的resolve值</span>
<span class="token comment">//    2&gt; 如果then中的回调函数返回的是一个Promise对象，那么会将它作为then返回的Promise的resolve值，但是resolve的值为Promise的时候，就发生了状态移交，即then返回的Promise对象的状态由回调返回的Promise对象决定</span>
<span class="token comment">//    3&gt; 如果then中的回调函数返回的是一个实现了then方法的对象，同理</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//回调没有返回值，默认返回undefined</span>
<span class="token comment">//那么then返回的Promise为{ value:undefined , state:'fulfilled' }</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//回调返回了Promise，这个promise的executor调用了resolve使这个promise的状态变为成功，值为111</span>
<span class="token comment">//那么then返回的Promise为{ value:111 , state:'fulfilled' }</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">a</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//回调返回了thenable对象，这个then方法调用了resolve函数</span>
<span class="token comment">//那么then返回的Promise为{ value:undefined , state:'fulfilled' }</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="catch"><a href="#catch" class="header-anchor">#</a> <code>catch</code></h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//catch的本质是第一个参数为undefined的then</span>
<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//调用reject和抛出异常会进入then执行第二个回调函数</span>
  <span class="token comment">//reject(&quot;rejected&quot;)</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//如果失败的promise没有失败回调可执行的话，node会报错（这种情况叫做拒绝捕获）</span>
<span class="token comment">//UnhandledPromiseRejectionWarning: Error: rejected</span>
<span class="token comment">//浏览器会报uncaught</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="异常穿透"><a href="#异常穿透" class="header-anchor">#</a> 异常穿透</h5> <div class="language-js extra-class"><pre class="language-js"><code>promise
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//异常穿透指的是，如果promise调用的是reject，使得promise变成失败的</span>
    <span class="token comment">//那么会执行then中第二个参数，也就是onRejected回调</span>
    <span class="token comment">//如果then只有第一个参数，那么就会将这个失败的promise的值传递到后面的then</span>
    <span class="token comment">//直到遇到有第二个参数的then或者是catch（catch本身是用then实现的）</span>
    <span class="token comment">//也就是传递到能执行onRejected回调的then或catch为止</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="拒绝捕获以及执行多次-catch"><a href="#拒绝捕获以及执行多次-catch" class="header-anchor">#</a> 拒绝捕获以及执行多次 catch</h5> <div class="language-js extra-class"><pre class="language-js"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果promise是rejected状态，上面的then会拒绝捕获</span>
<span class="token comment">//浏览器中会报错：uncaught</span>
<span class="token comment">//node中报错：UnhandledPromiseRejectionWarning:xxx</span>
<span class="token comment">//所以不要分开写，要么在then中写两个回调，要么在then后面接catch()</span>
promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果这里定义了多个独立的catch的话，会全部执行（跟then一样）</span>
promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343093.png" alt="image-20220121151428937"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343094.png" alt="image-20220121151449132"></p> <h4 id="finally"><a href="#finally" class="header-anchor">#</a> <code>finally</code></h4> <p><code>finally</code>方法是，无论<code>promise</code>对象变成<code>fulfilled</code>还是<code>rejected</code><strong>最终都会执行传入的回调</strong>（这个回调没有参数）</p> <blockquote><p>虽然<code>finally</code>的返回值也是<code>Promise</code>对象，但是。。。没那么伞兵在 finally 后面还接着<code>then</code>和<code>catch</code>吧</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行了finally中的回调'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="静态方法"><a href="#静态方法" class="header-anchor">#</a> 静态方法</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343095.png" alt="image-20220121154223905"></p> <h4 id="resolve-方法"><a href="#resolve-方法" class="header-anchor">#</a> resolve 方法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> rejecet</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//resolve静态方法是上面这个操作的语法糖</span>
<span class="token keyword">const</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> promise2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">a</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="reject-方法"><a href="#reject-方法" class="header-anchor">#</a> reject 方法</h4> <blockquote><p>注意，reject 方法不会根据你传入的内容来决定返回 Promise 的状态（状态移交），不管传入的是什么，返回的都是失败的 promise</p></blockquote> <h4 id="all-方法"><a href="#all-方法" class="header-anchor">#</a> all 方法</h4> <p>传入的是一个数组，<strong>如果数组元素不是 promise 的值的话</strong>，会在内部调用<code>Promise.resolve</code>方法转成<code>Promise</code>，直到所有的 Promise 状态<strong>都为<code>fulfilled</code>时</strong>返回一个成功的 promise 对象，它的 value 值是数组，这个数组中<strong>按序存储</strong>了这些 promise 的 value 值。</p> <p>如果 all 传入的 promise 数组中有一个 promise 的结果是 rejected，那么返回一个失败的 promise 对象，这个 promise 对象的 value 是<strong>最先变成 rejected 状态的 promise 的值</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="allsettled-方法-es11"><a href="#allsettled-方法-es11" class="header-anchor">#</a> allSettled 方法（es11）</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343096.png" alt="image-20220121160552745"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">allSettled</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343097.png" alt="image-20220121160651590"></p> <h4 id="race-方法"><a href="#race-方法" class="header-anchor">#</a> race 方法</h4> <p>只要有一个 promise 脱离了<code>pending</code>状态，就将这个 promise 的值和状态封装成新的 promise 作为 race 的返回值返回并结束</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> <span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="any-方法"><a href="#any-方法" class="header-anchor">#</a> any 方法</h4> <p>至少等到一个 promise 状态变为 fulfilled，就将这个 fulfilled 的值和状态封装成新的 promise 作为 any 的返回值。</p> <blockquote><p>如果全部都是 rejected 失败的 promise，那么会等到所有的 promise 都变成 rejected 的时候返回一个失败的 promise</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343098.png" alt="image-20220121161638892"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="实现-promise-与下面-promisea-结合看"><a href="#实现-promise-与下面-promisea-结合看" class="header-anchor">#</a> 实现 Promise（与下面 promisea+结合看）</h2> <p><a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">查看 promise 规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PROMISE_STATUS_FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PROMISE_STATUS_PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PROMISE_STATUS_REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
<span class="token comment">/*
  12、封装代码
    try{
        const res = onRejected(this.res)
        resolve(res)
    }catch (e) {
        reject(e)
    }
* */</span>
<span class="token keyword">function</span> <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span><span class="token parameter">callbackFn<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">callbackFn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//13、对回调的返回值进行判断，如果返回的是一个普通值，就直接用resolve(res)修改then返回的promise对象的状态和值</span>
    <span class="token comment">//如果返回的是promise对象，那么then返回的promise的状态就由这个对象来决定</span>
    <span class="token comment">//我认为then就是收集回调用的，如果promise对象变成fulfilled状态，就会回调then收集的第一个参数中的函数，变成rejected就会回调then收集的第二个参数中的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">myPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//13、如果返回的res是promise，当这个promise变成变成fulfilled（resolve之后）时，会回调then的第一个函数，在这个回调函数中执行resolve改变原来then函数返回的promise的状态</span>
      res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">myPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">exec</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//2、resolve和reject函数是只有状态为pending的时候才能被调用并且修改状态的，如果不是pending的话都是无效调用</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//5、在执行resolve修改状态之后，要执行then第一个参数收集的成功回调，用queueMicrotask将函数添加到微任务中</span>
        <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//8、因为是加到微任务中，等到主线程的内容执行完毕的时候执行这里的函数，这时就会出现一个问题</span>
          <span class="token comment">// 如果promise传入的executor同时执行了resolve和reject的话，这两个函数都会放到微任务中，</span>
          <span class="token comment">// 原本是只能修改一次状态的（由pending修改），但是如果不在这个添加到微任务的函数中判断状态的话，状态会修改多次，回调也会重复执行（没有下面这一行判断的话）</span>
          <span class="token comment">// 所以加入了下面的状态判断（其实加了这个状态判断的话，resolve函数和reject函数最外层的判断就没必要了）</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

          <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PROMISE_STATUS_FULFILLED</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token comment">//5、执行回调的时候记得传入promise的值，因为then的回调函数中可以有一个参数来获取promise的值：then(res=&gt;{})</span>
          <span class="token comment">// this.onFulfilled(this.res)</span>
          <span class="token comment">//6、执行数组中的函数</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//3、resolve和reject都需要接收一个参数，并且保存到Promise对象的res结果属性中</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PROMISE_STATUS_REJECTED</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> reason<span class="token punctuation">;</span>
          <span class="token comment">//5、执行回调的时候传入promise的值</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//11、用try catch包裹，解决在exec中直接抛出异常的而改变promise的状态的问题</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//1、传入的函数会被立即执行，并且传递两个参数，用于修改Promise的状态</span>
      <span class="token function">exec</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//4、创建then方法，用于收集回调</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//15、为了实现catch方法，本质是第一个参数为undefined的then，而then本身又可以只传第一个参数（第二个参数为undefined），所以需要对两个参数进行判断</span>
    <span class="token comment">//then是可以不传参数的，不传参数的时候返回的promise状态跟调用then的promise的状态和值一样</span>
    <span class="token comment">//下面的代码的目的是，如果前面的promise是成功的，那么在没传入第一个参数时会执行默认的onFulfilled回调</span>
    <span class="token comment">//这个回调就是，传入什么就返回什么，执行回调的时候会将promise的结果传入，会在execFunctionWithCatchError中执行该回调并且获取v（也就是上个promise的值）</span>
    <span class="token comment">//再根据这个v来决定then返回的promise的值和状态</span>
    <span class="token comment">//如果不加这个的话，catch（或者说是then没有传入参数，或者第一个参数为空）就无法将前面正确的promise传递到后面进行处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onFulfilled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//16、当onRejected没有传入的时候，给onRejected赋值一个默认的回调函数，这个回调函数用于抛出reject传入的值</span>
    <span class="token comment">//promise状态为rejected的时候，如果后面的then没有传入第二个参数，就会执行这个默认回调</span>
    <span class="token comment">//执行的时候抛出的异常会被catch到，并调用reject方法将then返回的promise的值和状态和前面失败的promise的状态和值保持一致，传递到后面，直到then有第二个参数时就不需要执行默认的抛出异常回调函数了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//9、为了达到链式调用的效果，我们需要将then返回一个自定义的promise，这个promise的状态和值与then的回调执行结果有关</span>
    <span class="token comment">//因为传入的exec是箭头函数，不适用四种绑定规则，所以在这个exec中的this取决于then中的this</span>
    <span class="token comment">//而then又是通过隐式绑定的规则来调用的，所以这里exec传入的this指向的是上一个promise对象，而不是返回的promise对象</span>
    <span class="token comment">//传入的exec会被立即执行，返回的promise的状态由exec执行的回调有关</span>
    <span class="token comment">//    -如果then执行的是onFulfilled成功的回调的话，返回的promise</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//7、then方法下面收集到数组中的函数对象是会在pending状态后执行的，那如果设置了定时器延迟调用then还会执行吗？</span>
      <span class="token comment">//原版的Promise是会执行的，所以这里还需要进行状态判断，如果不是pending状态就立即执行回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_FULFILLED</span> <span class="token operator">&amp;&amp;</span> onFulfilled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//9、保存回调结果，修改promise状态(后面会进行封装的)</span>
        <span class="token comment">// try{</span>
        <span class="token comment">//   const res = onFulfilled(this.res)</span>
        <span class="token comment">//   resolve(res)</span>
        <span class="token comment">// }catch (e) {</span>
        <span class="token comment">//   reject(e)</span>
        <span class="token comment">// }</span>
        <span class="token comment">//12、将9的代码封装一下</span>
        <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_REJECTED</span> <span class="token operator">&amp;&amp;</span> onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//6、原来的方式是不能实现执行多个then回调的，所以修改数据结构，将对应的函数对象存入数组</span>
        <span class="token comment">// this.onFulfilled = onFulfilled</span>
        <span class="token comment">// this.onRejected = onRejected</span>

        <span class="token comment">//10、因为在pending的时候是收集要执行的回调，等到修改状态的时候才执行数组中保存的回调函数</span>
        <span class="token comment">//那么执行的地方是在resolve或者reject函数中的微任务，获取回调函数的结果在这里也获取不到</span>
        <span class="token comment">//所以我们不能单纯的传入一个函数对象，而是要将这个函数对象封装在一个执行函数中</span>
        <span class="token comment">//在这个执行函数中执行这个回调函数，获取返回值，修改状态</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//12、封装一下</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//12、封装一下</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//14、catch本质上就是第一个参数为undefined的then咯，但是有一个问题，promise执行catch（本质上执行then）的时候收集了一个undefined函数，</span>
  <span class="token comment">//这样显然是不行的，所以我们需要在then前面进行两个参数非空的判断</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//、17实现finally（不管是成功还是失败都会执行的回调）</span>
  <span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// reject(222)</span>
  <span class="token comment">//11、如果在exec中抛出异常，</span>
  <span class="token comment">// throw new Error(&quot;111&quot;)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 进入then中的pending判断</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'执行了pending时加入数组的回调'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'执行了pending时加入数组的回调'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'执行了pending时加入数组的回调'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'执行了pending时加入数组的回调'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//测试抛出异常</span>
<span class="token comment">// p.then(res=&gt;{</span>
<span class="token comment">//   console.log(res,'执行了修改状态后then中fulfilled的回调')</span>
<span class="token comment">//   throw new Error('err')</span>
<span class="token comment">// },err=&gt;{</span>
<span class="token comment">//   console.log(err,'执行了修改状态后then中的rejected回调')</span>
<span class="token comment">// }).then(res=&gt;{</span>
<span class="token comment">//   console.log(res,'执行了修改状态后then中fulfilled的回调')</span>
<span class="token comment">// },err=&gt;{</span>
<span class="token comment">//   console.log(err,'执行了修改状态后then中的rejected回调')</span>
<span class="token comment">// })</span>

<span class="token comment">//测试返回值是promise</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token string">'返回的是成功的promise，在内部调用了then方法决定外层then的返回的promise的状态'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//延迟调用then，进入then中的rejected判断</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'执行了修改状态后then中fulfilled的回调'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'执行了修改状态后then中的rejected回调'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>纯净版</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PROMISE_STATUS_FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PROMISE_STATUS_PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PROMISE_STATUS_REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">myPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">myPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">exec</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilleds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejecteds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PROMISE_STATUS_FULFILLED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilleds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PROMISE_STATUS_REJECTED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejecteds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">exec</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onRejected <span class="token operator">=</span>
      onRejected <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    onFulfilled <span class="token operator">=</span> onFulfilled <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//12、封装一下</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PROMISE_STATUS_PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilleds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejecteds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">execFunctionWithCatchError</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="实现-promise-的静态方法"><a href="#实现-promise-的静态方法" class="header-anchor">#</a> 实现 promise 的静态方法</h3> <blockquote><p>实现静态方法的关键就是，什么时候调用 resolve 和 reject 来改变返回的 promise 的状态</p></blockquote> <hr> <p>这里不应该简单的<code>resolve</code>，因为 value 有可能传入的是<code>thenable</code>的值或者是一个<code>promise</code>对象，那么<code>Promise.resolve</code>返回的<code>promise</code>应该由传入的<code>value</code>决定。虽然<code>promisea+</code>没有这个<code>api</code>，但是为了实现这个<code>api</code>的效果，可以用<code>promisea+</code>规范中的<code>promiseResolve</code>函数</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343099.png" alt="image-20220122150341526"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343100.png" alt="image-20220124175724828"></p> <hr> <p>下面这里应该判断，promises 数组中是否有<strong>普通类型</strong>的数据，有的话需要用<code>Promise.resolve</code>包裹</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343101.png" alt="image-20220122150000946"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343102.png" alt="image-20220122150032026"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343103.png" alt="image-20220122150159207"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343104.png" alt="image-20220122150323512"></p> <h2 id="按照-promisea-实现-promise"><a href="#按照-promisea-实现-promise" class="header-anchor">#</a> 按照 PromiseA+实现 Promise</h2> <p>https://www.ituring.com.cn/article/66566</p> <h3 id="初体验"><a href="#初体验" class="header-anchor">#</a> 初体验</h3> <ul><li>要点 1：executor 类型检测</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343105.png" alt="image-20220122191337622"></p> <ul><li>要点 2：<code>resolve</code>和<code>reject</code>需要定义为箭头函数，因为在 executor 中调用这两个函数的时候是独立调用，this 指向全局，但是我们希望的是指向构造函数里的 this（因为要修改状态和保存值）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//不能相信用户的输入，参数校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> executor <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise resolver </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>executor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a function</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//初始化值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//终值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//拒因</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span> <span class="token comment">//状态</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//状态只能从 pending =&gt; 其他</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//失败后的一系列操作（状态的改变，失败回调的执行）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="then-方法初步实现"><a href="#then-方法初步实现" class="header-anchor">#</a> then 方法初步实现</h3> <ul><li>判断<code>onFulfilled</code>和<code>onRejected</code>是否是函数类型，不是函数类型（或者没传，undefined）就赋一个默认回调来达到<strong>穿透（传递）效果</strong></li> <li>只有状态改变后才能调用（状态为 pending 的时候不能调用）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> executor <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise resolver </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>executor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a function</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//参数校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//不能在状态改变前调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//不能在状态改变前调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="异步解决实现"><a href="#异步解决实现" class="header-anchor">#</a> 异步解决实现</h3> <ul><li>原版 promise 的 then 方法中的回调是异步执行的，验证如下，所以实现的 Promise 的回调也要<strong>异步执行</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//这段代码的输出结果是1,2,3,4（原版Promise）</span>
<span class="token comment">//但是放到上面一个小节中，输出结果是1,2,4,3，也就是说，then中的回调是立即执行了</span>
</code></pre></div><ul><li>在构造函数中的<code>executor</code>执行外面加<code>try...catch</code>解决在<code>executor</code>中抛出异常的问题</li> <li>在 then 中添加<strong>pending 状态的判断</strong>，将回调存入数组等到状态改变的时候执行，解决在<code>executor</code>中执行异步**，延迟修改状态导致 then 中的回调函数没有执行**的情况</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> executor <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise resolver </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>executor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a function</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token comment">//状态修改后执行（针对pending状态时存入的回调）</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token comment">//状态修改后执行（针对pending状态时存入的回调）</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//捕获executor中的异常</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//将回调异步执行</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//将回调异步执行</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//executor中异步修改状态，此时执行then的时候是pending状态，需要保存要执行的回调函数，等到状态修改后执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//将回调异步执行</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//将回调异步执行</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">;</span>
</code></pre></div><h3 id="链式调用实现"><a href="#链式调用实现" class="header-anchor">#</a> 链式调用实现</h3> <ul><li>then 返回值是一个新的 promise</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343106.png" alt="image-20220122202151395"></p> <ul><li>promise 解决过程
<ul><li>如果<code>x === promise2</code></li> <li>如果<code>x instanceof Promise</code></li> <li>如果 <code>x是object || x是function</code></li></ul></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343107.png" alt="image-20220122203022509"></p> <ul><li>如果 then 回调的返回值 x 是 promise，并且这个 promise 的 resolve 中又返回一个 promise，那么 promise2 的结果由这个 resolve 中的 promise 决定。（，状态移交，很细节！！！！）</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343108.png" alt="image-20220122204646367"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> executor <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise resolver </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>executor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a function</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果onFulfilled不是函数，且promise1成功执行，promise2必须返回相同的终值(状态为fulfilled)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果onRejected不是函数，且promise1拒绝执行，promise2必须返回相同的拒绝原因(状态为rejected)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果onFulfilled或onRejected执行时抛出一个异常e，则返回的promise必须拒绝执行，并返回拒因e</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果有返回值，则执行promise解决过程</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Promise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Promise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              Promise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
              Promise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Promise<span class="token punctuation">.</span><span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">resolvePromise</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果 promise 和 x 指向同一对象，以 TypeError 为据因拒绝执行 promise（形成了链式调用）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//标记如果x是对象或函数且有then方法时，回调只能调一次，避免出现{then(a,b){ a() ;a() }}多次调用，多次执行的情况</span>
  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">//如果返回值x是promise类型，那么then返回的promise的类型与这个promise的执行结果一致</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//什么时候执行结束?执行了x.then中的回调的时候说明promise（x）中的executor执行结束了</span>
    x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里不应该简单的执行resolve，因为如果x的resolve的参数是一个promise对象的话，promise2的结果由这个参数决定</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果x是对象或者是函数，注意：null也是object类型，所以要特判不能为null</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//可能x对象的then方法中会抛出异常</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//规范要求我们先将x.then存储到then中，避免重复从对象中取值</span>
      <span class="token keyword">const</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token comment">//判断是不是thenable对象（有then方法的对象）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            Promise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//不是thenable对象的话，就是普通对象，直接resolve</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//是普通值</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h3> <p>到目前为止，符合 promise/A+规范的 promise 就实现了（<strong>但是并不包括 resolve 和 rejectz 中的状态移交</strong>，可能这只是 ECMA 新增的东西吧，就好像 promise 的一些静态方法一样是 ECMA 拓展的）</p> <ul><li>实现 promise 各种<code>api</code>的核心是实现 then 方法，then 方法本应有两个参数，如果某个参数没有或者不是函数类型，那么会赋<strong>默认的回调函数</strong>，这个默认的回调函数是 then 能够<strong>传递</strong>promise 状态和值的核心</li> <li>只要是执行回调函数的地方，都应该写成<strong>异步执行</strong>，并且 try...catch 捕获可能出现的异常（executor 是同步执行的，不用异步）</li> <li>另一个核心就是<code>promiseResolve</code>方法的实现，这个方法是<strong>链式调用</strong>的核心，决定了 then 方法返回的 promise 的状态。</li></ul> <h1 id="_15、iterator-generator"><a href="#_15、iterator-generator" class="header-anchor">#</a> 15、iterator-generator</h1> <h2 id="iterator"><a href="#iterator" class="header-anchor">#</a> iterator</h2> <p>迭代器是一个对象，实现了<code>[Symbol.iterator]()</code>方法的对象是<strong>可迭代对象</strong>，这个方法会返回迭代器。迭代器这个对象要求有<code>then</code>方法，且返回值是<code>{done:boolean,value:any}</code>的对象</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343109.png" alt="image-20220123151216837"></p> <blockquote><p>注意：next 是一个无参函数或者有一个参数的函数</p></blockquote> <h3 id="迭代器初体验"><a href="#迭代器初体验" class="header-anchor">#</a> 迭代器初体验</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//获取names数组对象内部的迭代器对象</span>
<span class="token keyword">const</span> iterator <span class="token operator">=</span> names<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// return { done:false , value: 1}</span>
    <span class="token comment">// return { done:false , value: 2}</span>
    <span class="token comment">// return { done:false , value: 3}</span>
    <span class="token comment">// return { done:true , value: undefined}</span>
    <span class="token comment">//当超出数组下标的时候，done是true，value是undefined</span>
    <span class="token keyword">return</span> index <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length
      <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> names<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="生成迭代器的函数"><a href="#生成迭代器的函数" class="header-anchor">#</a> 生成迭代器的函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> index <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length
        <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> arr<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="可迭代对象"><a href="#可迭代对象" class="header-anchor">#</a> 可迭代对象</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343110.png" alt="image-20220123160957310"></p> <blockquote><p>可迭代对象要求有一个函数名为<code>Symbol.iterator</code>的函数，这个函数<strong>返回的是迭代器对象</strong>，而迭代器的要求是要有 next 方法，<strong>next 方法的返回值包括 done 和 value 两个属性</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> iterableObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//注意，这里不能写成function，因为返回的迭代器对象调用next方法时，是通过对象.next隐式绑定的，this指向的是迭代器对象</span>
      <span class="token comment">// 而返回的迭代器对象中没有names，所以我们要写成箭头函数，将this绑定为可迭代对象的[Symbol.iterator]函数中的this</span>
      <span class="token comment">//因为这个函数也是通过对象[Symbol.iterator]隐式绑定的，而箭头函数this的指向这个function的this，进而箭头函数的this指向的是iterableObj对象</span>
      <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span>length
          <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iterator<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> iterator <span class="token operator">=</span> iterableObj<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//for..of只能遍历可迭代对象，本质上调用的是可迭代对象的[Symbol.iterator]函数返回的迭代器的next()方法</span>
<span class="token comment">//直到next方法返回的done为true的时候停止迭代</span>
<span class="token comment">//是上面调用方式的语法糖</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> iterableObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="原生的可迭代对象"><a href="#原生的可迭代对象" class="header-anchor">#</a> 原生的可迭代对象</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343111.png" alt="image-20220123164428460"></p> <h3 id="可迭代对象的应用场景"><a href="#可迭代对象的应用场景" class="header-anchor">#</a> 可迭代对象的应用场景</h3> <blockquote><p>注意，是可迭代对象！而不是迭代器</p></blockquote> <h4 id="for-of"><a href="#for-of" class="header-anchor">#</a> for..of</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//普通对象是不能用for..of的</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="展开语法"><a href="#展开语法" class="header-anchor">#</a> 展开语法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//普通对象是不能直接展开的，会报错</span>
<span class="token comment">// console.log(...obj)</span>

<span class="token comment">//注意，这个是对象中用展开语法，是es9新增的，本质上用的不是迭代器</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>obj <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="解构"><a href="#解构" class="header-anchor">#</a> 解构</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jzsp'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">;</span>
<span class="token comment">//注意，这个本质上用的不是迭代器，是es9新增语法</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
</code></pre></div><h4 id="创建可迭代对象时传入可迭代对象"><a href="#创建可迭代对象时传入可迭代对象" class="header-anchor">#</a> 创建可迭代对象时传入可迭代对象</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="其他一些可以传入迭代器的-api-例举"><a href="#其他一些可以传入迭代器的-api-例举" class="header-anchor">#</a> 其他一些可以传入迭代器的 api 例举</h4> <p><code>Promise.all</code></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343112.png" alt="image-20220123165539638"></p> <p><code>Array.from</code></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343113.png" alt="image-20220123165640752"></p> <h3 id="自定义类实现可迭代的案例"><a href="#自定义类实现可迭代的案例" class="header-anchor">#</a> 自定义类实现可迭代的案例</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343114.png" alt="image-20220123170102340"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">classromm</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">address<span class="token punctuation">,</span> name<span class="token punctuation">,</span> students</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>students <span class="token operator">=</span> students<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">entry</span><span class="token punctuation">(</span><span class="token parameter">newStudent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newStudent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//在对象的原型链上添加[Symbol.iterator]方法</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">.</span>length
          <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">classromm</span><span class="token punctuation">(</span><span class="token string">'台州'</span><span class="token punctuation">,</span> <span class="token string">'九折水瓶'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> roomElement <span class="token keyword">of</span> room<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>roomElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="迭代器的中断-return-方法"><a href="#迭代器的中断-return-方法" class="header-anchor">#</a> 迭代器的中断（return 方法）</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343115.png" alt="image-20220123171401138"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">classromm</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">address<span class="token punctuation">,</span> name<span class="token punctuation">,</span> students</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>students <span class="token operator">=</span> students<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">entry</span><span class="token punctuation">(</span><span class="token parameter">newStudent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newStudent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">.</span>length
          <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">//如果迭代过程被break掉了，会进入迭代器的return函数，这个函数要求返回的也是一个具有done和value属性的对象</span>
      <span class="token function-variable function">return</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'迭代器提前结束啦'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">classromm</span><span class="token punctuation">(</span><span class="token string">'台州'</span><span class="token punctuation">,</span> <span class="token string">'九折水瓶'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> roomElement <span class="token keyword">of</span> room<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//提前结束迭代器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>roomElement <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>roomElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343117.png" alt="image-20220123171056192"></p> <h2 id="generator"><a href="#generator" class="header-anchor">#</a> generator</h2> <h3 id="生成器和生成器函数"><a href="#生成器和生成器函数" class="header-anchor">#</a> 生成器和生成器函数</h3> <ul><li><strong>生成器</strong>是 ES6 新增的一种函数控制、使用的方案，它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行。生成器是<strong>特殊的迭代器</strong>，可以调用 next 方法</li> <li><strong>生成器函数</strong>是一个函数，但是与普通的函数比有区别
<ul><li>生成器函数需要在<code>function</code>后面加*</li> <li>生成器函数内部可以通过<code>yield</code>关键字来控制函数的执行流程</li> <li>生成器函数的返回值是<code>generator</code><strong>生成器对象</strong></li></ul></li></ul> <h3 id="生成器函数的执行流程"><a href="#生成器函数的执行流程" class="header-anchor">#</a> 生成器函数的执行流程</h3> <ul><li>遇到 yield 暂停，next 的返回值中 done 是 false</li> <li>遇到 return 停止（return 是特殊的 yield）next 的返回值中 done 是 true</li> <li>第<code>i</code>次 next 返回的对象中的 value 值 是 第<code>i</code>次 yield 操作符后的值</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token string">'我是返回值'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//调用生成器函数获取生成器对象</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//调用next执行代码，直到碰到yield停止。</span>
generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//如果函数碰到yield停止了，可以再次调用next，直到再次碰到yield停止</span>
generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//因为生成器generator是特殊的迭代器，有next方法，返回值的格式跟迭代器一样</span>
<span class="token comment">//value是yield关键字后面跟着的值（或者是return的值）</span>
<span class="token comment">//done的话，如果当前next没有被yield关键字暂停执行，也就是说后面没有yield，那么done就为true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ value: 'jzsp' done: false }</span>

<span class="token comment">//done为true的时候，也就是函数执行结束的时候，value的值是函数return的值（默认是undefined）</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ value: '我是返回值', done: true }</span>
</code></pre></div><h3 id="next-传参"><a href="#next-传参" class="header-anchor">#</a> next 传参</h3> <p>第<code>i</code>次调用 next 时传的参数，会作为第<code>i-1</code>次<code>yield</code>表达式的<strong>返回值</strong>。</p> <p>第一段（第一个 yield 前）代码需要传值的话，可以在调用生成器函数的时候传入</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343118.png" alt="image-20220123194610331"></p> <h3 id="return-终止执行"><a href="#return-终止执行" class="header-anchor">#</a> return 终止执行</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token punctuation">;</span>

  <span class="token comment">// return n</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'我是返回值'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//return是可以传入参数的，功能跟next一样，是作为上一个yield的返回值</span>
<span class="token comment">//调用return方法的话，相当于在第i-1个yield后面加上了return n</span>
<span class="token comment">//返回值是{done : true , value : 15}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="throw-抛出异常"><a href="#throw-抛出异常" class="header-anchor">#</a> throw 抛出异常</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//捕获到异常 err msg</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token string">'jzsp'</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'我是返回值'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//给第i-1个yield抛出异常，如果有捕获异常，那么代码可以正常执行（执行catch内部的方法，如果catch内部没有yield就继续向后执行）直到遇到下一个yield</span>
<span class="token comment">//如果没有捕获异常，代码报错</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">'err msg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ value: undefined, done: false }</span>
</code></pre></div><h3 id="用生成器代替迭代器-yield"><a href="#用生成器代替迭代器-yield" class="header-anchor">#</a> 用生成器代替迭代器（yield*)</h3> <blockquote><p>生成迭代器函数就是，传入要迭代的数据，返回能够迭代该数据的迭代器。生成器代替迭代器的原理是，生成器用 yield 可以实现暂停效果，用 next 可以实现迭代效果，并且 next 返回对象中的<strong>done 属性会根据 yield 的迭代情况自动判断</strong>，<strong>value 属性就是 yield 关键字后的值</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> index <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length
        <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> arr<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//代替写法</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//第一种写法</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> item<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//第二种写法：yield*后面跟着的是可迭代对象，每次调用next的时候会迭代一次可迭代对象</span>
  <span class="token keyword">yield</span><span class="token operator">*</span> arr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="案例-1"><a href="#案例-1" class="header-anchor">#</a> 案例 1</h4> <blockquote><p>创建一个函数，这个函数可以迭代一个范围内的数字</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token parameter">begin<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> begin<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> index <span class="token operator">&lt;=</span> end
        <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> index<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//注意，迭代器不代表是可迭代对象，可迭代对象是实现了[Symbol.iterator]()函数的对象</span>
<span class="token comment">//for..of遍历的是可迭代对象</span>
<span class="token comment">//我真蠢。。</span>
<span class="token comment">// for (const item of a) {</span>
<span class="token comment">//   console.log(item)</span>
<span class="token comment">// }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>用生成器代替迭代器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token parameter">begin<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> begin<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">createArrayIterator</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="案例-2"><a href="#案例-2" class="header-anchor">#</a> 案例 2</h4> <blockquote><p>前面的 classroom 的案例，用生成器代替迭代器的实现</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">classromm</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">address<span class="token punctuation">,</span>name<span class="token punctuation">,</span>students</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token keyword">this</span><span class="token punctuation">.</span>students <span class="token operator">=</span> students
  <span class="token punctuation">}</span>
  <span class="token function">entry</span><span class="token punctuation">(</span><span class="token parameter">newStudent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newStudent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//生成器函数</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>students
  <span class="token punctuation">}</span>
  <span class="token comment">//也可以这样定义生成器函数</span>
  <span class="token operator">*</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">classromm</span><span class="token punctuation">(</span><span class="token string">'台州'</span><span class="token punctuation">,</span><span class="token string">'九折水瓶'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> roomElement <span class="token keyword">of</span> room<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>roomElement<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="概念总结"><a href="#概念总结" class="header-anchor">#</a> 概念总结</h2> <ul><li><p>iterator 迭代器对象是一个对象，这个对象必须有 then 方法，且这个方法的返回值是<code>{done:boolean,value:any}</code>形式的对象。</p></li> <li><p>实现了<code>[Symbol.iterator]()</code>方法的对象是<strong>可迭代对象</strong>，这个方法返回一个迭代器对象</p></li> <li><p>for..of 遍历的是<strong>可迭代对象</strong>，而不是迭代器对象</p></li> <li><p>生成器函数是<code>function</code>后面有符号*的函数，生成器函数的执行结果是<strong>生成器对象</strong></p></li> <li><p>生成器对象是特殊的<code>iterator</code>对象，也有<code>then</code>方法，通过<code>then</code>方法与<code>yield</code>操作符控制生成器函数的执行与暂停</p></li> <li><p><strong>第<code>i</code>个 yield 后面跟着的值是第<code>i</code>个 then 方法返回的对象的 value 属性的值</strong></p></li> <li><p><strong>第<code>i</code>个 then 方法传入的参数是第<code>i-1</code>个 yield 操作符的返回值</strong></p></li></ul> <h1 id="_16、async-await"><a href="#_16、async-await" class="header-anchor">#</a> 16、async/await</h1> <h2 id="async-函数"><a href="#async-函数" class="header-anchor">#</a> async 函数</h2> <p>在声明函数前加上 async 关键字就可以变成 async 函数。</p> <blockquote><p>注意，加上 async 关键字不代表函数就变成异步的了，在函数内部<strong>正常写</strong>的话，跟普通函数没有太大区别</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//输出顺序是123，说明foo并没有变成异步函数</span>
</code></pre></div><blockquote><p>async 函数的返回值一定是一个 promise，这个返回的 promise 由 async 函数 return 的内容决定。</p></blockquote> <ul><li>如果 return 的是<strong>thenable 对象</strong>，那么返回的 promise 的值由这个 thenable 对象的 then 函数执行结果决定</li> <li>如果 return 的是<strong>promise</strong>，那么返回的 promise 的值由这个 promise 的值决定</li> <li>如果 return 的是<strong>普通值</strong>，那么返普通值会作为返回的 promise 的<strong>resolve</strong>值</li> <li>如果在 async 函数内<strong>抛出异常</strong>，那么异常值会作为返回的 promise 的<strong>reject</strong>值</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="await-关键字"><a href="#await-关键字" class="header-anchor">#</a> await 关键字</h2> <p>await 关键字后面经常跟上一个<strong>promise（或者 thenable 的对象）</strong>，当这个 promise 状态没有改变（一直是 pending 的时候），下面的代码都不会执行。等到 promise 状态改变的时候，会将 promise 的值取出作为 await 关键字的返回值，然后可以继续执行后面的代码。<strong>（如果是普通值，就直接作为 await 的关键字的返回值）</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//我们默认是成功的</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------'</span><span class="token punctuation">,</span> res2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>如果 await 后的 promise 结果是<strong>reject 失败</strong>的，那么会将 reject 的值作为整个 async 函数 foo 返回的 promise 的 reject 的值，<strong>并且不会向下执行</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//不会向下执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>await 关键字是语法糖（<strong>yield 后面是 Promise 的话，会在 promise 执行结束的时候将 promise 封装在<code>next()</code>返回的对象的 value 属性中，想执行下一步需要调用 next 方法；await 后面是 Promise 的话，会在 promise 执行结束时取出 Promise 的值作为 await 关键字的返回值，并且将下面的代码放到 promise 的 then 方法中执行</strong>），await 关键字后面的代码<strong>本质上是在当前 await 返回的 Promise 的 then 方法中执行的</strong>，也就是说，await 后面的代码是放到<strong>微任务</strong>中执行的。需要注意的是，await 后如果跟着的是常数，await 关键字下面的代码本质上还是会被放到微任务中。</p></blockquote> <h2 id="解决异步问题"><a href="#解决异步问题" class="header-anchor">#</a> 解决异步问题</h2> <blockquote><p>现在想<strong>模拟</strong>的是，发送一个字符串给服务器，服务器将这个返回，我们再将这个返回的字符串拼接上 aaa 再发送，服务器再返回，我们再拼接上 bbb 再发送，服务器再返回。下面是模拟请求的函数。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//我们默认是成功的</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="方法-1-promise-链式调用"><a href="#方法-1-promise-链式调用" class="header-anchor">#</a> 方法 1：promise 链式调用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//then将返回的promise给return出去，</span>
<span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'111'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>res <span class="token operator">+</span> <span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>res <span class="token operator">+</span> <span class="token string">'bbb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="方法-2-promise-generator-async-和-await-的原理"><a href="#方法-2-promise-generator-async-和-await-的原理" class="header-anchor">#</a> 方法 2：promise+generator（async 和 await 的原理）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>res1 <span class="token operator">+</span> <span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>res2 <span class="token operator">+</span> <span class="token string">'bbb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//手动执行（回调地狱）</span>
<span class="token comment">//第一次next获取到第一个yield返回的promise</span>
<span class="token comment">//第二次next传入第一个promise值，这个值会作为第一个yield的返回值res1</span>
<span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//自动执行，传入生成器函数对象，在内部通过递归自动执行</span>
<span class="token keyword">function</span> <span class="token function">execGenerator</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//先调用next获取返回值</span>
    <span class="token comment">//第i个then方法传入的参数是第i-1个yield操作符的返回值</span>
    <span class="token comment">//第i个then方法的返回对象的value属性是第i个yield操作符后的值</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否迭代完成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//没迭代完成的话，就取出返回值（对象）中的value（promise），在then中取出promise的值，递归调用</span>
    res<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">exec</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">execGenerator</span><span class="token punctuation">(</span>getData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="方法-3-async-await-promise"><a href="#方法-3-async-await-promise" class="header-anchor">#</a> 方法 3：<code>async/await+promise</code></h3> <blockquote><p>本质上是 generator+promise 的语法糖</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>res1 <span class="token operator">+</span> <span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>res2 <span class="token operator">+</span> <span class="token string">'bbb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="_17、node-事件循环-微任务和宏任务"><a href="#_17、node-事件循环-微任务和宏任务" class="header-anchor">#</a> 17、node 事件循环，微任务和宏任务</h1> <h2 id="js-线程"><a href="#js-线程" class="header-anchor">#</a> js 线程</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343119.png" alt="image-20220124142812159"></p> <p>因为 js 是单线程的，代码从上往下执行，但是可能会有一些特殊的东西（回调函数），<strong>并不是从头到尾执行的</strong>，因为回调函数可能包裹在 setTImeout 中，等到时间到了再执行回调，或者是在 then 方法中，等到 promise 状态改变了再执行回调。那么为了准备执行这些函数，<strong>因为 js 是单线程的，一次只能执行一个函数</strong>。我们现在要研究的就是，<strong>到底哪个回调函数会先执行（在调用后）</strong>。这里就涉及到<strong>事件队列以及事件循环</strong>了。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343120.png" alt="image-20220124143623437"></p> <h2 id="浏览器事件循环"><a href="#浏览器事件循环" class="header-anchor">#</a> 浏览器事件循环</h2> <p>示例代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>事件循环是指，在 js 线程遇到耗时的异步操作时，将操作交给浏览器的其他线程来执行，等到耗时操作完成时，浏览器其他线程将回调函数加入事件队列（事件队列是浏览器维护的一个队列），js 线程会从事件队列中取出回调函数压入调用栈进行执行。<strong>这个过程形成了一个闭环，这个闭环成为浏览器的事件循环</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343121.png" alt="image-20220124145552674"></p> <h2 id="事件队列"><a href="#事件队列" class="header-anchor">#</a> 事件队列</h2> <p><strong>事件队列本质上由两个队列组成</strong></p> <ul><li>宏任务队列包括：<strong>Ajax</strong>，定时器，DOM<strong>事件监听</strong>，UI Rendering 等一些列<code>api</code>中的<strong>回调函数</strong></li> <li>微任务队列包括：<strong>queueMicrotask</strong>，<code>Promise.then</code>，await 后的函数</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343122.png" alt="image-20220124150656887"></p> <p><strong>事件循环对两个队列的优先级是怎样的呢？</strong></p> <p>先让 js 线程执行 main script 的代码（顶层代码），等到<strong>执行完顶层代码后</strong>，从事件队列中取回调函数执行。<strong>在执行宏任务之前会先看看微任务队列中是否有任务需要执行</strong></p> <ul><li>也就是说，宏任务执行前，必须保证微任务队列是空的</li> <li>如果微任务队列不为空，就优先执行微任务队列中的回调函数</li></ul> <h2 id="node-事件循环"><a href="#node-事件循环" class="header-anchor">#</a> node 事件循环</h2> <p>LIBUV 库是实现事件循环的核心。下面图的意思是，在 js 代码中，有类似 setTImeout 的函数，交给 v8 引擎，v8 引擎将操作交给 LIBUV 中的其他线程执行，执行结束之后将回调函数压入事件队列中，然后 v8 从中获取回调函数进行执行</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343123.png" alt="image-20220124182932317"></p> <p>node 之所以能写后端就是因为这个 LIBUV 这个库，它可以执行很多操作，例如 IO，网络请求等，执行结束之后将传入的回调函数压入事件队列，然后引擎从事件队列中获取回调进行执行。<strong>事件循环更像是一个桥梁，是连接着系统调用之间的渠道</strong></p> <h3 id="node-事件循环的阶段"><a href="#node-事件循环的阶段" class="header-anchor">#</a> node 事件循环的阶段</h3> <blockquote><p>注意：setTimeout 和 setInterval 优先于 setImmediate</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343124.png" alt="image-20220124183838336"></p> <h3 id="node-的宏任务和微任务"><a href="#node-的宏任务和微任务" class="header-anchor">#</a> node 的宏任务和微任务</h3> <p>微任务和宏任务内部其实是有很多队列的。下面截图中是按照优先级从<strong>高到低来往下排列的</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343125.png" alt="image-20220124184744357"></p> <h2 id="面试题-1"><a href="#面试题-1" class="header-anchor">#</a> 面试题 1</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTImeout2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'queueMicrotask1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>解析：代码从上往下执行</p> <ul><li>main script 执行到第一个<code>setTImeout</code>的时候，会将<code>setTimeout</code>内部的整个<code>function</code>加入宏任务队列</li> <li>main script 执行到第一个<code>new Promise</code>的时候，会立即执行<code>Promise</code>的<code>executor</code>，<strong>输出 promise1</strong>，并且将<code>then</code>后面的回调函数加入微任务队列</li> <li>main script 执行到第二个<code>setTImeout</code>的时候，会将<code>setTimeout</code>内部的整个<code>function</code>加入宏任务队列</li> <li>main script 执行到<code>console.log(2)</code>的时候，会直接<strong>输出 2</strong></li> <li>main script 执行到<code>queueMicrotask</code>时，会将<code>queueMicrotask</code>内部的整个<code>function</code>加入微任务队列</li> <li>main script 执行到第二个<code>new Promise</code>的时候，会立即执行 resolve</li></ul> <p>此时 main script 执行结束，任务队列情况如下</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343126.png" alt="image-20220124153946893"></p> <hr> <p>紧接着，要从任务队列中调取回调函数进行执行。在掉宏任务队列中的任务前，需要将微任务队列中的任务全部执行</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343127.png" alt="image-20220124154138286"></p> <hr> <p>然后执行第一个宏任务：</p> <ul><li>执行到<code>console.log('setTimeout1')</code>时，直接<strong>输出<code>setTimeout1</code></strong></li> <li>执行到<code>new Promise</code>时，直接执行 executor 中的<code>resolve()</code>，然后将后面的 then 中的整个函数加入微任务队列，第一个宏任务执行完毕。</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343128.png" alt="image-20220124154654895"></p> <hr> <p>此时微任务队列中有任务，需要先执行微任务：</p> <ul><li>执行到<code>new Promise</code>的时候，直接执行<code>resolve()</code>，并将后面的<code>then</code>中的回调函数放入微任务队列中，执行到<code>console.log('then2')</code>的时候，直接<strong>输出 then2</strong>。此时微任务执行完毕</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343129.png" alt="image-20220124154950269"></p> <hr> <p>微任务队列还有任务，继续执行微任务：</p> <ul><li>执行到<code>console.log('then4')</code>的时候，<strong>输出 then4</strong>，此时微任务执行完毕</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343130.png" alt="image-20220124155123229"></p> <hr> <p>执行宏任务队列中的任务：</p> <ul><li>执行到<code>console.log('setTimeout2'</code>)时，直接输出<code>setTimeout2</code>，此时宏任务结束</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343131.png" alt="image-20220124155304198"></p> <hr> <p>验证</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343132.png" alt="image-20220124155655406"></p> <h2 id="面试题-2"><a href="#面试题-2" class="header-anchor">#</a> 面试题 2</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>解析：代码从上往下执行</p> <ul><li>main script，前面两个 async 函数声明</li> <li>main script，执行到<code>console.log('script start')</code>，<strong>输出<code>script start</code></strong></li> <li>main script，执行到第一个<code>setTImeout</code>时，将<code>function</code>加入宏任务</li> <li>main script，执行到<code>async1()</code>时
<ul><li>执行到<code>console.log('async1 start')</code>时，<strong>输出<code>async1 start</code></strong></li> <li>执行到<code>await async2()</code>时
<ul><li>执行到<code>console.log('async2')</code>时，<strong>输出<code>async2</code></strong>，<code>async2</code>函数没有<code>return</code>，默认将<code>Promise.resolve(undefined)</code>这个 promise 对象返回</li></ul></li> <li>执行完<code>await asyn2()</code>后，<strong>将 await 下面的代码加入微任务中</strong></li></ul></li> <li>main script，执行到<code>new Promise</code>时，立即执行 executor 中的函数。<strong>输出<code>promise1</code></strong>，执行<code>resolve()</code>，将 then 中的函数加入微任务中</li> <li>main script，执行到<code>console.log('script end')</code>时，<strong>输出<code>script end</code></strong></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343133.png" alt="image-20220124164433305"></p> <hr> <p>按照优先级，先执行微任务队列中的回调函数</p> <ul><li>执行<code>console.log('async1 end')</code>时，<strong>输出<code>async1 end</code></strong></li> <li>执行<code>console.log('promise2')</code>时，<strong>输出<code>promise2</code></strong></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343134.png" alt="image-20220124164742260"></p> <hr> <p>执行宏任务队列</p> <ul><li>执行<code>console.log('setTimeout')</code>时，<strong>输出<code>setTimeout</code></strong></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343135.png" alt="image-20220124164837867"></p> <hr> <p>验证</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343136.png" alt="image-20220124164854085"></p> <h2 id="面试题-3△"><a href="#面试题-3△" class="header-anchor">#</a> 面试题 3△</h2> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">//如果return的是一个thenable的对象，那么会延迟一个微任务</span>
    <span class="token comment">//如果return的是Promise.resolve(4)  (promise对象)，那么会延迟两个微任务</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>解析：代码从上往下执行</p> <ul><li>main script 执行完第一个<code>Promise.resolve</code>时，将<code>后面第一个then</code>内的函数存入微任务队列</li> <li>main script 执行完第二个<code>Promise.resolve</code>时，将<code>后面第一个then</code>内的函数存入微任务队列，此时 main script 结束</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343137.png" alt="image-20220124181747437"></p> <hr> <p>执行微任务队列中的任务：</p> <ul><li>执行到<code>console.log(0)</code>时，<code>输出0</code></li> <li>执行完 return 4，将后面 then 内的函数加入微任务，此时微任务结束</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343138.png" alt="image-20220124182037866"></p> <hr> <p>继续执行任务队列中的任务</p> <ul><li>执行到<code>console.log(1)</code>时，<code>输出1</code>，<strong>将后面 then 内的函数加入微任务</strong>，此时微任务结束</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343139.png" alt="image-20220124182225817"></p> <hr> <p>继续执行微任务中的任务</p> <ul><li>执行到<code>console.log(res)</code>时，输出 4，微任务结束</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343140.png" alt="image-20220124182327909"></p> <p>。。。。</p> <p>答案是 0,1,4,2,3,5,6</p> <h2 id="面试题-4"><a href="#面试题-4" class="header-anchor">#</a> 面试题 4</h2> <blockquote><p>node 中事件队列的优先级看 node 中的宏任务和微任务部分</p></blockquote> <p>代码如下，左侧的两个截图是上面显示不下的部分。右侧的标注是 main script 执行结束时输出的情况，以及按照执行优先级从左往右越来越低的顺序排列的事件队列（<strong>图中最右边应该还有一个宏任务队列给 setImmediate</strong>）。事件队列中上面是队首</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343141.png" alt="image-20220124185450791"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343142.png" alt="image-20220124190239799"></p> <h2 id="面试题-5"><a href="#面试题-5" class="header-anchor">#</a> 面试题 5</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343143.png" alt="image-20220127145204631"></p> <p>输出是 1、3、4、2</p> <p>原因是，<strong>then 中的函数会立即执行，放入微任务队列的是<code>undefined</code></strong>（也就是<code>console.log()</code>的返回值)</p> <h1 id="_18、模块化"><a href="#_18、模块化" class="header-anchor">#</a> 18、模块化</h1> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343144.png" alt="image-20220124203140183"></p> <h2 id="最早期的模块化"><a href="#最早期的模块化" class="header-anchor">#</a> 最早期的模块化</h2> <p>​ 最早的模块化是利用<strong>函数的作用域</strong>来实现的。将业务代码放在立即执行函数中，将要暴露的函数或者变量保存到一个变量中返回。全局有了返回的这么一个对象，别的模块想使用这个模块中的变量或者函数时就可以从这个对象中引用。</p> <p>将本模块中的 name 和 age 导出</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343145.png" alt="image-20220124202113741"></p> <p>在其他模块中使用上面这个模块导出的变量</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343146.png" alt="image-20220124202207781"></p> <p>全局引入这两个 js 文件</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343147.png" alt="image-20220124202130486"></p> <p><strong>但是仍然有以下几个缺点</strong></p> <ul><li>全局是有变量指向每个模块导出的对象的，这时候就可能导致全局的变量<strong>命名冲突问题</strong></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343148.png" alt="image-20220124203214064"></p> <h2 id="commonjs-模块化"><a href="#commonjs-模块化" class="header-anchor">#</a> CommonJS 模块化</h2> <h3 id="模块化导出"><a href="#模块化导出" class="header-anchor">#</a> 模块化导出</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343149.png" alt="image-20220124204002963"></p> <h4 id="通过-exports-xxx-暴露-基本上不用"><a href="#通过-exports-xxx-暴露-基本上不用" class="header-anchor">#</a> 通过 exports.xxx 暴露（基本上不用）</h4> <ul><li>在 modules 文件夹下定义模块，并且用 exports.xxx 暴露 obj 对象，被暴露的内容最终都会作为 exports 的属性被封装在 exports 对象中</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343150.png" alt="image-20211210155913020"></p> <ul><li>在 commonjs01.js 文件中 require 这个自定义的模块并且输出，注意要使用完整包名（可以省略 js 后缀）
可以看到 jzsp 是一个对象，里面有我们暴露出来的 req 对象（这个属性名是暴露是的.xxx 来决定的），req 对象中有我们封装的 get 和 post 方法</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343151.png" alt="image-20211210160116203"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343152.png" alt="image-20211210160120679"></p> <ul><li>想调用内部的方法的话</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343153.png" alt="image-20211210160242741"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343154.png" alt="image-20211210160247923"></p> <ul><li>exports.xxx 可以在 exports 对象中封装很多内容</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343155.png" alt="image-20211210160541383"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343156.png" alt="image-20211210160547499"></p> <h4 id="通过-module-exports-暴露"><a href="#通过-module-exports-暴露" class="header-anchor">#</a> 通过 module.exports 暴露</h4> <p>修改暴露数据的代码</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343157.png" alt="image-20211210160620516"></p> <p>在 commonjs01 中 require 获取的内容直接就是这个暴露的 obj 对象了，外面没有套一层 exports</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343158.png" alt="image-20211210160731363"></p> <h4 id="exports-和-module-exports-的关系"><a href="#exports-和-module-exports-的关系" class="header-anchor">#</a> exports 和 module.exports 的关系</h4> <p><strong>这两种使用方式是等价的</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343159.png" alt="image-20220124210745300"></p> <p>exports 源码的实现是这样的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343160.png" alt="image-20220124212819543"></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token comment">//exports跟module.exports指向的是同一个对象</span>
<span class="token comment">//所以通过exports.xxx给这个对象赋值的话，因为module.exports指向的也是这个对象，那么module.exports也会发生变化</span>
<span class="token comment">//但是不能直接用exports = { obj }来导出，这样的话exports就不指向module.exports了，导出的仍然是空对象</span>
</code></pre></div><blockquote><p><strong>最终导出的一定是 module.exports 指向的对象，除非改变 exports 的指向，不然 exports 和 module.exports 指向的一定是同一个对象</strong></p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343161.png" alt="image-20220124212514059"></p> <h4 id="引入-node-modules-文件夹中的内容"><a href="#引入-node-modules-文件夹中的内容" class="header-anchor">#</a> 引入 node_modules 文件夹中的内容</h4> <p>引入 node_modules 文件夹中的内容不需要写完整路径和 index.js，只需要写包名，就会自动引入对应包下的 index.js 文件</p> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343162.png" alt="image-20211210162057906" style="zoom:67%;"> <p>注意，一定是对应的 index.js 文件，如果对应（例如 axios）包下没有 index 文件，就会报错</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343163.png" alt="image-20211210163042029"></p> <p>解决办法是，在对应的包的目录下，终端输入<code>npm init</code>初始化项目配置文件，里面的 main 就是入口文件</p> <p><strong>这是因为，如果对应包下有 package.json 文件的话，会优先根据 main 的值去查找对应的文件</strong></p> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343164.png" alt="image-20211210163255873"> <img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343165.png" alt="image-20211210163326562"> <h4 id="思考"><a href="#思考" class="header-anchor">#</a> 思考</h4> <p>exports，module.exports 和 require 返回的对象，三者都指向同一个对象（也就是暴露源暴露出来的对象）</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343166.png" alt="image-20220124213039832"></p> <h3 id="模块化导入"><a href="#模块化导入" class="header-anchor">#</a> 模块化导入</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343167.png" alt="image-20220125180736164"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343168.png" alt="image-20220125181107347"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343169.png" alt="image-20220125181450794"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343170.png" alt="image-20220125181525988"></p> <h3 id="模块的加载过程"><a href="#模块的加载过程" class="header-anchor">#</a> 模块的加载过程</h3> <ul><li>结论一：模块在第一次被引入，模块中的 js 代码会运行一次</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343171.png" alt="image-20220125182224642"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343172.png" alt="image-20220125182147864"></p> <ul><li>结论二：模块在被多次引入时，<strong>会缓存</strong>，最终只加载（运行）一次
<ul><li>为什么只会加载运行一次呢？</li> <li>这是因为每个模块对象 module 都有一个属性：loaded</li> <li>为 false 表示还没有加载，为 true 表示已经加载</li></ul></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343173.png" alt="image-20220125182543659"></p> <h3 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343174.png" alt="image-20220125183234134"></p> <h2 id="es-module"><a href="#es-module" class="header-anchor">#</a> ES module</h2> <h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <ul><li>在没有 webpack 的情况下，导入文件要输入后缀，否则会报错（webpack 在没后缀的时候会自动加后缀）</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343175.png" alt="image-20220125185952748"></p> <ul><li>import 和 export 必须在模块中才能使用，所以在 script 引入的时候需要加 type</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343176.png" alt="image-20220125190045204"></p> <p>否则会报错</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343177.png" alt="image-20220125190106177"></p> <ul><li>不能直接点击 html 文件打开，要开启 live-server 打开（vscode）</li></ul> <p>下面这个是直接打开 html 文件</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343178.png" alt="image-20220125190257641"></p> <p>下面这个是开启 live-server 打开 html</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343179.png" alt="image-20220125190337957"></p> <h3 id="导出方式"><a href="#导出方式" class="header-anchor">#</a> 导出方式</h3> <ul><li>export 声明语句</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//第一种导出方式</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'wjj'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>export { }</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'wjj'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">//这里不是说导出的是对象，对象中有name，aaa，Person</span>
<span class="token comment">//这个是export的语法，指明要导出的变量</span>
<span class="token comment">//一定注意这里不是对象！！！</span>
<span class="token comment">/*
    不要写成export {
        name:&quot;wjj&quot;
    }
*/</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">,</span>
  aaa<span class="token punctuation">,</span>
  <span class="token comment">//这种导出方式还可以起别名</span>
  <span class="token comment">//起别名之后，在导入的时候就只能用别名来使用导出的变量了</span>
  Person <span class="token keyword">as</span> Fperson<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>default 默认导出</li></ul> <p>默认导出通常导出这个文件中最重要的内容，并且<strong>默认导出只能有一个</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'wjj'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">,</span>
  aaa<span class="token punctuation">,</span>
  <span class="token comment">//默认导出的第一种方式</span>
  <span class="token comment">//Person as default</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//默认导出的第二种方式（常见）</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Person<span class="token punctuation">;</span>
</code></pre></div><h3 id="导入方式"><a href="#导入方式" class="header-anchor">#</a> 导入方式</h3> <ul><li>普通导入</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//这里的大括号也不是对象的意思，是import的语法，指明要从模块中引入的变量</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./index.js'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>普通导入+起别名</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//起别名防止与本模块中的变量发生命名冲突</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token keyword">as</span> otherName<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./index.js'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>将导出的所有东西放到一个标识符中</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//*表示所有，as起别名，那么导出的所有内容都会被封装到foo对象中</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> foo <span class="token keyword">from</span> <span class="token string">'./index.js'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>导入默认导出的内容</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343180.png" alt="image-20220126134943551"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//import后面跟的是默认导出的别名，也就是说可以通过xxx使用默认导出的内容</span>
<span class="token keyword">import</span> xxx <span class="token keyword">from</span> <span class="token string">'./index'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>导入 js 文件中的代码</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'./index'</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343181.png" alt="image-20220203223432244"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343182.png" alt="image-20220203223439108"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343183.png" alt="image-20220203223450412"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343184.png" alt="image-20220203223521550"></p> <h3 id="导入导出结合"><a href="#导入导出结合" class="header-anchor">#</a> 导入导出结合</h3> <p>在一个文件夹下（例如自定义的 utils）可能有很多的功能模块，如果都要使用的话需要一个一个<code>import</code>，此时我们可以新建一个<code>index.js</code>，在 index.js 中引入其他模块中导出的内容，再统一在 index.js 中导出。这样的话其他模块想使用 utils 中的所有功能模块的话就只需要导入一个 index.js 即可</p> <blockquote><p>index.js 相当于是所有模块的统一出口</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343185.png" alt="image-20220126133304488"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343186.png" alt="image-20220126133530218"></p> <p>也可以用下面这两种形式结合导入导出</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343187.png" alt="image-20220126133624630"></p> <p><strong>这种用的较多</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343188.png" alt="image-20220126133737693"></p> <h3 id="import-函数异步导入"><a href="#import-函数异步导入" class="header-anchor">#</a> import 函数异步导入</h3> <p>前面介绍的多种 import 方式都是会阻塞 js 线程的，属于<strong>同步</strong>导入，而现在介绍的<code>import()</code>函数属于异步导入，这个函数的<strong>返回值是一个<code>promise</code>。</strong></p> <p><code>import()</code>函数返回的 promise 的 value 中包括模块<strong>所有 export 导出的内容</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343189.png" alt="image-20220126140049889"></p> <h3 id="补充-import-对象的-meta-属性"><a href="#补充-import-对象的-meta-属性" class="header-anchor">#</a> 补充 import 对象的 meta 属性</h3> <p>这个 import 对象的 meta 属性中有有一个<code>url</code>属性，保存的是<strong>当前模块所在的路径</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343191.png" alt="image-20220126140739273"></p> <h3 id="es-module-解析过程"><a href="#es-module-解析过程" class="header-anchor">#</a> es module 解析过程</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343192.png" alt="image-20220126141905362"></p> <p>阶段一就是帮助我们下载 js 文件，然后转成对应的 module record</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343193.png" alt="image-20220126142214665"></p> <p>阶段二实例化分配内存空间的时候，仅仅解析代码中的 import 和 export 代码，也就是说，只是知道了 export 导出了 name 和 age 两个变量，所以在分配的内存空间（对象）中声明了两个变量，但是值为 undefined</p> <p>阶段三是运行代码，给模块的内存空间中的变量进行赋值。</p> <blockquote><p>导入的地方不能修改原来导出的内容的值（commonJS 是可以修改的）</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343194.png" alt="image-20220126142400519"></p> <h2 id="commonjs-和-es-module-相互引用"><a href="#commonjs-和-es-module-相互引用" class="header-anchor">#</a> commonJS 和 ES module 相互引用</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343195.png" alt="image-20220126142852000"></p> <p>首先创建<code>test</code>文件夹，并且创建<code>src</code>文件夹，在<code>cd</code>到<code>test</code>文件夹根目录下，执行<code>npm init --yes</code>生成<code>package.json</code>文件。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343196.png" alt="image-20220126143938016"></p> <p>执行 <code>npm install webpack webpack-cli</code>安装<code>webpack</code>和<code>webpack-cli</code>（从<code>webpack4.x</code>之后使用<code>webpack</code>需要安装<code>webpack-cli</code>)</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343197.png" alt="image-20220126143948027"></p> <p>在<code>src</code>文件夹下创建三个 js 文件，在<code>foo.js</code>中是<code>commonjs</code>导出。在<code>bar.js</code>中是<code>es module</code>导出</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343198.png" alt="image-20220126144414457"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343199.png" alt="image-20220126144626198"></p> <p>在 index.js 中分别用不同的方式导入</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343200.png" alt="image-20220126144647197"></p> <p>用<code>npx webpack</code>指令打包，打包的结果文件会放在 dist 文件夹下</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343201.png" alt="image-20220126144729048"></p> <p>在根目录下创建一个<code>index.html</code>，将打包后的<code>main.js</code>引入</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343202.png" alt="image-20220126144909552"></p> <h2 id="commonjs-和-esmodule-的区别"><a href="#commonjs-和-esmodule-的区别" class="header-anchor">#</a> commonjs 和 esModule 的区别</h2> <ul><li>esModule 导入只能放在顶部，因为 esmodule 会对模块进行<strong>静态分析</strong></li> <li>commonjs 可以动态导入，require 的地址可以是动态的，也可以在 if 判断中导入</li></ul> <h1 id="_19、包管理工具"><a href="#_19、包管理工具" class="header-anchor">#</a> 19、包管理工具</h1> <h2 id="npm"><a href="#npm" class="header-anchor">#</a> npm</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343203.png" alt="image-20220126145609339"></p> <h3 id="npm-install"><a href="#npm-install" class="header-anchor">#</a> npm install</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343204.png" alt="image-20220126155056676"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343205.png" alt="image-20220126155210190"></p> <h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <blockquote><p>解释：registry 仓库是所有 npm 包开发者最终上传的仓库</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343206.png" alt="image-20220126180042694"></p> <p>如果明确安装<code>axios@0.26.0</code>，但是<code>package-lock.json</code>中是<code>0.24.0</code>，那么会重新构建依赖关系（修改<code>package-lock.json</code>的<code>axios</code>版本号为<code>0.26.0</code>)，去下载<code>0.26.0</code>的包</p> <p>npm 是有缓存机制的，如果之前安装过某个包，会在本电脑中缓存对应的压缩包。可以通过<code>npm get cache获取缓存目录</code></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343207.png" alt="image-20220127125222551"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343208.png" alt="image-20220127125240872"></p> <p>在_cache 中的 index 文件下查找索引，然后去 content 中查找到对应的压缩包</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343209.png" alt="image-20220127125340332"></p> <p>索引是由<code>package-lock.json</code>中的<code>intergrity</code>解密之后得到的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343210.png" alt="image-20220127125417140"></p> <p><strong>npm 的缓存原理</strong></p> <h3 id="package-json"><a href="#package-json" class="header-anchor">#</a> package.json</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343211.png" alt="image-20220126150023574"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343212.png" alt="image-20220126150308444"></p> <h4 id="属性"><a href="#属性" class="header-anchor">#</a> 属性</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343213.png" alt="image-20220126150444374"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343214.png" alt="image-20220126150648214"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343215.png" alt="image-20220126150933061"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343216.png" alt="image-20220126150955479"></p> <p>在安装<code>axios</code>的时候，因为<code>axios</code>的<code>package.json</code>中的<code>dependencies</code>中有其他的依赖（也就是说，这个<code>axios</code>也是依赖其他库才能运作过的），那么在<code>npm install</code>安装<code>axios</code>的时候也会根据<code>axios</code>中的<code>package.json</code>中的<code>dependencies</code>去安装其他的包</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343217.png" alt="image-20220126151355186"></p> <p><code>element-plus</code>的<code>package.json</code>中的<code>peerDependencies</code>属性有<code>vue</code>，那么在安装<code>element-plus</code>的时候如果发现没有安装<code>vue</code>的话，会报警告</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343218.png" alt="image-20220126152210777"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343219.png" alt="image-20220126152122939"></p> <h3 id="package-lock-json"><a href="#package-lock-json" class="header-anchor">#</a> package-lock.json</h3> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343220.png" alt="image-20220126152358771"></p> <p>在<code>npm install</code>的时候，会判断<code>package-lock.json</code>的版本是否符合<code>package.json</code>中的版本</p> <p><code>package.json</code>文件只能锁定<strong>大版本，也就是版本号的第一位</strong>，并不能锁定后面的小版本，你每次<code>npm install</code>都是拉取的该大版本下的最新的版本，为了稳定性考虑我们几乎是不敢随意升级依赖包的，这将导致多出来很多工作量，测试/适配等，所以<code>package-lock.json</code>文件出来了，当你每次安装一个依赖的时候就<strong>锁定在你安装的这个版本</strong></p> <h4 id="属性-2"><a href="#属性-2" class="header-anchor">#</a> 属性</h4> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343221.png" alt="image-20220127125627840"></p> <h2 id="yarn"><a href="#yarn" class="header-anchor">#</a> yarn</h2> <blockquote><p><code>yarn init</code>生成<code>package.json</code>，使用之前要<code>npm install yarn -g</code></p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343222.png" alt="image-20220127130037912"></p> <h2 id="cnpm"><a href="#cnpm" class="header-anchor">#</a> cnpm</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343223.png" alt="image-20220127131544175"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343224.png" alt="image-20220127131638125"></p> <h2 id="npx"><a href="#npx" class="header-anchor">#</a> npx</h2> <p>npx 是在安装 node 的时候自动安装的，在 npm5.2 之后自带的</p> <blockquote><p>npx 常用的是用来调用项目中的某个模块的指令</p></blockquote> <p>例子：我们在项目中安装了webpack@3.6.0，在全局中安装了webpack@5.x。那么我们在项目的命令行中输入 webpack --version 的时候，查找的究竟是<strong>项目中 webpack 的版本号还是全局的 webpack 的版本号呢</strong>？答案是全局的</p> <p>当我们在命令行输入命令的时候，会在环境变量中找，如果包是全<strong>局安装的话会被配置到环境变量中的</strong>。</p> <p>那我们要怎么在当<strong>前项目的命令行中</strong>调用我们安装的<strong>项目中的模块的命令</strong>呢？</p> <ul><li>进入<code>node_modules</code>下的<code>bin</code>目录</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343225.png" alt="image-20220127133019650"></p> <ul><li>在<code>package.json</code>的<code>scripts</code>中编写命令，会优先在<code>node_modules</code>中去查找</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343226.png" alt="image-20220127133119314"></p> <ul><li>使用 npx，npx 会优先在<code>node_modules</code>中查找模块并且调用命令</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343227.png" alt="image-20220127133206307"></p> <h2 id="npm-发布自己的包"><a href="#npm-发布自己的包" class="header-anchor">#</a> npm 发布自己的包</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343228.png" alt="image-20220127133654485"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343229.png" alt="image-20220127133835740"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343230.png" alt="image-20220127133715584"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343231.png" alt="image-20220127133723529"></p> <p>增加新功能的话，需要修改 package.json 的 version 版本号重新发布</p> <h1 id="_20、json"><a href="#_20、json" class="header-anchor">#</a> 20、JSON</h1> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343232.png" alt="image-20220127134653635"></p> <h2 id="json-基本语法"><a href="#json-基本语法" class="header-anchor">#</a> JSON 基本语法</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343233.png" alt="image-20220127134847732"></p> <h2 id="json-序列化"><a href="#json-序列化" class="header-anchor">#</a> JSON 序列化</h2> <p>浏览器的<code>localStorage.setItem</code>第二个参数要求传入的是一个字符串，如果我们直接传入对象的话会有很大的问题</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343234.png" alt="image-20220127135226670"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343235.png" alt="image-20220127135221083"></p> <p>这时候我们就需要调用<code>JSON.stringify()</code>将对象转成 JSON 字符串存储。</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343236.png" alt="image-20220127135333683"></p> <p>我们也可以通过<code>JSON.parse()</code>将 JSON 字符串转成对象</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343237.png" alt="image-20220127135648893"></p> <h2 id="stringify-的细节"><a href="#stringify-的细节" class="header-anchor">#</a> stringify 的细节</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343238.png" alt="image-20220127140755424"></p> <p><strong>第二个参数 replacer</strong></p> <ul><li>传入数组，表示哪些对象的属性需要转换后保存</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343239.png" alt="image-20220127140814662"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343240.png" alt="image-20220127140828200"></p> <ul><li>传入回调函数</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343241.png" alt="image-20220127140932073"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343242.png" alt="image-20220127140921844"></p> <p><strong>第三个参数 space</strong></p> <ul><li>填入<strong>数字</strong>2，表示每个键值对前面加上 2 个空格 space</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343243.png" alt="image-20220127141030055"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343244.png" alt="image-20220127141035839"></p> <ul><li>填入其他字符串</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343245.png" alt="image-20220127141136196"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343246.png" alt="image-20220127141128389"></p> <p><strong>如果对象实现了<code>toJSON()</code>方法</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343247.png" alt="image-20220127141405219"></p> <p>那么在调用<code>JSON.stringify()</code>时会调用这个 toJSON 方法，将<strong>返回值作为结果</strong></p> <h2 id="parse-的细节"><a href="#parse-的细节" class="header-anchor">#</a> parse 的细节</h2> <p><strong>第二个参数是一个回调函数</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343248.png" alt="image-20220127141616091"></p> <h2 id="利用-json-序列化实现深拷贝"><a href="#利用-json-序列化实现深拷贝" class="header-anchor">#</a> 利用 JSON 序列化实现深拷贝</h2> <ul><li><strong>info</strong>直接赋值</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343249.png" alt="image-20220127142023953"></p> <ul><li><strong>info2</strong>用展开运算符实现浅拷贝</li></ul> <p>浅拷贝的话，所有的值只是做了个<strong>复制粘贴</strong>，包括<strong>引用类型的值</strong>，只是复制了地址。所以<strong>引用类型指向的是同一个对象</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343250.png" alt="image-20220127142130958"></p> <ul><li>stringify 和 parse 实现深拷贝</li></ul> <p>深拷贝的话，引用类型的对象会<strong>重新创建</strong>，内存中会重新分配存储空间给这个对象，而不是浅拷贝那种，直接复制地址。也就是说，深拷贝的结果的对象跟原来的对象是<strong>完全两个独立的对象</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343251.png" alt="image-20220127143118718"></p> <blockquote><p>但是<code>JSON.stringify</code>是<strong>不支持转化 function</strong>的，因为 JSON 中<strong>不支持函数类型的值</strong>。所以对象中有函数的话，用这种方法实现深拷贝是无能为力的</p></blockquote> <h1 id="_21、浏览器存储方案"><a href="#_21、浏览器存储方案" class="header-anchor">#</a> 21、浏览器存储方案</h1> <h2 id="storage"><a href="#storage" class="header-anchor">#</a> storage</h2> <p>如果存储了<code>sessionStorage</code>，然后通过 a 标签进行<strong>本页跳转</strong>，那么跳转之后这个<code>sessionStorage</code>还是会在的。如果是创建<strong>新的标签页跳转</strong>的话就获取不到<code>sessionStorage</code>了</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343252.png" alt="image-20220127145355126"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343253.png" alt="image-20220127151046936"></p> <h3 id="常见的属性和方法"><a href="#常见的属性和方法" class="header-anchor">#</a> 常见的属性和方法</h3> <ul><li><code>setItem(key,val)</code>设置 storage</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'wjj'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>key(number)</code>根据 index 获取 storage 中的 key</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>localStorage<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>getItem(key)</code>根据 key 获取 storage 中的 value 值</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>length 属性获取有多少个 storage</li></ul> <div class="language- extra-class"><pre class="language-text"><code>localStorage.length
</code></pre></div><ul><li>clear 清空</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="indexeddb"><a href="#indexeddb" class="header-anchor">#</a> IndexedDB</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343254.png" alt="image-20220127152310437"></p> <h1 id="_22、实现防抖-节流"><a href="#_22、实现防抖-节流" class="header-anchor">#</a> 22、实现防抖，节流</h1> <h2 id="防抖-debounce-函数"><a href="#防抖-debounce-函数" class="header-anchor">#</a> 防抖 debounce 函数</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343255.png" alt="image-20220129130758047"></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343256.png" alt="image-20220129130819975"></p> <h2 id="节流-throttle-函数"><a href="#节流-throttle-函数" class="header-anchor">#</a> 节流 throttle 函数</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343257.png" alt="image-20220129130954618"></p> <h2 id="防抖和节流的区别"><a href="#防抖和节流的区别" class="header-anchor">#</a> 防抖和节流的区别</h2> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343258.png" alt="image-20220129131242669"></p> <h2 id="第三方库实现"><a href="#第三方库实现" class="header-anchor">#</a> 第三方库实现</h2> <ul><li>lodash</li> <li>underscore</li></ul> <p>防抖</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343259.png" alt="image-20220129132137472"></p> <p>节流</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343260.png" alt="image-20220129132309835"></p> <h2 id="实现防抖函数"><a href="#实现防抖函数" class="header-anchor">#</a> 实现防抖函数</h2> <ul><li>基本实现和 this 参数指向</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//定义一个定时器，保存上一次的定时器</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token comment">//真正执行的函数，用args来接收参数</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//取消上一次的定时器</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//延迟执行</span>
    timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//返回的函数本质上在调用的时候会隐式绑定</span>
      <span class="token comment">//这里我们设置一下执行fn时的this指向</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>第三个参数：立即执行</li></ul> <p>立即执行就是，假设一开始就连续触发，按原来的思路，这一连续触发的事件都不会</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time<span class="token punctuation">,</span> immediate <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token comment">//是否调用过</span>
  <span class="token keyword">let</span> isInvoke <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果是需要立即执行，并且还没有立即执行时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isInvoke<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//标记已经立即执行过了，下面都进行防抖操作，也就是else</span>
      isInvoke <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//延迟执行</span>
      timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果成功执行完，说明这一次防抖已经结束了</span>
        <span class="token comment">//在下一次连续触发事件的时候，第一个触发的事件要立即执行</span>
        isInvoke <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>取消功能</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time<span class="token punctuation">,</span> immediate <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">let</span> isInvoke <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isInvoke<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isInvoke <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isInvoke <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//取消功能，在fn延迟执行的过程中如果调用了返回的函数对象的这个函数，会取消执行fn</span>
  foo<span class="token punctuation">.</span><span class="token function-variable function">cancel</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    isInvoke <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现节流函数"><a href="#实现节流函数" class="header-anchor">#</a> 实现节流函数</h2> <ul><li>基本实现</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//记录上一次的时间</span>
  <span class="token keyword">let</span> lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//记录触发的时候的时间</span>
    <span class="token keyword">const</span> nowTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断时间间隔是否大于time。</span>
    <span class="token comment">//这里默认是会立即执行第一次触发的函数的，因为nowTime是一个很大的值（时间戳）而lastTime是0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> nowTime <span class="token operator">-</span> lastTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//执行函数</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//保留这次触发的时间</span>
      lastTime <span class="token operator">=</span> nowTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>控制第一次是否直接执行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//leading为false表示不想开头立即触发</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">leading</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">trailing</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> leading<span class="token punctuation">,</span> trailing <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> timer<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nowTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果不希望第一个触发的是立即执行的话，就将lastTime初值（所以加了0这个判断条件）设置为nowTime</span>
    <span class="token comment">//这样的话时间间隔就会从0开始计算，直到时间间隔大于给定的time</span>
    <span class="token comment">//lastTime === 0 其实可以用于表示是不是一段连续触发事件的第一个事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTime <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> leading <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> lastTime <span class="token operator">=</span> nowTime<span class="token punctuation">;</span>
    <span class="token keyword">const</span> remainTime <span class="token operator">=</span> time <span class="token operator">-</span> <span class="token punctuation">(</span>nowTime <span class="token operator">-</span> lastTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lastTime <span class="token operator">=</span> nowTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>最后一次默认触发</li></ul> <p>这是关于，如果最后一次触发的时间点位于<strong>两个触发频率结点的中间</strong>时，要不要触发的问题</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343261.png" alt="image-20220129175040494"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">leading</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">trailing</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> leading<span class="token punctuation">,</span> trailing <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> timer<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nowTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTime <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> leading <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> lastTime <span class="token operator">=</span> nowTime<span class="token punctuation">;</span>
    <span class="token keyword">const</span> remainTime <span class="token operator">=</span> time <span class="token operator">-</span> <span class="token punctuation">(</span>nowTime <span class="token operator">-</span> lastTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//这里是周期末尾，如果在周期末尾重新调用触发而不是定时器触发</span>
      <span class="token comment">//那么我们只希望执行调用触发，而不是定时器触发</span>
      <span class="token comment">//所以如果有定时器的话，我们取消定时器（其实可以不加外面的判断，这里是必然有定时器的）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置null的话下一次进入新的周期才会在下面的if上继续添加定时器</span>
        timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//执行调用触发</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lastTime <span class="token operator">=</span> nowTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//剩余时间大于0，也就是周期开始时我们设置定时器，指定在周期末尾执行</span>
    <span class="token comment">//我们只希望设置一个定时器就可以了，因为都是重复希望执行fn函数。</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trailing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//执行完之后要重置参数，如果不希望第一次要执行的话，我们将lastTIme设置为0，也就是初值</span>
        <span class="token comment">//重新进入函数的时候，会在上面的判断中设置为nowTime，那么时间间隔就会从0开始计算</span>

        <span class="token comment">//如果我们希望第一次要执行的话，lastTIme就是现在的时间戳，这个时间戳就是周期末尾的时间戳。</span>
        <span class="token comment">//下一次进入函数的时候，会跟这个时间戳进行计算获取时间间隔。</span>
        <span class="token comment">//如果时间间隔小于time的话，是不会立即执行的</span>

        <span class="token comment">//第二个值的大小很关键，如果设置的很小，例如是1，那么会反复执行两次</span>
        lastTime <span class="token operator">=</span> <span class="token operator">!</span>leading <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> time<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> remainTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">&quot;jzsp&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">const</span> delay <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">leading</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">trailing</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> oldTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> nowTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTime <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>leading<span class="token punctuation">)</span> oldTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nowTime <span class="token operator">-</span> oldTime <span class="token operator">&gt;</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldTime <span class="token operator">=</span> nowTime<span class="token punctuation">;</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>trailing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;设置了定时器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            oldTime <span class="token operator">=</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>leading <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delay<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;jzsp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>

</code></pre></div><h1 id="_23、浅拷贝与深拷贝"><a href="#_23、浅拷贝与深拷贝" class="header-anchor">#</a> 23、浅拷贝与深拷贝</h1> <h2 id="实现浅拷贝"><a href="#实现浅拷贝" class="header-anchor">#</a> 实现浅拷贝</h2> <ul><li><code>Object.assign()</code></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343262.png" alt="image-20220129175418716"></p> <ul><li>...</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343263.png" alt="image-20220129175513359"></p> <h2 id="实现深拷贝"><a href="#实现深拷贝" class="header-anchor">#</a> 实现深拷贝</h2> <ul><li><code>JSON.stringify() &amp;&amp; JSON.parse()</code></li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343264.png" alt="image-20220129175636769"></p> <p>缺点</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343265.png" alt="image-20220129175812905"></p> <ul><li>递归实现深拷贝</li></ul> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343266.png" alt="image-20220129184903395"></p> <h3 id="深拷贝初步实现"><a href="#深拷贝初步实现" class="header-anchor">#</a> <strong>深拷贝初步实现</strong></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//判断是不是Object</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> valType <span class="token operator">=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">;</span>
  <span class="token comment">//null也是Object类型</span>
  <span class="token keyword">return</span> val <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> valType <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//首先判断，只有是对象才需要深拷贝，不是对象类型直接返回即可</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//是对象的话，创建一个新的对象用于拷贝</span>
  <span class="token keyword">const</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//遍历对象val的所有key，拷贝给newObj</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343267.png" alt="image-20220129220739254"></p> <h3 id="对数组类型进行处理"><a href="#对数组类型进行处理" class="header-anchor">#</a> <strong>对数组类型进行处理</strong></h3> <p>如果对象中有数组类型的话，用上面的<code>deepClone</code>函数会出问题</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343268.png" alt="image-20220129221304443"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> valType <span class="token operator">=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">;</span>
  <span class="token keyword">return</span> val <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> valType <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//数组也是对象，所以这里要判断</span>
  <span class="token keyword">const</span> newObj <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">friend</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">asd</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="对函数对象进行处理"><a href="#对函数对象进行处理" class="header-anchor">#</a> <strong>对函数对象进行处理</strong></h3> <p>可以看到，函数是对象类型，所以被创建新对象了，但是创建的是一个<strong>普通对象</strong></p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343270.png" alt="image-20220129223508287"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> valType <span class="token operator">=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">;</span>
  <span class="token keyword">return</span> val <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> valType <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果是函数就直接返回，函数是不需要重新创建的，函数就是为了实现复用功能的。</span>
  <span class="token comment">//也就是说，返回的函数跟拷贝源中的函数指向的是同一个函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> newObj <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">friend</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">asd</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="symbol-类型作为对象的-key-和作为-value-的处理"><a href="#symbol-类型作为对象的-key-和作为-value-的处理" class="header-anchor">#</a> <strong>Symbol 类型作为对象的 key 和作为 value 的处理</strong></h3> <p>问题 1：如果<code>Symbol</code>作为对象某个属性的<code>value</code>的话，那么返回的对象和原对象的这个属性的<code>Symbol</code><strong>是同一个</strong>，因为它的<code>isObject()</code>是<code>false</code></p> <p>问题 2：Symbol 作为对象的 key 的时候不会被拷贝，因为 key 为 Symbol 类型的话是不会被 for 遍历到的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343271.png" alt="image-20220129224506787"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'bbb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> valType <span class="token operator">=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">;</span>
  <span class="token keyword">return</span> val <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> valType <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断，如果是symbol类型的值</span>
  <span class="token comment">//那么要将val的description作为参数新建一个Symbol并且返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> newObj <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//对Symbol类型的key进行处理</span>
  <span class="token comment">//用Object.getOwnPropertySymbols()获取所有的key为Symbol的属性，返回值是数组</span>
  <span class="token keyword">const</span> symbolKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//数组是可迭代对象，可以用for of遍历所有的值</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sKey <span class="token keyword">of</span> symbolKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>sKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>sKey<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">friend</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">asd</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  s2<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>s2<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'jzsp'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>s2 <span class="token operator">===</span> obj<span class="token punctuation">.</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
</code></pre></div><h3 id="set-和-map"><a href="#set-和-map" class="header-anchor">#</a> <strong>Set 和 Map</strong></h3> <p>set 和 map 虽然被拷贝了，但是是当做了普通对象类型去拷贝的</p> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343272.png" alt="image-20220129225127515"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'bbb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> valType <span class="token operator">=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">;</span>
  <span class="token keyword">return</span> val <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> valType <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//用instanceof来判断类型</span>
  <span class="token comment">//因为set和map是可迭代对象，而Set和Map在创建的时候可以传入一个可迭代对象</span>
  <span class="token comment">//这里还有缺陷就是，set和map中保存的值是浅拷贝，进一步优化的话可以遍历set和map中的值来一一进行深拷贝判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">Set</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> newObj <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> symbolKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sKey <span class="token keyword">of</span> symbolKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>sKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>sKey<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">friend</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">asd</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  s2<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>s2<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'jzsp'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">s3</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">s4</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>s2 <span class="token operator">===</span> obj<span class="token punctuation">.</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
</code></pre></div><h3 id="循环引用"><a href="#循环引用" class="header-anchor">#</a> <strong>循环引用</strong></h3> <p>没处理循环引用之前会报错，递归循环调用了，导致栈溢出。</p> <blockquote><p>这里学到一个<strong>变量私有化</strong>的技巧，下面的 map 就是进行了私有化处理，只属于函数内部</p></blockquote> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343273.png" alt="image-20220130114541181"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'bbb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> valType <span class="token operator">=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">;</span>
  <span class="token keyword">return</span> val <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> valType <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//map放在全局的话，如果多个deepClone会出问题，所以我们放到局部中</span>
<span class="token comment">//第一次是默认的map，后面每次传入的都是第一次默认的map</span>
<span class="token comment">//const map = new Map()</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">Set</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//到这一步，说明是普通对象类型。所以我们判断，如果这个对象我们曾经拷贝过，那么就直接取出赋值</span>
  <span class="token comment">//这样就可以达到循环引用  obj.info = obj</span>
  <span class="token comment">//info的val是原来拷贝过的外层的obj，产生循环引用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> newObj <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//将每次要拷贝的对象和拷贝之后的对象作为键值对保存起来</span>
  map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> newObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//在deepClone方法中传入map</span>
    newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> symbolKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sKey <span class="token keyword">of</span> symbolKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>sKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>sKey<span class="token punctuation">]</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">friend</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'wjj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">asd</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  s2<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>s2<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'jzsp'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">s3</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">s4</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>c <span class="token operator">=</span> obj<span class="token punctuation">;</span> <span class="token comment">//循环引用</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>s2 <span class="token operator">===</span> obj<span class="token punctuation">.</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
</code></pre></div><h1 id="_24、urlsearchparams"><a href="#_24、urlsearchparams" class="header-anchor">#</a> 24、URLSearchParams</h1> <p><img src="https://ypyun-cdn.u1n1.com/img/picgo202204152343274.png" alt="image-20220403194739913"></p> <h2 id="排序算法"><a href="#排序算法" class="header-anchor">#</a> 排序算法</h2> <h3 id="冒泡排序"><a href="#冒泡排序" class="header-anchor">#</a> <strong>冒泡排序</strong></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bubble</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token comment">// 外层i控制比较的轮数</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 里层的循环控制控制每一轮比较的次数 j</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span>i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span>arr<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 当前项大于后一项</span>
        temp <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
        arr<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>

</code></pre></div><h3 id="插入排序"><a href="#插入排序" class="header-anchor">#</a> <strong>插入排序</strong></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 准备一个新数组，用来存储抓到手里的牌，开始先抓一张牌进来</span>
  <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  handle<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// 2. 从第二项开始抓拍 一直把台面上的牌抓光</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// A是新抓的牌</span>
    <span class="token keyword">let</span> <span class="token constant">A</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

    <span class="token comment">// 和 handle 手里的牌依次比较（从后向前）</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> handle<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每次要比较的手里的牌</span>
      <span class="token keyword">let</span> <span class="token constant">B</span> <span class="token operator">=</span> handle<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
      <span class="token comment">// 如果当前新牌A比要比较的牌B大，把A放到B的后面</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">A</span> <span class="token operator">&gt;</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handle<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 已经比到第一项，将新牌放到手中牌的最前</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>j<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handle<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> handle
<span class="token punctuation">}</span>

</code></pre></div><h3 id="快速排序"><a href="#快速排序" class="header-anchor">#</a> <strong>快速排序</strong></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">quick</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 4.递归结束 （相当于 arr 中小于第一项 则不用处理）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> arr
  <span class="token punctuation">}</span>

  <span class="token comment">// 1.找到数组的中间项， 在原有的数组中把它移除</span>
  <span class="token keyword">let</span> middleIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> middleValue <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>middleIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token comment">// 2.准备左右两个空数组，循环剩下数组中的每一项， 比当前项小的放到左数组中，比当前大的放到右数组中</span>
  <span class="token keyword">let</span> arrLeft <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      arrRight <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    item <span class="token operator">&lt;</span>middleValue <span class="token operator">?</span> arrLeft<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">:</span> arrRight<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3.递归方式让左右两边的数组持续处理 一直到左右两边都好为止，最后让 左边+中间+右边拼接成最后的结果</span>

  <span class="token keyword">return</span> <span class="token function">quick</span><span class="token punctuation">(</span>arrLeft<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>middleValue<span class="token punctuation">,</span> <span class="token function">quick</span><span class="token punctuation">(</span>arrRight<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.984fdec4.js" defer></script><script src="/assets/js/2.f6007b26.js" defer></script><script src="/assets/js/8.44873d68.js" defer></script>
  </body>
</html>
